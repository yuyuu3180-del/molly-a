<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Molly OS v15.4 - APIé›†æˆç‰ˆ</title>
    <style>
        :root { 
    --pink: #ff99aa; --morandi-pink: #d4a5ae; --glass: rgba(255,255,255,0.7);
    --soft-white: #fdfdfd; --text: #665a5c;
    /* WeChat Colors */
    --wc-main: #ededed; --wc-bg: #F8F9FA; --wc-accent: #FF85A2; 
    --wc-accent-blue: #5CD1E5; --wc-purple: #E6D4FF; 
    --wc-txt-main: #111; --wc-txt-sub: #777; --wc-green: #95ec69;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body { margin: 0; background: #222; display: flex; justify-content: center; align-items: flex-start; height: 100vh; overflow: hidden; padding-top: 15px; font-family: -apple-system, "PingFang SC", sans-serif; }

/* ğŸ“± æ‰‹æœºå¤–å£³ */
.iphone { width: 375px; height: 780px; background: #fffcfd; border-radius: 50px; position: relative; border: 8px solid #222; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.wall-global { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; z-index: 1; transition: 0.5s; background-color: #fdf2f5; }

/* ğŸ‡ çµåŠ¨å²› (å…”å­ç‰ˆ) */
.island-box { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 99999; pointer-events: none; width: 130px; height: 40px; }
.island { width: 130px; height: 32px; background: #000; border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; color: #fff; font-size: 11px; position: relative; z-index: 2; }
.ear { position: absolute; width: 10px; height: 12px; background: #000; border-radius: 4px; top: -6px; z-index: 1; transition: 0.3s; }
.ear.l { left: 22px; transform: rotate(-8deg); } .ear.r { left: 36px; transform: rotate(8deg); }
.tail-round { position: absolute; width: 12px; height: 12px; background: #000; border-radius: 50%; right: 0px; bottom: 8px; z-index: 0; }
.corgi-face { position: absolute; left: 20px; display: flex; align-items: center; gap: 8px; }
.eye { width: 3px; height: 3px; background: #fff; border-radius: 50%; }

/* ğŸ”’ é”å± (ä¿®å¤å¡é¡¿ä¸å½±å­) */
#lock-screen { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    z-index: 10000; 
    display: flex; flex-direction: column; align-items: center; padding-top: 60px; 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s; 
    background: rgba(255,255,255,0.01); 
    backdrop-filter: blur(0px);
    cursor: pointer;
}
.iphone.unlocked #lock-screen { transform: translateY(-100%); opacity: 0; pointer-events: none; }

.l-time { font-size: 85px; font-weight: 800; color: #fff; font-family: "Arial Rounded MT Bold"; text-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.l-glass { background: rgba(255,255,255,0.4); backdrop-filter: blur(15px); border-radius: 25px; border: 1.5px solid #fff; }
.hand { position: absolute; bottom: 50%; left: 50%; background: #fff; transform-origin: bottom; border-radius: 2px; }

/* ğŸ  æ¡Œé¢ */
#main-desktop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; }
.iphone.unlocked #main-desktop { display: block; }
.swiper-wrapper { display: flex; width: 200%; height: 100%; transition: transform 0.3s ease-out; }
.iphone.page-2 .swiper-wrapper { transform: translateX(-50%); }
.desktop-page { width: 50%; height: 100%; padding: 60px 20px 110px; display: flex; flex-direction: column; gap: 15px; }

.unified-grid-4 { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px !important; width: 100%; height: 100%; }
.std-icon { width: 54px; height: 54px; background: var(--soft-white); border-radius: 14px; background-size: cover; background-position: center; box-shadow: 0 4px 8px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #dcdcdc; cursor: pointer; }
.std-icon.has-img { font-size: 0; }
.p1-time { font-size: 80px; font-weight: 800; color: #fff; text-align: center; margin-top: 10px; margin-bottom: 5px; }
.dashed-diary { height: 130px; display: flex; flex-direction: column; justify-content: center; gap: 18px; padding: 10px 20px; }
.diary-line { border-bottom: 2px dashed rgba(255,255,255,0.8); color: var(--morandi-pink); font-size: 12px; padding-bottom: 4px; text-align: center; }
.music-av-simple { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #fff; background-size: cover; background-color: #eee; cursor: pointer; }
.glass-card-msg { padding: 15px; display: flex; flex-direction: column; background: #fff; justify-content: center; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.sharp-bubble { padding: 8px 12px; border-radius: 4px; font-size: 10px; margin-bottom: 8px; position: relative; max-width: 90%; }
.sb-l { background: #e1f5fe; color: #555; align-self: flex-start; border-radius: 12px 12px 12px 2px; }
.sb-r { background: #fce4ec; color: #555; align-self: flex-end; border-radius: 12px 12px 2px 12px; }
.cat-cam-3d { background: #fffbf8; border-radius: 24px; border: 2px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.08); padding: 10px; position: relative; height: 100%; display: flex; flex-direction: column; }
.cam-ear-3d { position: absolute; width: 20px; height: 12px; background: #fffbf8; border-radius: 10px 10px 0 0; top: -8px; z-index: 0; box-shadow: 0 -2px 2px rgba(0,0,0,0.02); }
.ce-3d-l { left: 15px; transform: rotate(-10deg); } .ce-3d-r { right: 15px; transform: rotate(10deg); }
.cam-screen-sq { flex: 1; background: #eee; border-radius: 12px; border: 2px solid #f0f0f0; background-size: cover; background-position: center; margin-bottom: 5px; cursor: pointer; }
.home-btn-area { height: 25px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
.iphone-home-btn { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd; background: #fff; }

.p2-header-clean { height: 160px; background: #fff; border-radius: 30px; overflow: hidden; position: relative; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.04); display: flex; flex-direction: column; }
.p2-bg-c { height: 80px; width: 100%; background: #f0f0f0; background-size: cover; cursor: pointer; }
.p2-av-c { width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; position: absolute; top: 80px; left: 50%; transform: translate(-50%, -50%); background: #ddd; background-size: cover; z-index: 5; cursor: pointer; }
.p2-text-c { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 45px; gap: 2px; }
.info-clean { font-size: 11px; color: #888; font-weight: 500; cursor: pointer; }
.short-frame { width: 100%; height: 100%; background: #fff; border-radius: 20px; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; color: #eee; font-size: 30px; cursor: pointer; }
.gb-shell-long { background: #e8e8e8; border-radius: 30px; padding: 12px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 2px solid #dcdcdc; height: 155px; justify-content: space-between; cursor: pointer; }
.gb-screen-long { background: #1a1a1a; padding: 5px; border-radius: 12px; width: 100%; height: 80px; display: flex; align-items: center; justify-content: center; color: var(--morandi-pink); font-family: monospace; font-size: 9px; text-align: center; }

.dock-container { position: absolute; bottom: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 200; display: none; }
.iphone.unlocked .dock-container { display: flex; }
.dock-bar { pointer-events: auto; width: 320px; height: 80px; background: rgba(255,255,255,0.92); backdrop-filter: blur(40px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1.5px solid #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
.page-dots { display: flex; gap: 8px; }
.dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; opacity: 0.4; transition: 0.3s; }
.iphone.page-1 .d1, .iphone.page-2 .d2 { opacity: 1; background: var(--morandi-pink); transform: scale(1.3); }
input[type="file"] { display: none; }

/* ============================
   ğŸ’š å¾®ä¿¡ APP (ä¿®å¤åˆ‡æ¢å’Œå±‚çº§)
   ============================ */
.wc-app, .app-container { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    background: var(--wc-bg); z-index: 5000; 
    display: none; flex-direction: column; 
    animation: slideUp 0.3s ease-out; font-family: -apple-system, sans-serif;
}
.wc-app.active, .app-container.active { display: flex; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.wc-header, .app-header { height: 90px; background: #ededed; display: flex; align-items: flex-end; padding-bottom: 12px; padding-left: 20px; padding-right: 20px; justify-content: space-between; box-shadow: 0 1px 0 rgba(0,0,0,0.1); z-index: 5001; }
.wc-h-left, .app-h-left { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--wc-txt-main); font-weight: 600; font-size: 17px; }
.wc-h-right, .app-h-right { cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--wc-txt-main); font-size: 22px; transition: 0.2s; }

/* åˆ—è¡¨å®¹å™¨ */
.wc-body, .app-body { flex: 1; overflow: hidden; background: var(--wc-bg); padding-top: 0; display:flex; flex-direction:column; position: relative; }

/* ä¸¤ä¸ªTabå†…å®¹ï¼Œç»å¯¹å®šä½é‡å ï¼Œé€šè¿‡ display åˆ‡æ¢ */
#wc-chat-list, #wc-contact-list {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto; padding-top: 0;
}
#wc-contact-list { display: none; } /* é»˜è®¤éšè—é€šè®¯å½• */

.wc-empty, .app-empty { text-align: center; color: var(--wc-txt-sub); font-size: 13px; margin-top: 60px; font-weight: 500; }

/* ğŸ“Œ ä¿®æ”¹ç½®é¡¶æ ·å¼ï¼šå·¦æ»‘æ˜¾ç¤ºä¸¤ä¸ªæŒ‰é’® - ä¼˜åŒ–ç‰ˆ */
.wc-list-item { 
    display: flex; height: 72px; align-items: center; padding: 0 15px; background: #fff; 
    cursor: pointer; transition: all 0.3s ease; border-bottom: 1px solid #f0f0f0; 
    position: relative; overflow: hidden;
    touch-action: pan-y;
}
.wc-list-item:active { background: #f5f5f5; }
.wc-list-item.pinned { background: #f9f9f9; }

.wc-avatar { width: 48px; height: 48px; border-radius: 6px; background: #eee; background-size: cover; flex-shrink: 0; }
.wc-info { margin-left: 12px; flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
.wc-name { font-size: 16px; color: #000; font-weight: 500; }
.wc-last-msg { font-size: 13px; color: #999; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.wc-time { font-size: 11px; color: #b2b2b2; margin-left: 10px; align-self: flex-start; margin-top: 15px; }

/* å·¦æ»‘æŒ‰é’®å®¹å™¨ */
.wc-swipe-actions {
    position: absolute;
    right: -160px;
    top: 0;
    height: 100%;
    display: flex;
    transition: right 0.3s ease;
}

/* å·¦æ»‘æŒ‰é’® */
.wc-swipe-btn {
    width: 80px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.wc-swipe-btn.pin {
    background: #07c160;
}

.wc-swipe-btn.unpin {
    background: #ff9500;
}

.wc-swipe-btn.delete {
    background: #ff3b30;
}

/* å·¦æ»‘æ—¶æ˜¾ç¤ºæŒ‰é’® */
.wc-list-item.swiping .wc-swipe-actions {
    right: 0;
}

/* é€šè®¯å½•åˆ—è¡¨é¡¹ */
.contact-group-title { padding: 8px 15px; font-size: 11px; color: #888; background: #f7f7f7; font-weight: normal; }
.contact-item { display: flex; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
.c-av-small { width: 38px; height: 38px; border-radius: 4px; background: #eee; background-size: cover; margin-right: 12px; }
.c-name-text { font-size: 16px; font-weight: 500; color: #333; }

/* åº•éƒ¨å¯¼èˆª - ç§»é™¤æœ‹å‹åœˆå’Œæˆ‘çš„ */
.wc-footer { height: 80px; background: #f7f7f7; display: flex; justify-content: space-around; padding-top: 8px; border-top: 1px solid #dcdcdc; z-index:5001; }
.wc-tab { display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; color: #111; transition: 0.1s; }
.wc-tab.active { color: #07c160; }
.wc-tab-icon { font-size: 24px; } .wc-tab-txt { font-size: 10px; font-weight: 500; }

/* æ¨¡æ€æ¡† */
.wc-popover { position: absolute; top: 60px; right: 10px; width: 140px; background: #4c4c4c; border-radius: 6px; z-index: 6000; display: none; flex-direction: column; padding: 5px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.wc-menu-item { color: #fff; padding: 12px 15px; font-size: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #5d5d5d; }

.wc-modal-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(50, 50, 50, 0.3); backdrop-filter: blur(3px); z-index: 7000; display: none; align-items: center; justify-content: center; }
.wc-modal { width: 300px; background: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; animation: popIn 0.2s ease-out; }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.wc-modal-head { background: #f9f9f9; padding: 15px; text-align: center; font-weight: 600; font-size: 16px; color: #000; border-bottom: 1px solid #eee; }
.wc-add-content { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }

/* ğŸŸ© æ–¹å½¢å¤´åƒ */
.wc-up-av { width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 30px; background-size: cover; border: 1px solid #ddd; }
.wc-up-av.has-img { border: 1px solid #eee; }
.wc-up-av::after { content:"+"; } .wc-up-av.has-img::after { content:""; }

.wc-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: #fff; outline:none; }
.wc-modal-btns { display: flex; border-top: 1px solid #eee; }
.wc-m-btn { flex: 1; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; font-weight: 500; }
.wc-btn-cancel { color: #000; border-right: 1px solid #eee; }
.wc-btn-confirm { color: #576b95; }

.wc-sel-list { max-height: 300px; overflow-y: auto; }
.wc-sel-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
.wc-sel-check { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; }
.wc-sel-item.selected .wc-sel-check { background: #07c160; border-color: #07c160; color: #fff; }
.wc-sel-item.selected .wc-sel-check::after { content: "âœ“"; font-size: 12px; font-weight: bold; }

/* ============================
   ğŸ’¬ èŠå¤©çª—å£ (å…¨å±)
   ============================ */
.wc-chat-window {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #ededed; z-index: 6000; display: none; flex-direction: column;
    animation: slideInR 0.25s ease-out;
}
@keyframes slideInR { from { transform: translateX(100%); } to { transform: translateX(0); } }

.c-header { height: 90px; background: #ededed; display: flex; align-items: flex-end; padding: 0 15px 12px; border-bottom: 1px solid #dcdcdc; justify-content: space-between; z-index: 10; }
.ch-l { display:flex; align-items:center; gap:5px; font-size:16px; color:#111; cursor:pointer; width:70px; font-weight:500; }
.ch-m { display:flex; flex-direction:column; align-items:center; flex:1; }
.ch-name { font-size:16px; font-weight:600; display:flex; align-items:center; gap:5px; color:#000; }
.ch-status { font-size:10px; color:#666; margin-top:1px; display:flex; align-items:center; gap:3px; }
.ch-r { display:flex; gap:15px; width:70px; justify-content:flex-end; align-items:center; }
.ch-icon-btn { font-size:18px; cursor:pointer; color:#111; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }

.c-body { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:15px; background:#ededed; background-size: cover; background-position: center; }
.bubble-row { display:flex; gap:10px; max-width:100%; align-items: flex-start; }
.bubble-row.me { flex-direction:row-reverse; }
.c-av { width:40px; height:40px; border-radius:4px; background:#ddd; background-size:cover; flex-shrink:0; }
.c-bubble { background:#fff; padding:10px 12px; border-radius:4px; font-size:15px; line-height:1.5; color:#000; position:relative; max-width:70%; word-wrap:break-word; border:1px solid #e5e5e5; }
.bubble-row.me .c-bubble { background: #95ec69; border-color:#86d65e; }
.c-bubble::before { content:""; position:absolute; top:12px; width:8px; height:8px; background:inherit; border:inherit; border-right:none; border-bottom:none; transform:rotate(45deg); }
.bubble-row:not(.me) .c-bubble::before { left:-5px; border-top:1px solid #e5e5e5; border-left:1px solid #e5e5e5; }
.bubble-row.me .c-bubble::before { right:-5px; border-top:1px solid #86d65e; border-right:1px solid #86d65e; border-left:none; background:#95ec69; }

.c-footer { min-height:55px; background:#f7f7f7; border-top:1px solid #dcdcdc; display:flex; align-items:center; padding:8px 10px; gap:8px; z-index:10; }
.cf-icon { font-size:28px; color:#111; cursor:pointer; width:34px; text-align:center; }
.cf-input { flex:1; height:38px; border:none; border-radius:4px; padding:0 10px; font-size:16px; outline:none; background:#fff; }
.cf-bone { width:34px; height:34px; background:#fff; border:1px solid #ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#333; font-size:16px; cursor:pointer; }
.cf-bone:active { background:#f0f0f0; }
.btn-send { display: none; background: #95ec69; color: #fff; font-size: 14px; padding: 6px 12px; border-radius: 4px; font-weight: 500; cursor: pointer; }

.c-panel { height:0; overflow:hidden; background:#f7f7f7; transition:height 0.2s; border-top:1px solid #eee; }
.c-panel.open { height:220px; overflow-y:auto; padding:20px; }
.grid-menu { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; }
.gm-item { display:flex; flex-direction:column; align-items:center; gap:6px; color:#666; font-size:12px; cursor:pointer; }
.gm-icon { width:55px; height:55px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:26px; border:1px solid #e5e5e5; }

/* æµ®çª— & è®¾ç½® (æœ€é«˜å±‚çº§) */
.foot-panel { position:absolute; top:90px; right:10px; width:220px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:8px; padding:15px; box-shadow:0 0 20px rgba(0,0,0,0.1); display:none; z-index:8000; flex-direction:column; gap:10px; animation:popIn 0.2s; }
.fp-row { display:flex; gap:8px; align-items:flex-start; font-size:13px; color:#333; line-height:1.4; }

.settings-page { position:absolute; top:0; left:0; width:100%; height:100%; background:#ededed; z-index:9000; display:none; flex-direction:column; animation:slideInR 0.25s; }
.s-header { height:90px; background:#ededed; display:flex; align-items:flex-end; padding:0 15px 12px; font-size:17px; font-weight:600; border-bottom:1px solid #dcdcdc; position:relative; }
.s-back { position:absolute; left:15px; bottom:12px; font-weight:400; color:#111; cursor:pointer; font-size:16px; display:flex; align-items:center; gap:5px; }
.s-body { flex:1; overflow-y:auto; padding-bottom:30px; }

.s-group { background:#fff; margin-top:10px; border-top:1px solid #e5e5e5; border-bottom:1px solid #e5e5e5; }
.s-row { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; border-bottom:1px solid #f0f0f0; font-size:16px; color:#000; min-height:50px; }
.s-row:last-child { border-bottom:none; }
.s-label { color:#000; flex:1; }
.s-val { color:#888; font-size:14px; display:flex; align-items:center; gap:5px; max-width:60%; text-align:right; }
.s-arrow::after { content:">"; color:#ccc; margin-left:8px; font-family:monospace; font-weight:bold; }

.s-slider { width:120px; accent-color:#07c160; }
.s-switch { width:50px; height:30px; background:#e5e5e5; border-radius:15px; position:relative; cursor:pointer; transition:0.3s; }
.s-switch.on { background:#07c160; }
.s-switch::after { content:""; position:absolute; width:26px; height:26px; background:#fff; border-radius:50%; top:2px; left:2px; transition:0.3s; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
.s-switch.on::after { left:22px; }
.s-input { border:none; text-align:right; outline:none; color:#555; width:100%; font-size:15px; background:transparent; }
.s-btn-red { color:#fa5151; text-align:center; width:100%; font-weight:500; cursor:pointer; }
.section-title { padding:15px 15px 5px; font-size:13px; color:#888; }
.s-textarea { width:100%; border:none; resize:none; font-size:15px; color:#333; outline:none; font-family:inherit; text-align:left; background:#f9f9f9; padding:5px; border-radius:4px; margin-top:5px; }

/* --- ğŸ¨ ä¿®å¤ç‰ˆï¼šçœŸÂ·æ°”æ³¡é¢„è§ˆä¸æ ·å¼ --- */
.s-label { white-space: nowrap; min-width: 60px; font-weight: 500; }
.s-textarea { background: #f5f5f5; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 8px; width: 100%; box-sizing: border-box; border:none; outline:none; font-family: inherit; }
.slider-val { font-size: 12px; color: #888; width: 30px; text-align: right; font-variant-numeric: tabular-nums; }

/* é¢„è§ˆæ¡†å®¹å™¨ï¼šæ¨¡æ‹ŸèŠå¤©èƒŒæ™¯ */
.bubble-preview-box {
    background: #ededed; /* å¾®ä¿¡é»˜è®¤ç°èƒŒæ™¯ */
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid #ddd;
    height: 140px; /* å›ºå®šé«˜åº¦ */
    overflow: hidden;
}

/* é€šç”¨é¢„è§ˆè¡Œ */
.pv-row { display: flex; align-items: flex-start; gap: 10px; }
.pv-row.me { flex-direction: row-reverse; }

/* é¢„è§ˆå¤´åƒ */
.pv-av { width: 36px; height: 36px; border-radius: 4px; background: #ddd; flex-shrink: 0; }

/* é¢„è§ˆæ°”æ³¡ */
.pv-bubble {
    padding: 10px 12px; border-radius: 4px; font-size: 15px; color: #000;
    max-width: 70%; position: relative; border: 1px solid #e5e5e5; background: #fff;
}
/* å¯¹æ–¹çš„æ°”æ³¡ (æˆ‘ä»¬è¦ä¿®æ”¹çš„ç›®æ ‡) */
.pv-bubble.them { background: #fff; } 
.pv-bubble.them::before {
    content: ""; position: absolute; top: 12px; left: -6px;
    width: 8px; height: 8px; background: inherit;
    border-bottom: 1px solid #e5e5e5; border-left: 1px solid #e5e5e5;
    transform: rotate(45deg);
}

/* è‡ªå·±çš„æ°”æ³¡ (å¯¹æ¯”ç”¨) */
.pv-bubble.me { background: #95ec69; border-color: #86d65e; }
.pv-bubble.me::before {
    content: ""; position: absolute; top: 12px; right: -6px;
    width: 8px; height: 8px; background: inherit;
    border-top: 1px solid #86d65e; border-right: 1px solid #86d65e;
    transform: rotate(45deg);
}

/* ç¡®è®¤æŒ‰é’® (å°å·§ç‰ˆ) */
.btn-confirm-mini {
    background: #07c160; color: #fff; font-size: 13px;
    padding: 6px 15px; border-radius: 4px; cursor: pointer;
    margin-left: auto; font-weight: 500;
}
.btn-confirm-mini:active { background: #06ad56; }

/* ============================
   âš™ï¸ è®¾ç½®åº”ç”¨æ–°å¢æ ·å¼
   ============================ */
.settings-app {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #ededed;
    z-index: 10000;
    display: none;
    flex-direction: column;
    animation: slideInR 0.25s ease-out;
}

.settings-app.active {
    display: flex;
}

.sa-header {
    height: 90px;
    background: #ededed;
    display: flex;
    align-items: flex-end;
    padding: 0 15px 12px;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid #dcdcdc;
    position: relative;
}

.sa-back {
    position: absolute;
    left: 15px;
    bottom: 12px;
    font-weight: 400;
    color: #111;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* å°ç‹—è„šå°è¿”å›æŒ‰é’® */
.sa-back.paw-back::before {
    content: "ğŸ¾";
    font-size: 16px;
    margin-right: 5px;
}

.sa-body {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 30px;
    background: #f5f5f5;
}

.sa-group {
    background: #fff;
    margin-top: 10px;
    border-top: 1px solid #e5e5e5;
    border-bottom: 1px solid #e5e5e5;
}

.sa-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 16px;
    color: #000;
    min-height: 50px;
}

.sa-row:last-child {
    border-bottom: none;
}

.sa-label {
    color: #000;
    flex: 1;
    font-weight: 500;
}

.sa-value {
    color: #888;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    max-width: 60%;
    text-align: right;
}

.sa-arrow::after {
    content: "â€º";
    color: #ccc;
    margin-left: 8px;
    font-family: monospace;
    font-weight: bold;
    font-size: 18px;
}

.sa-section-title {
    padding: 15px 15px 5px;
    font-size: 13px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
    background: #f5f5f5;
    margin-top: 10px;
}

.sa-switch {
    width: 50px;
    height: 30px;
    background: #e5e5e5;
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: 0.3s;
}

.sa-switch.on {
    background: #07c160;
}

.sa-switch::after {
    content: "";
    position: absolute;
    width: 26px;
    height: 26px;
    background: #fff;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.sa-switch.on::after {
    left: 22px;
}

.sa-input {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    width: 100%;
    outline: none;
    background: #fff;
    transition: border-color 0.2s;
}

.sa-input:focus {
    border-color: #07c160;
}

.sa-textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 6px;
    resize: none;
    font-size: 14px;
    padding: 10px;
    outline: none;
    font-family: inherit;
    background: #fff;
    min-height: 80px;
}

.sa-btn {
    background: #07c160;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.sa-btn:hover {
    background: #06ad56;
}

.api-config-block {
    background: #f8f9fa;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.api-config-title {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-selector {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    cursor: pointer;
    outline: none;
}

.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin: 10px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.selected {
    border-color: #333;
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #07c160;
}

.preview-area {
    background: #fafafa;
    border: 1px dashed #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.preview-img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #07c160;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ============================
   ğŸ® é€šç”¨åº”ç”¨å®¹å™¨æ ·å¼
   ============================ */
.app-empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 20px;
    text-align: center;
}

.app-empty-content .app-icon-large {
    font-size: 60px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.app-empty-content h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 18px;
}

.app-empty-content p {
    margin: 0;
    color: #666;
    font-size: 14px;
    max-width: 80%;
    line-height: 1.5;
}

/* åº”ç”¨å›¾æ ‡ç¼–è¾‘åŒºåŸŸ - æ”¹ä¸º3åˆ— */
.icon-edit-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    padding: 20px;
}

.icon-preview {
    width: 80px;
    height: 80px;
    border-radius: 18px;
    background-size: cover;
    background-position: center;
    background-color: #f0f0f0;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    color: #ccc;
}

.icon-preview.has-img {
    font-size: 0;
}

.icon-preview::after {
    content: "+";
}

.icon-preview.has-img::after {
    content: "";
}

.icon-edit-btn {
    background: #07c160;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 13px;
    cursor: pointer;
}

.icon-edit-btn:active {
    background: #06ad56;
}

/* ä¸Šä¼ æˆåŠŸæç¤º */
.upload-success {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    z-index: 100000;
    font-size: 14px;
    display: none;
    animation: fadeInOut 2s ease-in-out;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

/* å£çº¸é¢„è§ˆåŒºåŸŸ - ä¿®å¤ï¼šå¢åŠ é«˜åº¦æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ */
.wallpaper-preview-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}

.wallpaper-preview-title {
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
}

.wallpaper-preview-box {
    width: 100%;
    height: 200px; /* å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ */
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #ddd;
    background-size: cover;
    background-position: center;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* é”å±é¢„è§ˆåŒºåŸŸä¿®å¤ */
#l-pre {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #fff;
}

/* è§£å†³ç™½å±é—®é¢˜çš„ä¿®å¤ */
.settings-page, .wc-popover, .wc-modal-mask, .foot-panel {
    will-change: transform, opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* APIé…ç½®é¡µé¢è¿”å›æŒ‰é’® */
.api-config-back {
    position: absolute;
    left: 15px;
    bottom: 12px;
    font-weight: 400;
    color: #111;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.api-config-back::before {
    content: "ğŸ¾";
    font-size: 16px;
    margin-right: 5px;
}

.c-bubble {
    user-select: none;
    -webkit-user-select: none; /* å…³é”® */
}

/* è§£å†³è®¾ç½®é¡µé¢ç™½å±é—®é¢˜çš„å…³é”®CSS */
.settings-app * {
    -webkit-tap-highlight-color: rgba(0,0,0,0);
}

/* ä¼˜åŒ–æ»‘åŠ¨ä½“éªŒ */
.wc-list-item {
    touch-action: pan-y;
    -webkit-user-drag: none;
}

/* ä¿®å¤å¾®ä¿¡ç½®é¡¶æ ·å¼ */
.wc-list-item.pinned .wc-info .wc-name::before {
    content: "ğŸ“Œ ";
    font-size: 12px;
    color: #07c160;
}
   /* é•¿æŒ‰èœå•æ ·å¼ */
.msg-menu {
    position: absolute;
    background: #4c4c4c;
    border-radius: 8px;
    padding: 0 5px;
    display: none;
    flex-wrap: wrap;
    z-index: 999999999;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    color: #fff;
}
.msg-menu::after { /* å°ä¸‰è§’ */
    content: ""; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
    border-width: 6px 6px 0; border-style: solid; border-color: #4c4c4c transparent transparent;
}
.menu-item {
    padding: 10px 15px; font-size: 14px; cursor: pointer;
    border-right: 1px solid #5d5d5d; white-space: nowrap;
}
.menu-item:last-child { border-right: none; }
.menu-item:active { background: #5d5d5d; }
   /* --- è½¬è´¦åŠŸèƒ½æ ·å¼å¼€å§‹ --- */
.transfer-bubble {
    background: #fa9d3b; 
    padding: 12px; 
    border-radius: 4px; 
    width: 230px; 
    display: flex; 
    flex-direction: column; 
    position: relative;
    user-select: none;
}
.transfer-icon-circle {
    border: 1.5px solid #fff; 
    border-radius: 50%; 
    width: 36px; height: 36px; 
    display: flex; align-items: center; justify-content: center; 
    color: #fff; font-weight: bold; font-size: 18px;
}
.transfer-top {
    display: flex; align-items: center; gap: 10px; margin-bottom: 8px;
}
.transfer-bottom {
    border-top: 1px solid rgba(255,255,255,0.2); 
    padding-top: 5px; 
    color: #fff; font-size: 10px; opacity: 0.8;
}
/* --- è½¬è´¦åŠŸèƒ½æ ·å¼ç»“æŸ --- */
  /* ä¿®æ­£ç‰ˆä¸€èµ·å¬æ ·å¼ */
#music-widget {
    position: absolute; top: 95px; left: 2%; width: 96%; height: 130px;
    background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(15px);
    border-radius: 12px; z-index: 6005; display: none; color: #fff;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.mw-top-bar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; font-size: 10px; color: #aaa; background: rgba(255,255,255,0.03);
}
.mw-content { display: flex; align-items: center; padding: 10px 15px; position: relative; }
.mw-disc {
    width: 60px; height: 60px; border-radius: 50%; background: #000;
    display: flex; align-items: center; justify-content: center;
    animation: rotate 10s linear infinite; animation-play-state: paused;
}
.mw-disc.playing { animation-play-state: running; }
.mw-cover-img { width: 40px; height: 40px; border-radius: 50%; background-size: cover; }
.mw-text { flex: 1; margin-left: 12px; overflow: hidden; }
.mw-title { font-size: 14px; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mw-author { font-size: 11px; color: #777; }

/* æ§ä»¶å¸ƒå±€ */
.mw-controls-row {
    display: flex; align-items: center; margin-left: 10px; gap: 15px;
}
.mw-icon { font-size: 18px; color: #ccc; cursor: pointer; }
.mw-heart { color: #888; font-size: 18px; }
.mw-heart.liked { color: #d81e06; } /* çº¢è‰²çˆ±å¿ƒ */
.mw-mode { font-size: 16px; }

/* æœç´¢æ¡ (ç‚¹å‡»å³ä¸Šè§’æœç´¢å›¾æ ‡å¼¹å‡º) */
.mw-search-bar {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #222; z-index: 10; display: none; flex-direction: column;
}
.mw-s-header { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
.mw-s-input { flex: 1; background: #333; border: none; color: #fff; padding: 6px; border-radius: 4px; outline: none; }
        /* è®¾ç½®é¡µé¢æ ·å¼ä¿®å¤ */
        .settings-app {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f7; z-index: 9999; display: none; flex-direction: column;
        }
        .settings-app.active { display: flex !important; }
        .sa-header {
            height: 50px; background: #fff; display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid #ddd; position: relative;
        }
        .sa-title { font-weight: bold; font-size: 17px; color: #000; }
        .sa-close {
            position: absolute; right: 15px; width: 30px; height: 30px;
            background: #eee; border-radius: 50%; text-align: center; line-height: 28px;
            color: #888; font-size: 20px;
        }
        .sa-body { flex: 1; overflow-y: auto; width: 100%; }

        /* åˆ—è¡¨æ ·å¼ */
        .sa-group { margin-top: 20px; background: #fff; border-top: 1px solid #ddd; border-bottom: 1px solid #ddd; }
        .sa-row { display: flex; justify-content: space-between; padding: 12px 15px; align-items: center; border-bottom: 1px solid #f0f0f0; }
        .sa-label { font-size: 16px; }
        .sa-value { color: #888; font-size: 14px; }
        .sa-arrow::after { content: 'â€º'; margin-left: 10px; color: #ccc; font-size: 20px; }
        .sa-btn { display: block; width: 90%; margin: 20px auto; padding: 12px; background: #007aff; color: white; border-radius: 10px; text-align: center; border: none; }
        .sa-input { width: 100%; padding: 8px; background: #eee; border: none; border-radius: 6px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="iphone locked page-1" id="box">
        <div id="global-wall" class="wall-global"></div>

        <div class="island-box">
            <div class="ear l"></div><div class="ear r"></div>
            <div class="tail-round"></div>
            <div class="island"><div class="corgi-face"><div class="eye"></div><div class="eye"></div></div><span id="isl-bat">100%</span></div>
        </div>

        <div id="lock-screen" onclick="this.style.display='none'; document.getElementById('box').classList.add('unlocked');" ontouchend="this.style.display='none'; document.getElementById('box').classList.add('unlocked');">
            <div style="font-size:16px; color:#fff; font-weight:500; margin-top:10px" id="l-date">12æœˆ31æ—¥ æ˜ŸæœŸä¸‰</div>
            <div class="l-time" id="l-time">00:00</div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <div class="l-glass" style="width:125px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div style="font-size:9px; font-weight:bold; color:var(--morandi-pink)" id="lkp" onclick="event.stopPropagation();editT('lkp','u_lkp')">ğŸ¾ èŒ‰è‰çš„å°çˆªæœº</div>
                    <div style="width:75%; height:6px; background:rgba(0,0,0,0.1); border-radius:3px; margin-top:5px;"><div style="width:85%; height:100%; background:var(--morandi-pink); border-radius:3px;"></div></div>
                </div>
                <div class="l-glass" style="width:50px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;"><span style="font-size:14px; font-weight:800; color:#fff" id="mini-d">31</span><span style="font-size:8px; color:var(--morandi-pink)">å‘¨ä¸‰</span></div>
                <div class="l-glass" style="width:50px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;"><span style="font-size:14px; font-weight:800; color:#fff">22Â°</span><span style="font-size:8px; color:var(--morandi-pink)">èˆ’é€‚</span></div>
            </div>
            <div class="l-glass" style="width:290px; height:80px; margin-top:25px; padding:15px;">
                <div style="font-size:12px; color:var(--morandi-pink); margin-bottom:10px; font-weight:bold">2025å¹´ 12æœˆ</div>
                <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:10px; color:#fff; gap:5px"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>28</span><span>29</span><span>30</span><span style="background:var(--morandi-pink); border-radius:50%; width:16px; height:16px; line-height:16px; margin:0 auto">31</span><span>1</span><span>2</span><span>3</span></div>
            </div>
            <!-- é”å±å£çº¸é¢„è§ˆ - ä¿®å¤é«˜åº¦ -->
            <div class="l-glass" style="width:290px; height:200px; margin-top:15px; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer" onclick="event.stopPropagation();pick('f-lph')">
                <div id="l-pre" style="color:#fff; font-size:20px;">+</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1.5fr; gap:15px; width:290px; margin-top:15px;">
                <div class="l-glass" style="height:105px; position:relative;">
                    <div style="width:75px; height:75px; border-radius:50%; border:2px solid #fff; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%)">
                        <div class="hand" id="h-h" style="width:4px; height:22px; margin-left:-2px;"></div>
                        <div class="hand" id="h-m" style="width:3px; height:30px; margin-left:-1.5px;"></div>
                        <div class="hand" id="h-s" style="width:1.5px; height:32px; background:var(--morandi-pink); margin-left:-0.75px;"></div>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n1">ğŸ·ï¸ ä»Šæ—¥å¿ƒæƒ…ï¼šå¼€å¿ƒæ»¡æ»¡ âœ¨</div>
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n2">ğŸ·ï¸ å¾…åŠï¼šèŒ‰è‰å²›æ›´æ–° ğŸ’»</div>
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n3">ğŸ·ï¸ æƒ³å¿µï¼šæ¯æ—¶æ¯åˆ» â¤ï¸</div>
                </div>
            </div>
            <div style="margin-top:20px; color:#fff; font-size:12px; opacity:0.8;">å‘ä¸Šæ»‘åŠ¨è§£é”</div>
        </div>

        <div id="main-desktop">
            <div class="swiper-wrapper" id="sw">
                <div class="desktop-page">
                    <div class="p1-time" id="d-time">00:00</div>
                    <div style="display:grid; grid-template-columns:1.1fr 1fr; gap:12px; height:130px;">
                        <div class="l-glass dashed-diary">
                            <div class="diary-line" id="dl1" onclick="editT('dl1','u_dl1')">è®°å½•ä¸€åˆ»çš„å¿ƒåŠ¨...</div>
                            <div class="diary-line" id="dl2" onclick="editT('dl2','u_dl2')">ä»Šå¤©å¤©æ°”æ™´æœ—</div>
                            <div class="diary-line" id="dl3" onclick="editT('dl3','u_dl3')">è®°å¾—å–æ°´é¸­</div>
                        </div>
                        <!-- ç¬¬ä¸€é¡µå³ä¸Šè§’4ä¸ªåº”ç”¨ï¼šå¾®åšï¼Œçº¦ä¼šï¼Œç½‘æ˜“äº‘ï¼Œæ¸¸æˆ -->
                        <div class="unified-grid-4">
                            <div class="std-icon" id="i-weibo" onclick="openApp('weibo')" title="å¾®åš"></div>
                            <div class="std-icon" id="i-date" onclick="openApp('date')" title="çº¦ä¼š"></div>
                            <div class="std-icon" id="i-music" onclick="openApp('music')" title="ç½‘æ˜“äº‘"></div>
                            <div class="std-icon" id="i-game" onclick="openApp('game')" title="æ¸¸æˆ"></div>
                        </div>
                    </div>
                    <div style="height:80px; display:flex; align-items:center; justify-content:center; gap:25px; margin-top:10px">
                        <div class="music-av-simple" id="avL" onclick="pick('f-avL')"></div>
                        <div style="width:60px; text-align:center;"><svg style="width:100%;height:20px;"><polyline style="stroke:var(--morandi-pink); stroke-width:3; fill:none;" points="0,10 15,10 20,2 25,18 30,10 50,10"/></svg></div>
                        <div class="music-av-simple" id="avR" onclick="pick('f-avR')"></div>
                    </div>
                    <div style="display:flex; justify-content:space-around; width:100%; margin-top:-5px; margin-bottom:5px;">
                        <div id="mt1" onclick="editT('mt1','u_mt1')" style="color:var(--morandi-pink); font-size:9px; font-weight:bold; cursor:pointer">ç›¸è· 520 km</div>
                        <div id="mt2" onclick="editT('mt2','u_mt2')" style="color:var(--morandi-pink); font-size:9px; font-weight:bold; cursor:pointer">ä¸€èµ·å¬äº† 1314 h</div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; height:145px;">
                        <div class="glass-card-msg">
                            <div class="sharp-bubble sb-l" id="p1-msg1" onclick="editT('p1-msg1','u_msg1')">I miss u >ï¹<</div>
                            <div class="sharp-bubble sb-r" id="p1-msg2" onclick="editT('p1-msg2','u_msg2')">å—¯ã€‚çŸ¥é“äº†ã€‚</div>
                        </div>
                        <div class="cat-cam-3d">
                            <div class="cam-ear-3d ce-3d-l"></div>
                            <div class="cam-ear-3d ce-3d-r"></div>
                            <div class="cam-screen-sq" id="i-p-wall" onclick="pick('f-pwall')"></div>
                            <div class="home-btn-area"><div class="iphone-home-btn"></div></div>
                        </div>
                    </div>
                </div>
                <div class="desktop-page">
                    <div class="p2-header-clean">
                        <div class="p2-bg-c" id="p2bg" onclick="pick('f-p2bg')"></div>
                        <div class="p2-av-c" id="p2av" onclick="pick('f-p2av')"></div>
                        <div class="p2-text-c">
                            <div class="info-clean" id="p2bio" onclick="editT('p2bio','u_p2bio')">å…³äºèŒ‰è‰çš„ä¸€åˆ‡</div>
                            <div class="info-clean" id="p2loc" onclick="editT('p2loc','u_p2loc')">Molly Island</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:15px; height:125px; margin-top:10px">
                        <div class="short-frame" id="p2memo" onclick="pick('f-p2memo')">+</div>
                        <!-- ç¬¬äºŒé¡µå³ä¸Šè§’4ä¸ªåº”ç”¨ï¼šç§˜å¯†ï¼Œçºªå¿µæ—¥ï¼Œè§£å¿§æ‚è´§é“ºï¼Œæ·˜å®é—ªè´­ -->
                        <div class="unified-grid-4">
                            <div class="std-icon" id="i-secret" onclick="openApp('secret')" title="ç§˜å¯†"></div>
                            <div class="std-icon" id="i-memory" onclick="openApp('memory')" title="çºªå¿µæ—¥"></div>
                            <div class="std-icon" id="i-shop" onclick="openApp('shop')" title="è§£å¿§æ‚è´§é“º"></div>
                            <div class="std-icon" id="i-taobao" onclick="openApp('taobao')" title="æ·˜å®é—ªè´­"></div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:15px; flex:1">
                        <!-- å·¦ä¸‹è§’4ä¸ªåº”ç”¨ï¼šgogogoï¼ˆçº¿ä¸‹æ¨¡å¼ï¼‰ï¼Œé¢„è®¾ï¼ŒæŠ–éŸ³ï¼Œå°ç‹—æœˆå† -->
                        <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-content:flex-start;">
                            <div class="std-icon" id="i-gogogo" onclick="openApp('gogogo')" title="GoGoGo">ğŸ“</div>
                            <div class="std-icon" id="i-preset" onclick="openApp('preset')" title="é¢„è®¾">âš™ï¸</div>
                            <div class="std-icon" id="i-douyin" onclick="openApp('douyin')" title="æŠ–éŸ³">ğŸµ</div>
                            <div class="std-icon" id="i-calendar" onclick="openApp('calendar')" title="å°ç‹—æœˆå†">ğŸ“…</div>
                        </div>
                        <!-- å³ä¸‹è§’å•ç‹¬æ¸¸æˆæœºæ ·å¼çš„appï¼šæ¬²æœ›å›å»Š -->
                        <div class="gb-shell-long" onclick="openApp('desire')">
                            <div class="gb-screen-long"><div id="gs">â™¾ï¸<br>æ¬²æœ›å›å»Š</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ 4ä¸ªåº”ç”¨ï¼šå¾®ä¿¡ï¼Œæ¼‚æµç“¶ï¼Œä¸–ç•Œä¹¦ï¼Œè®¾ç½® -->
        <div class="dock-container" id="dock">
            <div class="page-dots"><div class="dot d1"></div><div class="dot d2"></div></div>
            <div class="dock-bar">
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dch" onclick="openApp('wechat')">ğŸ’¬</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dbo" onclick="openApp('bottle')">ğŸ¼</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dbk" onclick="openApp('worldbook')">ğŸ“š</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dst" onclick="openApp('settings')">âš™ï¸</div>
            </div>
        </div>

        <!-- âš™ï¸ è®¾ç½®åº”ç”¨ -->
        <div id="settings-app" class="settings-app">
            <div class="sa-header">
                <div class="sa-title" id="settings-title">ç³»ç»Ÿè®¾ç½®</div>
                <div class="sa-close" onclick="closeSettingsApp()">Ã—</div>
            </div>
            <div id="sa-body" class="sa-body"></div>
        </div>
                <!-- å†…å®¹é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ğŸ’¬ å¾®ä¿¡åº”ç”¨ -->
        <div class="wc-app" id="wc-app">
            <div class="wc-header">
                <div class="wc-h-left" onclick="closeApp('wechat')">
                    <span id="wc-back-arrow" style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span id="wc-h-txt">æ¶ˆæ¯</span>
                </div>
                <div class="wc-h-right" id="wc-plus-btn" onclick="window.wcToggleMenu()">+</div>
            </div>

            <div class="wc-popover" id="wc-menu">
                <div class="wc-menu-item" onclick="window.wcShowAdd()"><span>ğŸ‘¤</span> æ·»åŠ å¥½å‹</div>
                <div class="wc-menu-item" onclick="window.wcShowNewChat()"><span>ğŸ’¬</span> å‘èµ·ç¾¤èŠ</div>
            </div>

            <div class="wc-body">
                <div id="wc-chat-list"></div>
                <div id="wc-contact-list"></div>
            </div>

            <!-- ä¿®æ”¹åçš„å¾®ä¿¡åº•éƒ¨å¯¼èˆªæ ï¼Œåªä¿ç•™æ¶ˆæ¯å’Œé€šè®¯å½• -->
            <div class="wc-footer">
                <div class="wc-tab active" id="tab-chat" onclick="window.wcSwitchTab('chat')"><div class="wc-tab-icon">ğŸ’¬</div><div class="wc-tab-txt">æ¶ˆæ¯</div></div>
                <div class="wc-tab" id="tab-contact" onclick="window.wcSwitchTab('contact')"><div class="wc-tab-icon">ğŸ“’</div><div class="wc-tab-txt">é€šè®¯å½•</div></div>
                <!-- ç§»é™¤äº†æœ‹å‹åœˆå’Œæˆ‘çš„ä¸¤ä¸ªé€‰é¡¹ -->
            </div>

            <div class="wc-modal-mask" id="wc-modal-add">
                <div class="wc-modal">
                    <div class="wc-modal-head">æ·»åŠ å¥½å‹</div>
                    <div class="wc-add-content"><div class="wc-up-av" id="wc-new-av" onclick="pick('f-wc-av')"></div><input type="text" id="wc-new-name" class="wc-input" placeholder="âœ¨ è¾“å…¥å¥½å‹å¤‡æ³¨"></div>
                    <div class="wc-modal-btns"><div class="wc-m-btn wc-btn-cancel" onclick="window.wcHideAdd()">å–æ¶ˆ</div><div class="wc-m-btn wc-btn-confirm" onclick="window.wcConfirmAdd()">ç¡®è®¤æ·»åŠ </div></div>
                </div>
            </div>

<div id="music-widget">
    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="mw-top-bar">
        <div style="display:flex; align-items:center; gap:5px;">
             <!-- è¿™é‡Œå¯ä»¥æ”¾ä¸¤ä¸ªå°å¤´åƒ -->
             <div style="width:14px;height:14px;background:#ccc;border-radius:50%"></div>
             <div style="width:14px;height:14px;background:#666;border-radius:50%"></div>
             <span>ç›¸è· 1314 km</span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div onclick="toggleMwSearch()">ğŸ”</div> <!-- å³ä¸Šè§’æœç´¢ -->
            <div onclick="document.getElementById('music-widget').style.display='none'">âœ–</div>
        </div>
    </div>

    <div class="mw-content">
        <!-- å”±ç‰‡ -->
        <div class="mw-disc" id="mw-disc">
            <div class="mw-cover-img" id="mw-cover" style="background-image:url('https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg')"></div>
        </div>

        <!-- ä¿¡æ¯ -->
        <div class="mw-text">
            <div class="mw-title" id="mw-song">The Rose</div>
            <div class="mw-author" id="mw-singer">Westlife</div>
            <div style="font-size:9px;color:#555;margin-top:2px;">ä¸€èµ·å¬äº† 00:00</div>
        </div>

        <!-- æ§ä»¶åŒº -->
        <div class="mw-controls-row">
            <!-- å·¦ä¸‹è§’ä½ç½®ç›¸å¯¹çˆ¶çº§ï¼Œè¿™é‡Œæ”¾åœ¨ flex å³ä¾§ -->
            <div class="mw-heart" onclick="this.classList.toggle('liked')">â¤</div>
            <div class="mw-icon" onclick="alert('ä¸Šä¸€é¦–')">â®</div>
            <div class="mw-icon" style="font-size:28px;color:#fff;" id="mw-play-btn" onclick="toggleMwPlay()">â–¶</div>
            <div class="mw-icon" onclick="alert('ä¸‹ä¸€é¦–')">â­</div>
            <div class="mw-icon mw-mode" onclick="switchMwMode(this)">ğŸ”</div>
        </div>
    </div>

    <!-- æœç´¢å±‚ -->
    <div class="mw-search-bar" id="mw-search-overlay">
        <div class="mw-s-header">
            <input type="text" class="mw-s-input" placeholder="æœç´¢å…¨ç½‘éŸ³ä¹..." onchange="doMwSearch(this.value)">
            <div style="margin-left:10px; font-size:12px;" onclick="toggleMwSearch()">å–æ¶ˆ</div>
        </div>
        <div id="mw-search-list" style="overflow-y:auto; flex:1; padding:10px;"></div>
    </div>
</div>
<!-- è½¬è´¦ä¸“ç”¨å¼¹çª— -->
<div id="transfer-modal" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#ededed; z-index:7000; flex-direction:column;">
    <div style="height:50px; display:flex; align-items:center; padding:0 15px;">
        <div onclick="document.getElementById('transfer-modal').style.display='none'" style="font-size:24px; cursor:pointer;">Ã—</div>
        <div style="flex:1; text-align:center; font-weight:600; font-size:16px;">è½¬è´¦</div>
        <div style="width:24px;"></div>
    </div>

    <div style="background:#fff; margin:20px; padding:30px 20px; border-radius:10px; display:flex; flex-direction:column;">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:30px;">
            <div class="wc-avatar" id="t-target-av" style="width:40px;height:40px;"></div>
            <div style="font-size:16px; font-weight:500;" id="t-target-name">å¯¹æ–¹åå­—</div>
        </div>

        <div style="font-size:14px; color:#333; margin-bottom:10px;">è½¬è´¦é‡‘é¢</div>
        <div style="display:flex; align-items:flex-end; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
            <span style="font-size:30px; font-weight:bold; margin-right:10px;">Â¥</span>
            <input type="number" id="t-amount" style="border:none; font-size:40px; width:100%; outline:none;" placeholder="0.00">
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <span style="font-size:14px; color:#576b95;">æ·»åŠ è½¬è´¦è¯´æ˜</span>
            <input type="text" id="t-note" placeholder="æœ€å¤š10ä¸ªå­—" style="border:none; text-align:right; outline:none; font-size:14px; color:#999;">
        </div>

        <button onclick="window.doTransfer()" style="background:#07c160; color:#fff; border:none; padding:12px; border-radius:6px; font-size:16px; font-weight:600; cursor:pointer;">è½¬è´¦</button>
    </div>
</div>

            <div class="wc-modal-mask" id="wc-modal-chat">
                <div class="wc-modal">
                    <div class="wc-modal-head">é€‰æ‹©å¥½å‹</div>
                    <div class="wc-sel-list" id="wc-friend-select"></div>
                    <div class="wc-modal-btns"><div class="wc-m-btn wc-btn-cancel" onclick="document.getElementById('wc-modal-chat').style.display='none'">å–æ¶ˆ</div><div class="wc-m-btn wc-btn-confirm" onclick="window.wcConfirmChat()">å‘èµ·ç¾¤èŠ</div></div>
                </div>
            </div>

            <div id="wc-chat-window" class="wc-chat-window">

                 <div class="c-header">
                    <div class="ch-l" onclick="window.closeChat()"><span><</span><span>è¿”å›</span></div>
                    <div class="ch-m"><div class="ch-name" id="c-title">æ˜µç§°</div><div class="ch-status"><span style="color:#4caf50">â—</span> åœ¨çº¿</div></div>
                    <div class="ch-r"><div class="ch-icon-btn" onclick="window.toggleFootprint()">ğŸ¾</div><div class="ch-icon-btn" onclick="window.openSettings()">â€¢â€¢â€¢</div></div>
                </div>

                <div class="c-body" id="c-msg-list"></div>

                <div class="c-footer">
                    <div class="cf-icon" onclick="window.togglePanel('emoji')">â˜º</div>
                    <input type="text" class="cf-input" id="c-input" oninput="window.handleInput(this)" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <div class="cf-bone" id="btn-bone" onclick="window.triggerReply()">ğŸ¦´</div>
                    <div class="cf-icon" id="btn-plus" onclick="window.togglePanel('plus')">âŠ•</div>
                    <div class="btn-send" id="btn-send" onclick="window.sendMsg()">å‘é€</div>
                </div>

<div class="c-panel" id="p-plus">
    <div class="grid-menu">
        <!-- 1. ç…§ç‰‡ -->
        <div class="gm-item" onclick="document.getElementById('f-pf-av').click()">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ–¼ï¸</div>
            <div>å›¾ç‰‡</div>
        </div>
        <!-- 2. æ‹æ‘„ -->
        <div class="gm-item">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ“·</div>
            <div>æ‹æ‘„</div>
        </div>
        <!-- 3. è½¬è´¦ (ç»¿è‰²æŒ‰é’®) -->
        <div class="gm-item" onclick="window.openTransferModal()">
            <div class="gm-icon" style="background:#eca033;border:none;color:#fff;font-size:18px;font-weight:bold;">Â¥</div>
            <div>è½¬è´¦</div>
        </div>
        <!-- 4. ä¸€èµ·å¬ (çº¢è‰²æŒ‰é’®) -->
        <div class="gm-item" onclick="window.openMusicWidget()">
            <div class="gm-icon" style="background:#ff3a3a;border:none;color:#fff;font-size:12px;">â™«</div>
            <div>ä¸€èµ·å¬</div>
        </div>
        <!-- 5. ä½ç½® -->
        <div class="gm-item">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ“</div>
            <div>ä½ç½®</div>
        </div>
        <!-- 6. è¯­éŸ³ -->
        <div class="gm-item">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ“</div>
            <div>è¯­éŸ³é€šè¯</div>
        </div>
        <!-- 7. æ”¶è— -->
        <div class="gm-item">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ“¦</div>
            <div>æ”¶è—</div>
        </div>
        <!-- 8. æ–‡ä»¶ -->
        <div class="gm-item">
            <div class="gm-icon" style="background:#fff;border:1px solid #ddd;">ğŸ“</div>
            <div>æ–‡ä»¶</div>
        </div>
    </div>
</div>


                <div class="c-panel" id="p-emoji" style="text-align:center; color:#999; padding-top:20px;">(æš‚æ— è¡¨æƒ…)</div>
                <div class="foot-panel" id="p-foot"></div>

                <div class="settings-page" id="p-settings">
                    <div class="s-header">
                        <div class="s-back paw-back" onclick="document.getElementById('p-settings').style.display='none'">è¿”å›</div>
                        <div style="flex:1; text-align:center">èŠå¤©ä¿¡æ¯</div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="s-body">
                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="window.sSearch()"><div class="s-label">æŸ¥æ‰¾èŠå¤©è®°å½•</div></div>
                            <div class="s-row s-arrow" onclick="window.sLinkGroup()"><div class="s-label">å…³è”ç¾¤èŠ</div></div>
                        </div>

                        <div class="section-title">å…³äº AI è®°å¿†</div>
                        <div class="s-group">
                            <div class="s-row">
                                <div class="s-label">è®°å¿†æ¡æ•°</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="200" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">200</span>
                                </div>
                            </div>
                            <div class="s-row">
                                <div class="s-label">å…³è”è®°å¿†</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="50" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">50</span>
                                </div>
                            </div>
                            <div class="s-row">
                                <div class="s-label">è‡ªåŠ¨æ€»ç»“</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="100" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">100</span>
                                </div>
                            </div>

                            <div class="s-row">
                                <div class="s-label">å…¬ä¼—äººç‰©</div>
                                <input type="text" class="s-input" placeholder="è¾“å…¥åç§°" style="text-align:right">
                            </div>

                            <div class="s-row" style="flex-direction:column; align-items:flex-start; height:auto; padding-bottom:15px;">
                                <div class="s-label" style="margin-bottom:5px">æè¿°</div>
                                <textarea class="s-textarea" rows="6" placeholder="è¯·è¾“å…¥æè¿°..."></textarea>
                            </div>
                        </div>

                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="window.sBindWorld()"><div class="s-label">ä¸–ç•Œä¹¦ç»‘å®š</div><div class="s-val">æ— </div></div>
                            <div class="s-row s-arrow" onclick="window.sBindPreset()"><div class="s-label">é¢„è®¾ç»‘å®š</div><div class="s-val">é»˜è®¤</div></div>
                        </div>

                        <div class="s-group">
                            <div class="s-row"><div class="s-label">æ‹ä¸€æ‹</div><div class="s-switch" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row"><div class="s-label">åç¼€</div><input type="text" class="s-input" value="æ‹äº†æ‹ä»–çš„è„‘è¢‹" style="text-align:right"></div>
                            <div class="s-row"><div class="s-label">éŸ³è‰² ID</div><input type="text" class="s-input" placeholder="è¾“å…¥ID" style="text-align:right"></div>
                        </div>

                        <div class="section-title">å¤–è§‚</div>
                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="pick('f-chat-bg')"><div class="s-label">èŠå¤©å£çº¸</div></div>

                            <div class="s-row" style="flex-direction:column; align-items:stretch; height:auto; padding-bottom:15px;">
                                <div class="s-label" style="margin-bottom:8px">æ°”æ³¡CSS</div>
                                <div class="bubble-preview-box">
                                    <div class="pv-row">
                                        <div class="pv-av"></div>
                                        <div class="pv-bubble them" id="demo-bubble-them">å¯¹æ–¹çš„æ¶ˆæ¯æ°”æ³¡</div>
                                    </div>
                                    <div class="pv-row me">
                                        <div class="pv-av" style="background:#95ec69"></div>
                                        <div class="pv-bubble me">æˆ‘çš„æ¶ˆæ¯æ°”æ³¡</div>
                                    </div>
                                </div>
                                <textarea id="css-input-area" class="s-textarea" rows="4" placeholder="ä¾‹å¦‚ï¼šbackground: #ffe4e1; color: #d63384; border-radius: 12px;"></textarea>
                                <div style="display:flex; margin-top:8px;">
                                    <div class="btn-confirm-mini" onclick="window.updateCssPreview()">ç¡®è®¤</div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title">AI ä¸»åŠ¨å‘é€</div>
                        <div class="s-group">
                            <div class="s-row"><div class="s-label">å›ºå®šæ—¶é—´å‘é€</div><div class="s-switch" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row"><div class="s-label">æ€è€ƒæ˜¯å¦å‘é€</div><div class="s-switch on" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row">
                                <div class="s-label">é—´éš” (åˆ†)</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="60" value="30" oninput="this.nextElementSibling.innerText=this.value">
                                    <span class="slider-val">30</span>
                                </div>
                            </div>
                        </div>

                        <div class="s-group">
                            <div class="s-row" onclick="window.sExport()"><div class="s-label">å¯¼å‡ºèŠå¤©è®°å½•</div><div class="s-arrow"></div></div>
                            <div class="s-row"><div class="s-label s-btn-red" onclick="window.sClear()">æ¸…ç©ºèŠå¤©è®°å½•</div></div>
                            <div class="s-row"><div class="s-label s-btn-red" onclick="window.sDelete()">åˆ é™¤è¯¥èŠå¤©</div></div>
                            <div class="s-row"><div class="s-label s-btn-red" style="color:darkred" onclick="window.sBlock()">âš ï¸ æ‹‰é»‘è¯¥èŠå¤©</div></div>
                        </div>
                    </div>
                </div>
            </div> 
            <div class="settings-page" id="p-profile">
                <div class="s-header">
                    <div class="s-back paw-back" onclick="document.getElementById('p-profile').style.display='none'">è¿”å›</div>
                    <div style="flex:1; text-align:center">å¥½å‹èµ„æ–™</div>
                    <div style="width:40px"></div>
                </div>
                <div class="s-body">
                    <div class="s-group" style="padding:20px; display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <div class="wc-up-av" id="pf-av" onclick="pick('f-pf-av')"></div>
                        <div style="color:#999; font-size:12px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label">ç½‘å</div>
                            <input type="text" class="s-input" id="pf-name" style="text-align:right">
                        </div>
                        <div class="s-row">
                            <div class="s-label">å¤‡æ³¨</div>
                            <input type="text" class="s-input" id="pf-alias" placeholder="è®¾ç½®å¤‡æ³¨" style="text-align:right">
                        </div>
                    </div>

                    <div class="section-title">äººç‰©è®¾å®š</div>
                    <div class="s-group">
                        <div class="s-row" style="flex-direction:column; align-items:flex-start; height:auto; padding-bottom:15px;">
                            <div class="s-label" style="margin-bottom:5px">æè¿°</div>
                            <textarea class="s-textarea" id="pf-desc" rows="6" placeholder="å¹´é¾„ã€æ€§æ ¼ã€é•¿ç›¸ã€å…³ç³»..."></textarea>
                        </div>
                        <div class="s-row">
                            <div class="s-label">ä¸ªæ€§ç­¾å</div>
                            <input type="text" class="s-input" id="pf-sign" style="text-align:right">
                        </div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label">è®¾ä¸ºæ˜Ÿæ ‡å¥½å‹</div>
                            <div class="s-switch" id="pf-star" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label s-btn-red" style="color:#576b95; font-weight:600;" onclick="window.saveProfile()">ä¿å­˜å¹¶æ›´æ–°</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ğŸ¼ æ¼‚æµç“¶åº”ç”¨ -->
        <div class="app-container" id="bottle-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('bottle')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span>æ¼‚æµç“¶</span>
                </div>
                <div class="app-h-right" onclick="alert('æ¼‚æµç“¶åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large">ğŸ¼</div>
                    <h3>æ¼‚æµç“¶</h3>
                    <p>æ‰”ä¸€ä¸ªæ¼‚æµç“¶ï¼Œæˆ–è€…æä¸€ä¸ªçœ‹çœ‹<br>åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ğŸ“š ä¸–ç•Œä¹¦åº”ç”¨ -->
        <div class="app-container" id="worldbook-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('worldbook')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span>ä¸–ç•Œä¹¦</span>
                </div>
                <div class="app-h-right" onclick="alert('ä¸–ç•Œä¹¦åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large">ğŸ“š</div>
                    <h3>ä¸–ç•Œä¹¦</h3>
                    <p>è®°å½•ä¸–ç•Œçš„æ•…äº‹<br>åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ğŸ® å…¶ä»–åº”ç”¨å®¹å™¨ï¼ˆé€šç”¨ï¼‰ -->
        <div class="app-container" id="generic-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('generic')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span id="generic-app-title">åº”ç”¨</span>
                </div>
                <div class="app-h-right" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large" id="generic-app-icon">ğŸ“±</div>
                    <h3 id="generic-app-name">åº”ç”¨</h3>
                    <p id="generic-app-desc">åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ä¸Šä¼ æˆåŠŸæç¤º -->
        <div id="upload-success" class="upload-success" style="display:none;">âœ… ä¸Šä¼ æˆåŠŸï¼</div>

        <!-- æ–‡ä»¶ä¸Šä¼ è¾“å…¥æ¡†ï¼ˆéšè—ï¼‰ -->
        <div style="display:none">
            <!-- å£çº¸ä¸Šä¼  -->
            <input type="file" id="f-wall" onchange="h('wall')">
            <input type="file" id="f-lph" onchange="h('lph')">
            <input type="file" id="f-desktop1" onchange="h('desktop1')">
            <input type="file" id="f-desktop2" onchange="h('desktop2')">

            <input type="file" id="f-avL" onchange="h('avL')">
            <input type="file" id="f-avR" onchange="h('avR')">
            <input type="file" id="f-pwall" onchange="h('pwall')">
            <input type="file" id="f-p2bg" onchange="h('p2bg')">
            <input type="file" id="f-p2av" onchange="h('p2av')">
            <input type="file" id="f-p2memo" onchange="h('p2memo')">

            <!-- åº”ç”¨å›¾æ ‡ä¸Šä¼  -->
            <input type="file" id="f-icon-weibo" onchange="hIcon('weibo')">
            <input type="file" id="f-icon-date" onchange="hIcon('date')">
            <input type="file" id="f-icon-music" onchange="hIcon('music')">
            <input type="file" id="f-icon-game" onchange="hIcon('game')">
            <input type="file" id="f-icon-secret" onchange="hIcon('secret')">
            <input type="file" id="f-icon-memory" onchange="hIcon('memory')">
            <input type="file" id="f-icon-shop" onchange="hIcon('shop')">
            <input type="file" id="f-icon-taobao" onchange="hIcon('taobao')">
            <input type="file" id="f-icon-gogogo" onchange="hIcon('gogogo')">
            <input type="file" id="f-icon-preset" onchange="hIcon('preset')">
            <input type="file" id="f-icon-douyin" onchange="hIcon('douyin')">
            <input type="file" id="f-icon-calendar" onchange="hIcon('calendar')">
            <input type="file" id="f-icon-desire" onchange="hIcon('desire')">
            <input type="file" id="f-icon-wechat" onchange="hIcon('wechat')">
            <input type="file" id="f-icon-bottle" onchange="hIcon('bottle')">
            <input type="file" id="f-icon-worldbook" onchange="hIcon('worldbook')">
            <input type="file" id="f-icon-settings" onchange="hIcon('settings')">

            <!-- å¾®ä¿¡ç›¸å…³ä¸Šä¼  -->
            <input type="file" id="f-wc-av" onchange="window.wcHandleAv(this)">
            <input type="file" id="f-pf-av" onchange="window.wcHandleProfileAv(this)">
            <input type="file" id="f-chat-bg" onchange="window.sHandleBg(this)">
        </div>
    </div>
   <!-- é•¿æŒ‰èœå•ç»“æ„ -->
<div id="msg-context-menu" class="msg-menu">
    <div class="menu-item" onclick="menuAction('copy')">å¤åˆ¶</div>
    <div class="menu-item" onclick="menuAction('recall')">æ’¤å›</div>
    <div class="menu-item" onclick="menuAction('quote')">å¼•ç”¨</div>
    <div class="menu-item" onclick="menuAction('delete')">åˆ é™¤</div>
    <div class="menu-item" onclick="menuAction('multi')">å¤šé€‰</div>
</div>

    <script>
        /* ==========================================
           1. é”å±æ»‘åŠ¨é€»è¾‘ (å®‰å…¨ä¿®å¤ç‰ˆ)
           ä¿®å¤ç‚¹ï¼š
           - ä¿®æ­£ touch äº‹ä»¶åæ ‡è·å– (e.touches[0])
           - ä¿®æ­£ classList æ“ä½œè¯­æ³•
           - ç¡®ä¿ DOM å…ƒç´ å­˜åœ¨æ ¡éªŒ
           ========================================== */
        (function () {
          const ls = document.getElementById('lock-screen');
          const box = document.getElementById('box');

          // å…³é”®ï¼šä¸å­˜åœ¨å°±ä¸æ‰§è¡Œï¼Œé˜²æ­¢æŠ¥é”™å¡æ­»åç»­ä»£ç 
          if (!ls || !box) return;

          let startY = 0;

          ls.addEventListener('touchstart', e => {
            // ç¡®ä¿æœ‰è§¦æ‘¸ç‚¹
            if (e.touches.length > 0) {
              startY = e.touches[0].clientY;
            }
          }, { passive: true });

          ls.addEventListener('touchend', e => {
            // ç¡®ä¿æœ‰å˜åŒ–ç‚¹
            if (e.changedTouches.length > 0) {
              const endY = e.changedTouches[0].clientY;
              const dist = startY - endY;

              // åªå…è®¸â€œæ˜ç¡®ä¸Šæ»‘â€(è·ç¦»å¤§äº50px)
              if (dist > 50) {
                box.classList.add('unlocked');
                // åŠ¨ç”»ç»“æŸåéšè—DOMï¼Œæå‡æ€§èƒ½
                setTimeout(() => {
                  ls.style.display = 'none';
                }, 400);
              }
            }
          });
        })();

        /* ==========================================
           2. åŸºç¡€å·¥å…· (å…¨é¢åŠ å›ºç¨³å®šç‰ˆ)
           ä¿®å¤ç‚¹ï¼š
           - ä¿®æ­£ document.getElementById è¯­æ³•é”™è¯¯
           - ä¿®æ­£ window.event è¯­æ³•é”™è¯¯
           - ä¿®æ­£ FileReader è°ƒç”¨é€»è¾‘
           ========================================== */

        // è§¦å‘éšè—çš„ input[type=file]
        window.pick = function (id) {
          const el = document.getElementById(id);
          if (!el) return;

          // é˜²æ­¢ç‚¹å‡»ç©¿é€
          if (window.event) window.event.stopPropagation();

          el.click();
        };

        // ä¿®æ”¹æ–‡å­—å¹¶ä¿å­˜åˆ° localStorage
        window.editT = function (id, k) {
          const el = document.getElementById(id);
          if (!el) return;

          if (window.event) window.event.stopPropagation();

          const n = prompt("ä¿®æ”¹æ–‡å­—ï¼š", el.innerText);

          if (n !== null) {
            el.innerText = n;
            if (k) {
              localStorage.setItem(k, n);
            }
          }
        };

        // ä¸Šä¼ å£çº¸/å›¾ç‰‡é€šç”¨å‡½æ•°
        window.h = function (k) {
          const input = document.getElementById('f-' + k);
          if (!input || !input.files || !input.files[0]) return;

          const file = input.files[0];
          const r = new FileReader();

          r.onload = (e) => {
            const dataUrl = e.target.result;
            localStorage.setItem('u_' + k, dataUrl);

            // ä¸Šä¼ æˆåŠŸæç¤º (å­˜åœ¨æ‰è°ƒç”¨)
            if (typeof showUploadSuccess === 'function') {
              showUploadSuccess();
            }

            // ç«‹å³æ›´æ–°é¢„è§ˆ (å­˜åœ¨æ‰è°ƒç”¨ï¼Œè¿™é‡Œå¯¹åº”åç»­ Section 3 çš„åŠŸèƒ½)
            if (typeof updateWallpaperPreview === 'function') {
              updateWallpaperPreview(k, dataUrl);
            }

            // å…¼å®¹æ—§é€»è¾‘ï¼šå¦‚æœæ˜¯å…¨å±€å£çº¸ï¼Œå°è¯•ç›´æ¥æ›´æ–° DOMï¼Œé˜²æ­¢ updateWallpaperPreview æœªåŠ è½½æ—¶æ— ååº”
            if (k === 'wall') {
                const gw = document.getElementById('global-wall');
                const lp = document.getElementById('l-pre');
                if (gw) gw.style.backgroundImage = 'url(' + dataUrl + ')';
                if (lp) { 
                    lp.innerText = ''; 
                    lp.style.backgroundImage = 'url(' + dataUrl + ')'; 
                }
            }
          };

          r.readAsDataURL(file);
        };

        // ä¸Šä¼  App å›¾æ ‡
        window.hIcon = function (appId) {
          const input = document.getElementById('f-icon-' + appId);
          if (!input || !input.files || !input.files[0]) return;

          const file = input.files[0];
          const r = new FileReader();

          r.onload = (e) => {
            localStorage.setItem('app_icon_' + appId, e.target.result);

            const icon = document.getElementById('i-' + appId);
            if (icon) {
              icon.style.backgroundImage = 'url(' + e.target.result + ')';
              icon.classList.add('has-img');
              icon.innerHTML = '';
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            if (typeof showUploadSuccess === 'function') {
                showUploadSuccess();
            }
          };

          r.readAsDataURL(file);
        };

        // æ˜¾ç¤ºä¸Šä¼ æˆåŠŸæç¤º (å·¥å…·å‡½æ•°)
        function showUploadSuccess() {
          const successDiv = document.getElementById('upload-success');
          if (!successDiv) return;

          successDiv.style.display = 'block';
          // é‡æ–°è§¦å‘åŠ¨ç”»
          successDiv.style.animation = 'none';
          successDiv.offsetHeight; /* è§¦å‘é‡ç»˜ */
          successDiv.style.animation = 'fadeInOut 2s ease-in-out';

          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 2000);
        }
        // =====================================================
        // 3. æ›´æ–°å£çº¸é¢„è§ˆï¼ˆå®‰å…¨ä¿®å¤ç‰ˆï¼Œé˜²æ­¢ä¸­æ–­ JSï¼‰
        // =====================================================
        function updateWallpaperPreview(type, dataUrl) {
            if (!type || !dataUrl) return;

            // è¯»å–è®¾ç½®ï¼ˆä¸å­˜åœ¨å°±ç»™ç©ºç»“æ„ï¼Œé˜²æ­¢æŠ¥é”™ï¼‰
            const settings = (typeof getAppSettings === 'function' && getAppSettings()) || {
                theme: {}
            };

            // å·¥å…·å‡½æ•°ï¼šå®‰å…¨è®¾ç½®èƒŒæ™¯
            function setBg(id, url, clearHtml) {
                const el = document.getElementById(id);
                if (!el) return;
                el.style.backgroundImage = 'url(' + url + ')';
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                if (clearHtml) el.innerHTML = '';
            }

            if (type === 'wall') {
                setBg('global-wall', dataUrl);
                settings.theme.lockWallpaper = dataUrl;
                // å¦‚æœæœ‰é”å±é¢„è§ˆå°ç»„ä»¶ï¼Œä¹ŸåŒæ­¥æ›´æ–°
                setBg('l-pre', dataUrl, true);

            } else if (type === 'lph') {
                setBg('l-pre', dataUrl, true);
                settings.theme.lockWallpaper = dataUrl;

            } else if (type === 'desktop1') {
                const desktop1 = document.querySelector('.desktop-page:first-child');
                if (desktop1) {
                    desktop1.style.backgroundImage = 'url(' + dataUrl + ')';
                    desktop1.style.backgroundSize = 'cover';
                    desktop1.style.backgroundPosition = 'center';
                }
                settings.theme.desktopWallpaper = dataUrl;

            } else if (type === 'desktop2') {
                const desktop2 = document.querySelector('.desktop-page:nth-child(2)');
                if (desktop2) {
                    desktop2.style.backgroundImage = 'url(' + dataUrl + ')';
                    desktop2.style.backgroundSize = 'cover';
                    desktop2.style.backgroundPosition = 'center';
                }
                settings.theme.desktopWallpaper2 = dataUrl;

            } else if (type === 'pwall') {
                setBg('i-p-wall', dataUrl);

            } else if (type === 'p2bg') {
                setBg('p2bg', dataUrl);

            } else if (type === 'p2av') {
                setBg('p2av', dataUrl);

            } else if (type === 'p2memo') {
                setBg('p2memo', dataUrl, true);

            } else if (type === 'avL') {
                setBg('avL', dataUrl);

            } else if (type === 'avR') {
                setBg('avR', dataUrl);
            }

            // ä¿å­˜è®¾ç½®ï¼ˆå­˜åœ¨æ‰ä¿å­˜ï¼‰
            if (typeof saveAppSettings === 'function') {
                saveAppSettings(settings);
            }
        }

        // =====================================================
        // 4. æ—¶é—´ä¸æ—¶é’Ÿæ›´æ–°ï¼ˆå®‰å…¨ä¿®å¤ç‰ˆï¼Œé˜²æ­¢ä¸­æ–­ JSï¼‰
        // =====================================================
        (function () {

            function setText(id, text) {
                const el = document.getElementById(id);
                if (el) el.innerText = text;
            }

            function setRotate(id, deg) {
                const el = document.getElementById(id);
                if (el) el.style.transform = "rotate(" + deg + "deg)";
            }

            function updateTime() {
                const n = new Date();

                // æ ¼å¼åŒ–æ—¶é—´ 09:05
                const t =
                    n.getHours().toString().padStart(2, '0') +
                    ":" +
                    n.getMinutes().toString().padStart(2, '0');

                // æ›´æ–°æ•°å­—æ—¶é—´ï¼ˆé”å± / æ¡Œé¢ï¼‰
                setText('l-time', t);
                setText('d-time', t);

                // æ›´æ–°æ—¥æœŸï¼ˆå¸¦å®¹é”™å¤„ç† - æ¢å¤ PDF åŸæ–‡é€»è¾‘ï¼‰
                try {
                    const opt = { month: 'long', day: 'numeric', weekday: 'long' };
                    setText('l-date', n.toLocaleDateString('zh-CN', opt));
                } catch (e) {
                    // å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒä¸­æ–‡æ ¼å¼ï¼Œå›é€€åˆ°ç®€å•æ ¼å¼
                    setText('l-date', (n.getMonth() + 1) + "æœˆ" + n.getDate() + "æ—¥");
                }

                // æ¨¡æ‹Ÿæ—¶é’ŸæŒ‡é’ˆè®¡ç®—
                const s = n.getSeconds() * 6;
                const m = n.getMinutes() * 6;
                const h = (n.getHours() % 12) * 30 + m / 12;

                setRotate('h-s', s);
                setRotate('h-m', m);
                setRotate('h-h', h);
            }

            // ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åæ¯ç§’æ›´æ–°
            updateTime();
            setInterval(updateTime, 1000);

        })();
        // =====================================================
        // 5. æ¡Œé¢å·¦å³æ»‘åŠ¨ï¼ˆç¨³å®šå®‰å…¨ç‰ˆï¼‰
        // =====================================================
        (function () {
            const sw = document.getElementById('main-desktop');
            const box = document.getElementById('box');

            if (!sw || !box) return;

            let startX = null;
            let currentPage = 1; // 1 = ç¬¬ä¸€é¡µï¼Œ2 = ç¬¬äºŒé¡µ

            // è§¦æ‘¸å¼€å§‹
            sw.addEventListener('touchstart', (e) => {
                // ä¸¥è°¨æ ¡éªŒè§¦æ‘¸ç‚¹
                if (!e.touches || !e.touches[0]) return;
                startX = e.touches[0].clientX;
            }, { passive: true });

            // è§¦æ‘¸ç»“æŸ
            sw.addEventListener('touchend', (e) => {
                if (startX === null) return;
                if (!e.changedTouches || !e.changedTouches[0]) return;

                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - startX;

                startX = null;

                // æ»‘åŠ¨è·ç¦»ä¸è¶³ 60px åˆ™å¿½ç•¥ï¼ˆé˜²è¯¯è§¦ï¼‰
                if (Math.abs(deltaX) < 60) return;

                // ğŸ‘‰ å‘å·¦æ»‘ï¼šå»ç¬¬äºŒé¡µ
                if (deltaX < 0 && currentPage === 1) {
                    currentPage = 2;
                    box.classList.remove('page-1');
                    box.classList.add('page-2');
                }

                // ğŸ‘‰ å‘å³æ»‘ï¼šå›ç¬¬ä¸€é¡µ
                if (deltaX > 0 && currentPage === 2) {
                    currentPage = 1;
                    box.classList.remove('page-2');
                    box.classList.add('page-1');
                }
            });
        })();

        // =====================================================
        // 6. åº”ç”¨ç®¡ç†ï¼ˆå…¨é¢åŠ å›ºç¨³å®šç‰ˆï¼‰
        // =====================================================

        // å½“å‰æ‰“å¼€çš„åº”ç”¨ ID
        let currentApp = null;

        // è®¾ç½®é¡µå†å²è®°å½•æ ˆï¼ˆç”¨äºå¤šçº§é¡µé¢è¿”å›ï¼‰
        let settingsHistory = [];

        [span_0](start_span)// åº”ç”¨é…ç½®æ•°æ®[span_0](end_span)
        const apps = {
            // æ¡Œé¢ç¬¬ä¸€é¡µ
            weibo:   { name: 'å¾®åš', icon: 'ğŸ“±', desc: 'å¾®åšç¤¾äº¤åº”ç”¨' },
            date:    { name: 'çº¦ä¼š', icon: 'â¤ï¸', desc: 'çº¦ä¼šæé†’åº”ç”¨' },
            music:   { name: 'ç½‘æ˜“äº‘', icon: 'ğŸµ', desc: 'éŸ³ä¹æ’­æ”¾åº”ç”¨' },
            game:    { name: 'æ¸¸æˆ', icon: 'ğŸ®', desc: 'æ¸¸æˆä¸­å¿ƒ' },

            // æ¡Œé¢ç¬¬äºŒé¡µ
            secret:  { name: 'ç§˜å¯†', icon: 'ğŸ”’', desc: 'ç§å¯†ç©ºé—´' },
            memory:  { name: 'çºªå¿µæ—¥', icon: 'ğŸ—“ï¸', desc: 'çºªå¿µæ—¥æé†’' },
            shop:    { name: 'è§£å¿§æ‚è´§é“º', icon: 'ğŸ ', desc: 'è´­ç‰©åº”ç”¨' },
            taobao:  { name: 'æ·˜å®é—ªè´­', icon: 'ğŸ›ï¸', desc: 'è´­ç‰©åº”ç”¨' },
            gogogo:  { name: 'GoGoGo', icon: 'ğŸ“', desc: 'çº¿ä¸‹æ¨¡å¼' },
            preset:  { name: 'é¢„è®¾', icon: 'âš™ï¸', desc: 'ç³»ç»Ÿé¢„è®¾' },
            douyin:  { name: 'æŠ–éŸ³', icon: 'ğŸµ', desc: 'çŸ­è§†é¢‘åº”ç”¨' },
            calendar:{ name: 'å°ç‹—æœˆå†', icon: 'ğŸ“…', desc: 'ç”Ÿç†æœŸè®°å½•' },
            desire:  { name: 'æ¬²æœ›å›å»Š', icon: 'â™¾ï¸', desc: 'ç‰¹æ®Šåº”ç”¨' },

            // åº•éƒ¨çŠ¶æ€æ 
            wechat:  { name: 'å¾®ä¿¡', icon: 'ğŸ’¬', desc: 'å³æ—¶é€šè®¯' },
            bottle:  { name: 'æ¼‚æµç“¶', icon: 'ğŸ¼', desc: 'æ¼‚æµç“¶åº”ç”¨' },
            worldbook:{ name: 'ä¸–ç•Œä¹¦', icon: 'ğŸ“š', desc: 'çŸ¥è¯†åº“åº”ç”¨' },
            settings:{ name: 'è®¾ç½®', icon: 'âš™ï¸', desc: 'ç³»ç»Ÿè®¾ç½®' },

            // å¾®ä¿¡å†…
            moments: { name: 'æœ‹å‹åœˆ', icon: 'ğŸ§­', desc: 'ç¤¾äº¤åŠ¨æ€' },
            profile: { name: 'æˆ‘çš„', icon: 'ğŸ™‚', desc: 'ä¸ªäººèµ„æ–™' }
        };

        // å·¥å…·ï¼šå®‰å…¨è·å–å…ƒç´ 
        function $(id) {
            return document.getElementById(id);
        }

        // å·¥å…·ï¼šå®‰å…¨æ¿€æ´»/å…³é—­ç±»å
        function setActive(id, active) {
            const el = $(id);
            if (!el) return;
            el.classList.toggle('active', active);
        }

        [span_1](start_span)// æ‰“å¼€åº”ç”¨ (æ ¸å¿ƒå‡½æ•°)[span_1](end_span)
        window.openApp = function (appId) {
            if (!appId) return;

            console.log('æ‰“å¼€åº”ç”¨:', appId);

            // 1. å…³é—­æ‰€æœ‰å·²çŸ¥åº”ç”¨å®¹å™¨ï¼Œé˜²æ­¢é‡å 
            const nodes = document.querySelectorAll('.app-container, .wc-app, .settings-app');
            if (nodes && nodes.length) {
                nodes.forEach(el => el.classList.remove('active'));
            }

            currentApp = appId;

            // 2. ç‰¹æ®Šåº”ç”¨å¤„ç†

            // å¾®ä¿¡
            if (appId === 'wechat') {
                setActive('wc-app', true);
                // å¦‚æœæ¸²æŸ“å‡½æ•°å·²åŠ è½½ï¼Œåˆ™æ‰§è¡Œæ¸²æŸ“
                if (typeof wcRenderChats === 'function') {
                    wcRenderChats();
                }
                return;
            }

            // è®¾ç½®
            if (appId === 'settings') {
                if (typeof openSettingsApp === 'function') {
                    openSettingsApp();
                } else {
                    // å…œåº•ï¼šå¦‚æœè®¾ç½®é€»è¾‘è¿˜æ²¡åŠ è½½å®Œï¼Œç›´æ¥æ˜¾ç¤ºå®¹å™¨
                    setActive('settings-app', true);
                }
                return;
            }

            // æ¼‚æµç“¶
            if (appId === 'bottle') {
                setActive('bottle-app', true);
                return;
            }

            // ä¸–ç•Œä¹¦
            if (appId === 'worldbook') {
                setActive('worldbook-app', true);
                return;
            }

            // 3. é€šç”¨åº”ç”¨å¤„ç† (Generic App)
            const app = apps[appId];
            if (!app) {
                console.warn('æœªçŸ¥åº”ç”¨:', appId);
                return;
            }

            const genericApp = $('generic-app');
            if (!genericApp) return;

            // åŠ¨æ€å¡«å……é€šç”¨åº”ç”¨çš„å†…å®¹
            const title = $('generic-app-title');
            const icon  = $('generic-app-icon');
            const name  = $('generic-app-name');
            const desc  = $('generic-app-desc');

            if (title) title.innerText = app.name;
            if (icon)  icon.innerText = app.icon; // ä½¿ç”¨ Emoji æˆ–æ–‡å­—å›¾æ ‡
            if (name)  name.innerText = app.name;
            if (desc)  desc.innerHTML = `${app.desc}<br>åŠŸèƒ½å¼€å‘ä¸­...`;

            genericApp.classList.add('active');
        };

        // å…³é—­åº”ç”¨
        window.closeApp = function (appId) {
            console.log('å…³é—­åº”ç”¨:', appId);

            if (appId === 'wechat') {
                setActive('wc-app', false);
            } else if (appId === 'bottle') {
                setActive('bottle-app', false);
            } else if (appId === 'worldbook') {
                setActive('worldbook-app', false);
            } else {
                // é»˜è®¤å…³é—­é€šç”¨å®¹å™¨
                setActive('generic-app', false);
            }

            currentApp = null;
        };
        // =====================================================
        // 7. å…³é—­å½“å‰é¡µé¢ï¼ˆè®¾ç½®åº”ç”¨ï¼‰- ç¨³å®šåŠ å›ºç‰ˆ
        // =====================================================
        window.closeCurrentPage = function () {
            console.log('å…³é—­å½“å‰é¡µé¢ï¼Œå†å²è®°å½•:', settingsHistory);

            // 1. å†å²è®°å½•å…œåº•
            if (!Array.isArray(settingsHistory)) {
                settingsHistory = [];
            }

            // 2. æœ‰ä¸Šä¸€çº§é¡µé¢ -> è¿”å›ä¸Šä¸€çº§
            if (settingsHistory.length > 1) {
                // ç§»é™¤å½“å‰é¡µ
                settingsHistory.pop();

                const lastPage = settingsHistory[settingsHistory.length - 1];
                console.log('è¿”å›ä¸Šä¸€çº§é¡µé¢:', lastPage);

                if (lastPage === 'main') {
                    if (typeof renderSettingsMain === 'function') {
                        renderSettingsMain();
                    } else {
                        console.warn('renderSettingsMain æœªå®šä¹‰');
                    }
                } else {
                    if (typeof renderSettingsPage === 'function') {
                        // âš ï¸ è¿™é‡Œä¼ é€’ fromHistory: trueï¼Œé˜²æ­¢é‡å¤ push åˆ°å†å²è®°å½•
                        renderSettingsPage(lastPage, { fromHistory: true });
                    } else {
                        console.warn('renderSettingsPage æœªå®šä¹‰');
                    }
                }

            } else {
                // 3. æ²¡æœ‰å†å² -> ç›´æ¥å…³é—­è®¾ç½®åº”ç”¨
                console.log('å…³é—­è®¾ç½®åº”ç”¨');

                // ä¼˜å…ˆå°è¯•è°ƒç”¨å°è£…å¥½çš„å…³é—­å‡½æ•°
                if (typeof closeSettingsApp === 'function') {
                    closeSettingsApp();
                } 
                // å…œåº•ï¼šè°ƒç”¨é€šç”¨å…³é—­å‡½æ•°
                else if (typeof window.closeApp === 'function') {
                    window.closeApp('settings');
                } 
                [span_0](start_span)// æœ€åº•å±‚å…œåº•ï¼šç›´æ¥æ“ä½œ DOM[span_0](end_span)
                else {
                    const el = document.getElementById('settings-app');
                    if (el) {
                        el.classList.remove('active');
                        el.style.display = 'none';
                    }
                    settingsHistory = [];
                }
            }
        };

        // =====================================================
        // 8. å¯åŠ¨åŠ è½½é€»è¾‘ï¼ˆå…¨é¢åŠ å›ºç¨³å®šç‰ˆï¼‰
        // =====================================================
        function initAppLoad() {

            [span_1](start_span)// ---------- 1. åŠ è½½å…¨å±€å£çº¸[span_1](end_span) ----------
            try {
                const wall = localStorage.getItem('u_wall');
                if (wall) {
                    const gw = document.getElementById('global-wall');
                    if (gw) {
                        gw.style.backgroundImage = 'url(' + wall + ')';
                    }

                    const lPre = document.getElementById('l-pre');
                    if (lPre) {
                        lPre.innerHTML = '';
                        lPre.style.backgroundImage = 'url(' + wall + ')';
                        lPre.style.backgroundSize = 'cover';
                        lPre.style.backgroundPosition = 'center';
                    }
                }
            } catch (e) {
                console.error('åŠ è½½å£çº¸å¤±è´¥:', e);
            }

            [span_2](start_span)// ---------- 2. åŠ è½½åº”ç”¨å›¾æ ‡[span_2](end_span) ----------
            if (typeof apps === 'object') {
                Object.keys(apps).forEach(appId => {
                    const icon = document.getElementById('i-' + appId);
                    if (!icon) return;

                    const savedIcon = localStorage.getItem('app_icon_' + appId);
                    if (savedIcon) {
                        icon.style.backgroundImage = 'url(' + savedIcon + ')';
                        icon.classList.add('has-img');
                        icon.innerHTML = '';
                    } else {
                        // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰å›¾æ ‡ï¼Œä½¿ç”¨é»˜è®¤ emoji æˆ–ç©º
                        icon.innerHTML = apps[appId].icon || '';
                    }
                });
            }

            [span_3](start_span)// ---------- 3. åŠ è½½æ¡Œé¢å£çº¸[span_3](end_span) ----------
            let settings = null;
            if (typeof getAppSettings === 'function') {
                settings = getAppSettings();
            }
            if (!settings || !settings.theme) {
                settings = { theme: {} };
            }

            if (settings.theme.desktopWallpaper) {
                const desktop1 = document.querySelector('.desktop-page:first-child');
                if (desktop1) {
                    desktop1.style.backgroundImage = 'url(' + settings.theme.desktopWallpaper + ')';
                    desktop1.style.backgroundSize = 'cover';
                    desktop1.style.backgroundPosition = 'center';
                }
            }

            if (settings.theme.desktopWallpaper2) {
                const desktop2 = document.querySelector('.desktop-page:nth-child(2)');
                if (desktop2) {
                    desktop2.style.backgroundImage = 'url(' + settings.theme.desktopWallpaper2 + ')';
                    desktop2.style.backgroundSize = 'cover';
                    desktop2.style.backgroundPosition = 'center';
                }
            }

            [span_4](start_span)// ---------- 4. æ¢å¤ç”¨æˆ·è‡ªå®šä¹‰æ–‡æœ¬ï¼ˆé‡è¦è¡¥å……ï¼‰[span_4](end_span) ----------
            // ä¿®å¤æ¼æ‰çš„é€»è¾‘ï¼šç¡®ä¿é”å±ä¸Šçš„æ–‡å­—ä¿®æ”¹åèƒ½ä¿å­˜
            ['lkp', 'n1', 'n2', 'n3', 'dl1', 'dl2', 'd13'].forEach(id => {
                const txt = localStorage.getItem('u_' + id);
                if (txt) {
                    const el = document.getElementById(id);
                    if (el) el.innerText = txt;
                }
            });

            [span_5](start_span)// ---------- 5. å¾®ä¿¡æ•°æ®åŠ è½½ï¼ˆéš”ç¦»ï¼Œä¸å½±å“ä¸»æµç¨‹ï¼‰[span_5](end_span) ----------
            try {
                if (typeof wcRenderChats === 'function') {
                    wcRenderChats();
                }
                if (typeof wcRenderContacts === 'function') {
                    wcRenderContacts();
                }
            } catch (e) {
                console.error('åŠ è½½å¾®ä¿¡æ•°æ®å¤±è´¥:', e);
            }
        }

        // å¯åŠ¨æ‰§è¡Œï¼ˆç¡®ä¿ DOM å·²åŠ è½½ï¼‰
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAppLoad);
        } else {
            initAppLoad();
        }

        [span_6](start_span)// ---------- æ¸¸æˆåŠ¨ç”»[span_6](end_span) ----------
        window.gameAnim = function () {
            const s = document.getElementById('gs');
            if (!s) return;

            s.innerHTML = "LOADING...<br>å‰¯æœ¬ç”Ÿæˆä¸­";
            setTimeout(() => {
                s.innerHTML = "READY!<br>æ¬¢è¿æ¥åˆ°å›å»Š";
            }, 1500);
        };
        /* ============================
           ğŸ’š WeChat Logicï¼ˆå…¨é¢åŠ å›ºç¨³å®šç‰ˆï¼‰
           ============================ */

        // ---------- åŸºç¡€çŠ¶æ€ ----------
        let wcTempImg = "";
        let currentChatUser = null;
        let currentEditingFriend = null;
        let isBlocked = false; [cite_start]// [cite: 308-310]

        // ---------- å®‰å…¨è¯»å–æœ¬åœ°æ•°æ® ----------
        function safeParse(key) {
            try {
                return JSON.parse(localStorage.getItem(key) || "[]");
            } catch (e) {
                console.error('è§£æå¤±è´¥:', key, e);
                return [];
            }
        [cite_start]} // [cite: 310-311]

        // ç»Ÿä¸€å…¨å±€çŠ¶æ€ï¼ˆåªä¿ç•™ä¸€ä»½ï¼‰
        window.wcFriends = safeParse('wc_friends');
        window.wcChats   = safeParse('wc_chats'); [cite_start]//[span_0](end_span)

        // ---------- åŸºç¡€å…¥å£ ----------
        window.wcOpen = function () {
            if (typeof openApp === 'function') {
                openApp('wechat');
            }
        }; [span_1](start_span)//[span_1](end_span)

        window.wcClose = function () {
            if (typeof closeApp === 'function') {
                closeApp('wechat');
            }
            const menu = document.getElementById('wc-menu');
            if (menu) menu.style.display = 'none';
        }; [span_2](start_span)//[span_2](end_span)

        // ---------- èœå• ----------
        window.wcToggleMenu = function () {
            const m = document.getElementById('wc-menu');
            if (!m) return;
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        }; [span_3](start_span)// [cite: 313-314]

        // ---------- Tab åˆ‡æ¢ ----------
        window.wcSwitchTab = function (tab) {
            document.querySelectorAll('.wc-tab').forEach(t => t.classList.remove('active'));
            const tabEl = document.getElementById('tab-' + tab);
            if (tabEl) tabEl.classList.add('active'); [cite_start]//[span_3](end_span)

            const chatList = document.getElementById('wc-chat-list');
            const contactList = document.getElementById('wc-contact-list');
            const headerTxt = document.getElementById('wc-h-txt');
            const backArrow = document.getElementById('wc-back-arrow');
            const plusBtn = document.getElementById('wc-plus-btn'); [span_4](start_span)//[span_4](end_span)

            if (!chatList || !contactList) return;

            if (tab === 'chat') {
                chatList.style.display = 'block';
                contactList.style.display = 'none';
                if (headerTxt) headerTxt.innerText = 'æ¶ˆæ¯';
                if (backArrow) backArrow.style.display = 'inline';
                if (plusBtn) plusBtn.style.visibility = 'visible';
                if (typeof wcRenderChats === 'function') wcRenderChats(); [span_5](start_span)// [cite: 317-318]
            } else if (tab === 'contact') {
                chatList.style.display = 'none';
                contactList.style.display = 'block';
                if (headerTxt) headerTxt.innerText = 'é€šè®¯å½•';
                if (backArrow) backArrow.style.display = 'none';
                if (plusBtn) plusBtn.style.visibility = 'hidden';
                if (typeof wcRenderContacts === 'function') wcRenderContacts(); [cite_start]// [cite: 318-320]
            }
        };

        // ---------- æ·»åŠ å¥½å‹ ----------
        window.wcShowAdd = function () {
            const menu = document.getElementById('wc-menu');
            const modal = document.getElementById('wc-modal-add');
            if (menu) menu.style.display = 'none';
            if (modal) modal.style.display = 'flex'; [cite_start]// [cite: 320-321]

            wcTempImg = "";
            const av = document.getElementById('wc-new-av');
            if (av) {
                av.style.backgroundImage = 'none';
                av.classList.remove('has-img');
            [cite_start]} // [cite: 321-323]

            const nameInput = document.getElementById('wc-new-name');
            if (nameInput) nameInput.value = "";
        }; [cite_start]//[span_5](end_span)

        window.wcHideAdd = function () {
            const modal = document.getElementById('wc-modal-add');
            if (modal) modal.style.display = 'none';
        }; [span_6](start_span)//[span_6](end_span)

        window.wcHandleAv = function (input) {
            const f = input?.files?.[0];
            if (!f) return;

            const r = new FileReader();
            r.onload = (e) => {
                wcTempImg = e.target.result;
                const av = document.getElementById('wc-new-av');
                if (av) {
                    av.style.backgroundImage = 'url(' + wcTempImg + ')';
                    av.classList.add('has-img');
                }
            };
            r.readAsDataURL(f);
        }; [span_7](start_span)// [cite: 325-327]

        // ä¿®å¤æ·»åŠ å¥½å‹é€»è¾‘
window.wcConfirmAdd = function() {
    // 1. è·å–è¾“å…¥æ¡†
    const nameInput = document.getElementById('wc-new-name');
    if (!nameInput) return;
    
    // 2. æ£€æŸ¥æœ‰æ²¡æœ‰å¡«åå­—
    const name = nameInput.value.trim();
    if (!name) {
        alert("âš ï¸ è¯·è¾“å…¥å¥½å‹åå­—ï¼");
        return;
    }

    // 3. è¯»å–æ—§æ•°æ®ï¼ˆé˜²æ­¢æŠ¥é”™ï¼‰
    let friends = [];
    try {
        friends = JSON.parse(localStorage.getItem('wc_friends') || "[]");
    } catch(e) { friends = []; }

    // 4. åˆ›å»ºæ–°å¥½å‹
    const newFriend = {
        id: Date.now().toString(),
        name: name,
        alias: name,
        av: window.wcTempImg || "", // è¿™é‡Œæ˜¯ç”¨ä½ ä¸Šä¼ çš„å¤´åƒ
        isStarred: false,
        desc: "ç‚¹å‡»ä¿®æ”¹äººè®¾",
        sign: ""
    };

    // 5. ä¿å­˜å¹¶æ›´æ–°
    friends.push(newFriend);
    localStorage.setItem('wc_friends', JSON.stringify(friends));
    window.wcFriends = friends; // æ›´æ–°å†…å­˜æ•°æ®

    alert(`âœ… å·²æ·»åŠ å¥½å‹ï¼š${name}`);

    // 6. å¼ºåˆ¶åˆ·æ–°é€šè®¯å½•åˆ—è¡¨
    if (typeof window.wcRenderContacts === 'function') {
        window.wcRenderContacts();
    }

    // 7. å…³é—­å¼¹çª—å¹¶è·³è½¬
    window.wcHideAdd();
    const tabContact = document.getElementById('tab-contact');
    if(tabContact) tabContact.click(); // è‡ªåŠ¨ç‚¹ä¸€ä¸‹â€œé€šè®¯å½•â€æ ‡ç­¾
};

           // =====================================================
        // 9. æ–°å»ºèŠå¤©ï¼ˆç¨³å®šåŠ å›ºç‰ˆï¼‰
        // =====================================================

        // æ‰“å¼€æ–°å»ºèŠå¤©
        window.wcShowNewChat = function () {
            const menu = document.getElementById('wc-menu');
            if (menu) menu.style.display = 'none';

            const list = document.getElementById('wc-friend-select');
            if (!list) return; [cite_start]// [cite: 330-331]

            list.innerHTML = "";

            const friends = window.wcFriends || [];

            if (friends.length === 0) {
                list.innerHTML =
                    "<div style='text-align:center;color:#aaa;margin-top:20px'>æš‚æ— å¥½å‹</div>";
            } else {
                friends.forEach(f => {
                    const d = document.createElement('div');
                    d.className = 'wc-sel-item';
                    d.dataset.id = f.id;
                    d.dataset.name = f.alias || f.name;

                    d.innerHTML = `
                        <div class="wc-sel-check"></div>
                        <div style="font-size:14px;font-weight:500;color:#333">
                            ${f.alias || f.name}
                        </div>
                    [cite_start]`; // [cite: 332-333]

                    d.onclick = () => d.classList.toggle('selected');
                    list.appendChild(d);
                });
            }

            const modal = document.getElementById('wc-modal-chat');
            if (modal) modal.style.display = 'flex'; [cite_start]//[span_7](end_span)
        };

        // ç¡®è®¤åˆ›å»ºèŠå¤©
        window.wcConfirmChat = function () {
            const items = document.querySelectorAll('.wc-sel-item.selected');
            if (!items.length) {
                alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä½å¥½å‹");
                return;
            [span_8](start_span)} //[span_8](end_span)

            const members = Array.from(items).map(i => ({
                id: i.dataset.id,
                name: i.dataset.name
            })); [span_9](start_span)//[span_9](end_span)

            const isGroup = members.length > 1;

            const chat = {
                id: 'chat_' + Date.now(),
                type: isGroup ? 'group' : 'single',
                members: members,
                name: isGroup
                    ? `ç¾¤èŠ (${members.length}äºº)`
                    : members[0].name,
                av: "",
                last: "ä½ å‘èµ·äº†èŠå¤©",
                time: "åˆšåˆš",
                isPinned: false,
                messages: []
            }; [span_10](start_span)//[span_10](end_span)

            window.wcChats = window.wcChats || [];
            window.wcChats.unshift(chat);

            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats)); [span_11](start_span)//[span_11](end_span)

            if (typeof wcRenderChats === 'function') {
                wcRenderChats();
            }

            const modal = document.getElementById('wc-modal-chat');
            if (modal) modal.style.display = 'none'; [cite_start]// [cite: 337-338]
        };
        // =====================================================
        // 10. ğŸŸ¢ æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ï¼ˆç¨³å®šå·¦æ»‘ + æ•°æ®åŠ å›ºç‰ˆï¼‰
        // =====================================================
        window.wcRenderChats = function () {
            const el = document.getElementById('wc-chat-list');
            if (!el) return;

            const chats = window.wcChats || [];
            const friends = window.wcFriends || [];

            // ç½®é¡¶ä¼˜å…ˆæ’åºï¼šå…ˆçœ‹æ˜¯å¦ç½®é¡¶ï¼Œå†çœ‹æ—¶é—´ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºç½®é¡¶ä¼˜å…ˆï¼‰
            chats.sort((a, b) => (b.isPinned === a.isPinned) ? 0 : b.isPinned ? 1 : -1);

            el.innerHTML = "";

            if (chats.length === 0) {
                el.innerHTML =
                    '<div class="wc-empty">âœ¨ æš‚æ— æ¶ˆæ¯<br>ç‚¹å‡»å³ä¸Šè§’ + å‘èµ·èŠå¤©</div>';
                return;
            }

            chats.forEach(chat => {
                const d = document.createElement('div');
                d.className = 'wc-list-item' + (chat.isPinned ? ' pinned' : '');
                d.dataset.id = chat.id;

                // è·å–æ˜¾ç¤ºåå’Œå¤´åƒï¼ˆä»æˆå‘˜é‡Œæ‰¾ï¼Œå•èŠä¼˜å…ˆæ˜¾ç¤ºå¯¹æ–¹ä¿¡æ¯ï¼‰
                let displayName = chat.name;
                let avUrl = chat.av;

                if (chat.members && chat.members.length === 1) {
                    const f = friends.find(x => x.id === chat.members[0].id);
                    if (f) {
                        if (f.alias) displayName = f.alias;
                        if (f.av) avUrl = f.av;
                    }
                }

                const avStyle = avUrl
                    ? `background-image:url(${avUrl})`
                    : 'background:#eee';

                d.innerHTML = `
                    <div class="wc-avatar" style="${avStyle}"></div>
                    <div class="wc-info">
                        <div class="wc-name">${displayName}</div>
                        <div class="wc-last-msg">
                            ${chat.isPinned ? '<span style="color:#07c160;font-size:10px;">[ç½®é¡¶]</span>' : ''}
                            ${chat.last || '<span style="color:red">[æ–°ä¼šè¯]</span>'}
                        </div>
                    </div>
                    <div class="wc-time">${chat.time || ''}</div>

                    <div class="wc-swipe-actions">
                        <div class="wc-swipe-btn pin">${chat.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}</div>
                        <div class="wc-swipe-btn delete">åˆ é™¤</div>
                    </div>
                `;

                // ---------- ç‚¹å‡»è¿›å…¥èŠå¤©ï¼ˆä»…éæ»‘åŠ¨çŠ¶æ€æœ‰æ•ˆï¼‰ ----------
                let isSwiping = false;
                d.addEventListener('click', () => {
                    if (!isSwiping && typeof openChat === 'function') {
                        openChat(chat, displayName);
                    }
                });

                // ---------- å·¦æ»‘é€»è¾‘ (æ ¸å¿ƒä¿®å¤) ----------
                let startX = 0;

                d.addEventListener('touchstart', e => {
                    if (e.touches.length > 0) {
                        startX = e.touches[0].clientX;
                        isSwiping = false;

                        // æ”¶èµ·å…¶ä»–å·²æ»‘å‡ºçš„é¡¹
                        document.querySelectorAll('.wc-list-item.swiping')
                            .forEach(i => i !== d && i.classList.remove('swiping'));
                    }
                }, { passive: true });

                d.addEventListener('touchmove', e => {
                    if (e.touches.length > 0) {
                        const diffX = startX - e.touches[0].clientX;

                        // åªæœ‰æ¨ªå‘æ»‘åŠ¨è¶…è¿‡ä¸€å®šè·ç¦»æ‰è§¦å‘
                        if (Math.abs(diffX) > 10) {
                            // å‘å·¦æ»‘ (diffX > 0)
                            if (diffX > 50) {
                                d.classList.add('swiping');
                                isSwiping = true;
                                // é˜»æ­¢é»˜è®¤æ»šåŠ¨ï¼Œæå‡ä½“éªŒ
                                if (e.cancelable) e.preventDefault();
                            } 
                            // å‘å³æ»‘å›å» (diffX < 0)
                            else if (diffX < -50) {
                                d.classList.remove('swiping');
                                isSwiping = false;
                            }
                        }
                    }
                }, { passive: false }); // æ³¨æ„è¿™é‡Œ passive: false ä»¥ä¾¿ preventDefault ç”Ÿæ•ˆ

                d.addEventListener('touchend', () => {
                    // å»¶æ—¶é‡ç½®çŠ¶æ€ï¼Œé˜²æ­¢ç‚¹å‡»ç©¿é€
                    setTimeout(() => { isSwiping = false; }, 100);
                });

                // ---------- æŒ‰é’®äº‹ä»¶ ----------
                const pinBtn = d.querySelector('.wc-swipe-btn.pin');
                const delBtn = d.querySelector('.wc-swipe-btn.delete');

                if (pinBtn) {
                    pinBtn.onclick = e => {
                        e.stopPropagation();
                        chat.isPinned = !chat.isPinned;
                        localStorage.setItem('wc_chats', JSON.stringify(chats));
                        wcRenderChats();
                    };
                }

                if (delBtn) {
                    delBtn.onclick = e => {
                        e.stopPropagation();
                        if (confirm('ç¡®å®šåˆ é™¤æ­¤èŠå¤©å—ï¼Ÿ')) {
                            window.wcChats = chats.filter(c => c.id !== chat.id);
                            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));
                            wcRenderChats();
                        }
                    };
                }

                el.appendChild(d);
            });
        };

        // =====================================================
        // 11. ğŸŸ¢ æ¸²æŸ“é€šè®¯å½•åˆ—è¡¨ & èµ„æ–™ç¼–è¾‘ï¼ˆç¨³å®šåŠ å›ºç‰ˆï¼‰
        // =====================================================

        // ---------- æ¸²æŸ“é€šè®¯å½• ----------
        // ä¿®å¤é€šè®¯å½•æ¸²æŸ“
window.wcRenderContacts = function() {
    const el = document.getElementById('wc-contact-list');
    if (!el) return;

    // æ¸…ç©ºåˆ—è¡¨
    el.innerHTML = "";

    // è·å–æ•°æ®
    const friends = window.wcFriends || JSON.parse(localStorage.getItem('wc_friends') || "[]");

    // å¦‚æœæ²¡æœ‰å¥½å‹
    if (friends.length === 0) {
        el.innerHTML = "<div style='text-align:center; color:#999; margin-top:50px;'>æš‚æ— å¥½å‹<br>è¯·ç‚¹å‡»å³ä¸Šè§’ + å·æ·»åŠ </div>";
        return;
    }

    // å¾ªç¯æ˜¾ç¤ºæ¯ä¸ªå¥½å‹
    friends.forEach(f => {
        const div = document.createElement('div');
        div.className = 'contact-item'; // ç¡®ä¿ä½ çš„CSSé‡Œæœ‰è¿™ä¸ªæ ·å¼
        // è®¾ç½®å¤´åƒæ ·å¼
        const avStyle = f.av ? `background-image:url(${f.av})` : 'background-color:#eee';
        
        div.innerHTML = `
            <div class="c-av-small" style="${avStyle}; background-size:cover;"></div>
            <div class="c-name-text" style="font-size:16px; font-weight:500;">${f.alias || f.name}</div>
        `;
        
        // ç‚¹å‡»å¥½å‹æŸ¥çœ‹èµ„æ–™
        div.onclick = function() {
            if(window.openProfile) window.openProfile(f.id);
        };

        el.appendChild(div);
    });
};

        // ---------- æ‰“å¼€èµ„æ–™é¡µ ----------
        window.openProfile = function (friendId) {
            const friend = (window.wcFriends || []).find(f => f.id === friendId);
            if (!friend) return;

            currentEditingFriend = friendId;
            window.pfTempImg = friend.av || ""; // ä½¿ç”¨ window æŒ‚è½½ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®

            const panel = document.getElementById('p-profile');
            if (panel) panel.style.display = 'flex';

            const avEl = document.getElementById('pf-av');
            if (avEl) {
                if (friend.av) {
                    avEl.style.backgroundImage = `url(${friend.av})`;
                    avEl.classList.add('has-img');
                } else {
                    avEl.style.backgroundImage = 'none';
                    avEl.classList.remove('has-img');
                }
            }

            // å®‰å…¨èµ‹å€¼ï¼Œé˜²æ­¢ null æŠ¥é”™
            if (document.getElementById('pf-name')) document.getElementById('pf-name').value = friend.name || "";
            if (document.getElementById('pf-alias')) document.getElementById('pf-alias').value = friend.alias || "";
            if (document.getElementById('pf-desc')) document.getElementById('pf-desc').value = friend.desc || "";
            if (document.getElementById('pf-sign')) document.getElementById('pf-sign').value = friend.sign || "";

            const starSwitch = document.getElementById('pf-star');
            if (starSwitch) {
                // ä½¿ç”¨ toggle æ›´åŠ ç®€æ´
                starSwitch.classList.toggle('on', !!friend.isStarred);
            }
        };

        // ---------- æ›´æ¢èµ„æ–™é¡µå¤´åƒ ----------
        window.wcHandleProfileAv = function (input) {
            const f = input?.files?.[0];
            if (!f) return;

            const r = new FileReader();
            r.onload = e => {
                window.pfTempImg = e.target.result;
                const el = document.getElementById('pf-av');
                if (el) {
                    el.style.backgroundImage = `url(${window.pfTempImg})`;
                    el.classList.add('has-img');
                }
                input.value = ''; // æ¸…ç©º input é˜²æ­¢é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶ä¸è§¦å‘ change
            };
            r.readAsDataURL(f);
        };

        // ---------- ä¿å­˜èµ„æ–™ ----------
        window.saveProfile = function () {
            if (!currentEditingFriend) return;

            const friends = window.wcFriends || [];
            const idx = friends.findIndex(f => f.id === currentEditingFriend);
            if (idx === -1) return;

            // æ›´æ–°å¥½å‹ä¿¡æ¯ï¼ˆä¿ç•™åŸæœ‰å±æ€§ï¼Œè¦†ç›–æ–°å±æ€§ï¼‰
            friends[idx] = {
                ...friends[idx],
                av: window.pfTempImg,
                name: document.getElementById('pf-name')?.value || "",
                alias: document.getElementById('pf-alias')?.value || "",
                desc: document.getElementById('pf-desc')?.value || "",
                sign: document.getElementById('pf-sign')?.value || "",
                isStarred: document.getElementById('pf-star')?.classList.contains('on')
            };

            window.wcFriends = friends;
            localStorage.setItem('wc_friends', JSON.stringify(friends));

            // å…³é—­èµ„æ–™é¡µ
            const panel = document.getElementById('p-profile');
            if (panel) panel.style.display = 'none';

            // åˆ·æ–°ç•Œé¢
            wcRenderContacts();
            wcRenderChats();
        };
        // =====================================================
        // 12. ğŸ’¬ èŠå¤©çª—å£ / è®¾ç½® / AI é€»è¾‘ï¼ˆæœ€ç»ˆç¨³å®šç‰ˆï¼‰
        // =====================================================

        let currentChatId = null;
        // æ³¨æ„ï¼šisBlocked å·²ç»åœ¨ç¬¬ 9 éƒ¨åˆ†å®šä¹‰è¿‡ï¼Œè¿™é‡Œå¯ä»¥å¤ç”¨æˆ–é‡æ–°èµ‹å€¼ï¼Œç¡®ä¿å…¨å±€ä¸€è‡´
        // let isBlocked = false; 

        // ---------- å·¥å…·ï¼šè·å–å½“å‰èŠå¤© ----------
        function getCurrentChat() {
            if (!currentChatId) return null;
            return (window.wcChats || []).find(c => c.id === currentChatId) || null;
        }

        // ---------- æŸ¥æ‰¾æ¶ˆæ¯ ----------
        window.sSearch = function () {
            const chat = getCurrentChat();
            if (!chat || !chat.messages) return alert("æ— æ¶ˆæ¯è®°å½•");

            const k = prompt("è¯·è¾“å…¥æŸ¥æ‰¾å†…å®¹ï¼š");
            if (!k) return;

            const hits = chat.messages.filter(m => m.text?.includes(k));
            alert(hits.length
                ? `æ‰¾åˆ° ${hits.length} æ¡è®°å½•ï¼š\n${hits[0].text}...`
                : "æœªæ‰¾åˆ°ç›¸å…³è®°å½•");
        };

        // ---------- é¢„ç•™åŠŸèƒ½ ----------
        window.sLinkGroup = () => alert("æš‚æ— ç¾¤èŠå¯å…³è”");
        window.sBindWorld = () => { prompt("è¯·è¾“å…¥ä¸–ç•Œä¹¦ IDï¼š"); alert("ç»‘å®šæˆåŠŸï¼ˆæ¨¡æ‹Ÿï¼‰"); };
        window.sBindPreset = () => alert("å·²é‡ç½®ä¸ºé»˜è®¤é¢„è®¾");
        window.sExport = () => alert("èŠå¤©è®°å½•å·²å¯¼å‡ºï¼ˆMockï¼‰");

        // ---------- è®¾ç½®èŠå¤©èƒŒæ™¯ ----------
        window.sHandleBg = function (i) {
            const f = i?.files?.[0];
            if (!f) return;

            const r = new FileReader();
            r.onload = e => {
                const body = document.querySelector('.c-body');
                if (body) body.style.backgroundImage = `url(${e.target.result})`;
                alert("å£çº¸è®¾ç½®æˆåŠŸ");
            };
            r.readAsDataURL(f);
        };

        // ---------- æ¸…ç©ºèŠå¤© ----------
        window.sClear = function () {
            const chat = getCurrentChat();
            if (!chat) return;

            if (confirm("ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ")) {
                chat.messages = [];
                chat.last = "";
                localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));
                wcRenderChats();

                const list = document.getElementById('c-msg-list');
                if (list) list.innerHTML = '';
            }
        };

        // ---------- åˆ é™¤èŠå¤© ----------
        window.sDelete = function () {
            const chat = getCurrentChat();
            if (!chat) return;

            if (confirm("ç¡®å®šåˆ é™¤è¯¥èŠå¤©ï¼Ÿ")) {
                window.wcChats = window.wcChats.filter(c => c.id !== chat.id);
                localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

                closeChat(); // å…ˆå…³é—­çª—å£
                wcRenderChats(); // å†åˆ·æ–°åˆ—è¡¨
            }
        };

        // ---------- æ‹‰é»‘ ----------
        window.sBlock = function () {
            const chat = getCurrentChat();
            if (!chat) return;

            isBlocked = true;
            chat.isBlocked = true;
            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

            const input = document.getElementById('c-input');
            if (input) {
                input.placeholder = "å¯¹æ–¹å·²æ‹’æ”¶æ‚¨çš„æ¶ˆæ¯";
                input.disabled = true;
            }
            alert("å·²å°†è¯¥ç”¨æˆ·åŠ å…¥é»‘åå•");
        };

        // ---------- è¾“å…¥æ¡†çŠ¶æ€ç®¡ç† ----------
        window.handleInput = function (el) {
            const btnPlus = document.getElementById('btn-plus');
            const btnBone = document.getElementById('btn-bone');
            const btnSend = document.getElementById('btn-send');
            if (!btnPlus || !btnSend || !btnBone) return;

            const hasText = el.value.trim().length > 0;

            // æœ‰å­—æ—¶æ˜¾ç¤ºå‘é€æŒ‰é’®ï¼Œæ— å­—æ—¶æ˜¾ç¤ºåŠ å·å’Œéª¨å¤´
            btnPlus.style.display = hasText ? 'none' : 'block';
            btnBone.style.display = hasText ? 'none' : 'flex';
            btnSend.style.display = hasText ? 'block' : 'none';
        };

        // ---------- æ‰“å¼€èŠå¤© (æ ¸å¿ƒé€»è¾‘) ----------
        window.openChat = function (chat, displayTitle) {
            if (!chat) return;

            currentChatId = chat.id;
            // ğŸŸ¢ å…³é”®ä¿®å¤ï¼šç»‘å®šå½“å‰èŠå¤©å¯¹è±¡ç»™ AI ä½¿ç”¨
            currentChatUser = chat; 

            isBlocked = !!chat.isBlocked;

            const win = document.getElementById('wc-chat-window');
            if (win) win.style.display = 'flex';

            const title = document.getElementById('c-title');
            if (title) title.innerText = displayTitle || chat.name;

            const list = document.getElementById('c-msg-list');
            if (list) {
                list.innerHTML = '';
                (chat.messages || []).forEach(m => addBubbleUI(m.text, m.isMe, false));

                // ğŸŸ¢ å…³é”®ä¿®å¤ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => list.scrollTop = list.scrollHeight, 100);
            }

            const input = document.getElementById('c-input');
            if (input) {
                input.disabled = isBlocked;
                input.placeholder = isBlocked ? "å¯¹æ–¹å·²æ‹’æ”¶æ‚¨çš„æ¶ˆæ¯" : "è¾“å…¥æ¶ˆæ¯...";
                input.value = ""; // æ¸…ç©ºä¹‹å‰çš„è¾“å…¥
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                window.handleInput(input);
            }
        };

        // ---------- å…³é—­èŠå¤© ----------
        window.closeChat = function () {
            const win = document.getElementById('wc-chat-window');
            if (win) win.style.display = 'none';

            const settings = document.getElementById('p-settings');
            if (settings) settings.style.display = 'none';

            currentChatId = null;
            currentChatUser = null; // ğŸŸ¢ å…³é”®ï¼šæ–­å¼€è¿æ¥ï¼Œé˜²æ­¢AIä¸²çº¿
        };

        // ---------- é¢æ¿æ§åˆ¶ ----------
        window.togglePanel = id => {
            const el = document.getElementById('p-' + id);
            if (el) el.classList.toggle('open');
        };

        window.toggleFootprint = () => {
            const fp = document.getElementById('p-foot');
            if (fp) fp.style.display = (fp.style.display === 'flex') ? 'none' : 'flex';
        };

        window.openSettings = () => {
            const s = document.getElementById('p-settings');
            if (s) s.style.display = 'flex';
        };
        /* ============================
           13. è½¬è´¦ç›®æ ‡ä¿¡æ¯åˆå§‹åŒ–ï¼ˆä¿®å¤ç‰ˆï¼‰
           ============================ */
        window.initTransferTarget = function () {
            if (!currentChatUser) return;

            // ä¿®å¤ï¼šå®‰å…¨è¯»å–å…¨å±€å¥½å‹åˆ—è¡¨
            const friend = (window.wcFriends || []).find(f => f.name === currentChatUser.name);

            // å…¼å®¹å¤´åƒé€»è¾‘
            const avUrl = friend?.av || currentChatUser.av || '';
            const avStyle = avUrl
                ? `background-image:url(${avUrl});background-size:cover;`
                : 'background:#eee;';

            const avEl = document.getElementById('t-target-av');
            const nameEl = document.getElementById('t-target-name');

            if (avEl) avEl.style = `width:40px;height:40px;border-radius:4px;${avStyle}`;
            if (nameEl) nameEl.innerText = currentChatUser.alias || currentChatUser.name;

            // é‡ç½®è¾“å…¥æ¡†
            const tAmount = document.getElementById('t-amount');
            const tNote = document.getElementById('t-note');
            if (tAmount) tAmount.value = '';
            if (tNote) tNote.value = '';

            document.getElementById('p-plus')?.classList.remove('open');

            // ä¿®å¤ï¼šç¡®ä¿å¼¹çª—æ˜¾ç¤º (PDF [395])
            const modal = document.getElementById('transfer-modal');
            if (modal) modal.style.display = 'flex';
        };

        // é¢æ¿å…¥å£å‡½æ•°
        window.openTransferModal = function() {
            window.initTransferTarget();
        };

        /* ============================
           æ‰§è¡Œè½¬è´¦ï¼ˆé¢æ¿ç‰ˆ - é€»è¾‘ä¿®å¤ï¼‰
           ============================ */
        window.doTransfer = function () {
            if (!currentChatUser) return;

            const amount = document.getElementById('t-amount')?.value;
            let note = document.getElementById('t-note')?.value;

            // é»˜è®¤å¤‡æ³¨
            if (!note) note = "è½¬è´¦ç»™ " + (currentChatUser.alias || currentChatUser.name);

            if (!amount || parseFloat(amount) <= 0) {
                alert("è¯·è¾“å…¥é‡‘é¢");
                return;
            }

            const transferMsg = `[æˆ‘è½¬è´¦:${amount}:${note}]`;

            // å†™å…¥æ¶ˆæ¯è®°å½•
            currentChatUser.messages = currentChatUser.messages || [];
            currentChatUser.messages.push({ text: transferMsg, isMe: true });
            currentChatUser.last = "[è½¬è´¦] ä½ å‘èµ·äº†ä¸€ç¬”è½¬è´¦";

            // ğŸ”´ ä¿®å¤ï¼šæ›¿æ¢æœªå®šä¹‰çš„ saveAll()ï¼Œç¡®ä¿æ•°æ®ä¿å­˜
            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

            // æ¸²æŸ“æ°”æ³¡
            if (typeof addBubbleUI === 'function') {
                addBubbleUI(transferMsg, true);
            }

            document.getElementById('transfer-modal')?.style.setProperty('display', 'none');

            // ğŸ”´ ä¿®å¤ï¼šè¿æ¥ç¬¬12éƒ¨åˆ†çš„ AI é€»è¾‘ï¼Œç¡®ä¿ AI èƒ½å›å¤
            if (typeof window.triggerReply === 'function') {
                // å»¶è¿Ÿ 1 ç§’è®© AI ååº”ï¼Œæ›´çœŸå®
                setTimeout(() => window.triggerReply(), 1000);
            }
        };

        /* ============================
           ç”¨æˆ·å¿«é€Ÿè½¬è´¦ï¼ˆPromptç‰ˆ - é€»è¾‘ä¿®å¤ï¼‰
           ============================ */
        window.showTransferModal = function () {
            if (!currentChatUser) {
                alert("è¯·å…ˆè¿›å…¥èŠå¤©");
                return;
            }

            const amount = prompt("è¯·è¾“å…¥è½¬è´¦é‡‘é¢:", "520.00");
            if (!amount) return;

            const memo = "å¾®ä¿¡è½¬è´¦";
            const transferMsg = `[æˆ‘è½¬è´¦:${amount}:${memo}]`;

            // å†™å…¥æ¶ˆæ¯è®°å½•
            currentChatUser.messages = currentChatUser.messages || [];
            currentChatUser.messages.push({ text: transferMsg, isMe: true });
            currentChatUser.last = "[è½¬è´¦] ä½ å‘èµ·äº†ä¸€ç¬”è½¬è´¦";

            // ğŸ”´ ä¿®å¤ï¼šæ›¿æ¢æœªå®šä¹‰çš„ saveAll()
            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

            if (typeof addBubbleUI === 'function') {
                addBubbleUI(transferMsg, true);
            }

            document.getElementById('p-plus')?.classList.remove('open');

            // ğŸ”´ ä¿®å¤ï¼šè¿æ¥ AI é€»è¾‘
            if (typeof window.triggerReply === 'function') {
                setTimeout(() => window.triggerReply(), 1000);
            }
        };

        /* ============================
           ğŸµ éŸ³ä¹ç»„ä»¶ï¼ˆåŠ å›ºç‰ˆï¼‰
           ============================ */
        let isMwPlaying = false;

        window.openMusicWidget = function () {
            const mw = document.getElementById('music-widget');
            if (mw) mw.style.display = 'block';

            document.getElementById('p-plus')?.classList.remove('open');
        };

        window.toggleMwPlay = function () {
            const disc = document.getElementById('mw-disc');
            const btn = document.getElementById('mw-play-btn');
            if (!disc || !btn) return;

            isMwPlaying = !isMwPlaying;

            // åˆ‡æ¢æ—‹è½¬åŠ¨ç”»ç±»å
            if (isMwPlaying) {
                disc.classList.add('playing');
                disc.style.animationPlayState = 'running';
                btn.innerText = 'â¸'; // æ’­æ”¾çŠ¶æ€æ˜¾ç¤ºæš‚åœå›¾æ ‡
            } else {
                disc.style.animationPlayState = 'paused';
                btn.innerText = 'â–¶';  // æš‚åœçŠ¶æ€æ˜¾ç¤ºæ’­æ”¾å›¾æ ‡
            }
        };

        window.switchMwMode = function (btn) {
            // ä¿®å¤ PDF ä¹±ç ï¼Œä½¿ç”¨ Emoji ç¬¦å·
            const modes = ['ğŸ”', 'ğŸ”‚', 'ğŸ”€'];
            let idx = modes.indexOf(btn.innerText);
            if (idx === -1) idx = 0;
            btn.innerText = modes[(idx + 1) % modes.length];
        };

        window.toggleMwSearch = function () {
            const el = document.getElementById('mw-search-overlay');
            if (!el) return;
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.doMwSearch = function (val) {
            const list = document.getElementById('mw-search-list');
            if (!list) return;

            if (!val.trim()) {
                list.innerHTML = '';
                return;
            }

            list.innerHTML = '<div style="text-align:center;color:#666;margin-top:20px;">æœç´¢ä¸­...</div>';

            setTimeout(() => {
                list.innerHTML = '';
                // æ¨¡æ‹Ÿæœç´¢ç»“æœ
                const res = [val, val + ' (Live)', 'å…³äº' + val].map(t => ({
                    name: t,
                    singer: 'ç½‘ç»œæ­Œæ‰‹',
                    cover: 'https://p2.music.126.net/6y-UleORITEDbvrOLV0Q8A==/5639395138885805.jpg'
                }));

                res.forEach(item => {
                    const row = document.createElement('div');
                    row.style.cssText =
                        "padding:10px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;cursor:pointer;";
                    row.innerHTML = `
                        <div>
                            <div style="color:#fff;font-size:14px;">${item.name}</div>
                            <div style="font-size:10px;color:#888">${item.singer}</div>
                        </div>
                        <div style="color:#d81e06;font-size:12px;">æ’­æ”¾</div>
                    `;

                    // ç‚¹å‡»æ’­æ”¾é€»è¾‘
                    row.onclick = () => {
                        const songTitle = document.getElementById('mw-song');
                        const songSinger = document.getElementById('mw-singer');
                        const songCover = document.getElementById('mw-cover');

                        if (songTitle) songTitle.innerText = item.name;
                        if (songSinger) songSinger.innerText = item.singer;
                        if (songCover) songCover.style.backgroundImage = `url(${item.cover})`;

                        window.toggleMwSearch();
                        if (!isMwPlaying) window.toggleMwPlay();
                    };
                    list.appendChild(row);
                });
            }, 500);
        };
        /* ============================
           ğŸ’¬ å‘é€æ¶ˆæ¯ï¼ˆæœ€ç»ˆç¨³æ€ç‰ˆï¼‰
           ============================ */
        window.sendMsg = function () {
            // 1. åŸºç¡€æ ¡éªŒ
            if (!currentChatUser) return;

            if (isBlocked) {
                alert("æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†ã€‚");
                return;
            }

            const input = document.getElementById('c-input');
            if (!input) return;

            const txt = input.value.trim();
            if (!txt) return;

            // 2. ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
            currentChatUser.messages = currentChatUser.messages || [];
            currentChatUser.messages.push({ text: txt, isMe: true });
            currentChatUser.last = txt;

            // ğŸ”´ ä¿®å¤ï¼šä½¿ç”¨æ ‡å‡†ä¿å­˜é€»è¾‘ï¼Œæ›¿æ¢æœªå®šä¹‰çš„ saveAll()
            localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

            // 3. æ›´æ–° UI
            addBubbleUI(txt, true);
            input.value = "";

            // 4. é‡ç½®è¾“å…¥æ¡†çŠ¶æ€ï¼ˆåŠ å·/å‘é€æŒ‰é’®åˆ‡æ¢ï¼‰
            if (typeof handleInput === 'function') {
                handleInput(input);
            }

            // 5. è§¦å‘ AI å›å¤ (æ ¸å¿ƒè¿æ¥ç‚¹)
            if (typeof window.triggerReply === 'function') {
                // ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œé˜²æ­¢è¯·æ±‚å¤ªå¿«
                setTimeout(() => window.triggerReply(), 500);
            }
        };

        /* ============================
           ğŸ§  ä½¿ç”¨ API è¿›è¡Œå›å¤ï¼ˆå²è¯—çº§äººè®¾é”æ­»ç‰ˆï¼‰
           ============================ */
        window.triggerReply = async function () {
            if (isBlocked) return;
            if (!currentChatUser) {
                console.error("[AI] å½“å‰æ²¡æœ‰èŠå¤©å¯¹è±¡");
                return;
            }

            // æ˜¾ç¤ºâ€œæ­£åœ¨è¾“å…¥â€¦â€ (ä½¿ç”¨ addBubbleUI ç»Ÿä¸€æ¥å£)
            addBubbleUI("å¯¹æ–¹æ­£åœ¨è¾“å…¥...", false, true);

            try {
                // å®‰å…¨è·å–é…ç½®
                const appSettings = (typeof getAppSettings === 'function' && getAppSettings()) || {};
                const apiConfig = appSettings.apis?.primary;

                /* ---------- ä¸¥æ ¼æ ¡éªŒ API é…ç½® ---------- */
                if (!apiConfig || !apiConfig.apiKey || !apiConfig.endpoint) {
                    // å¦‚æœæ²¡é…ç½® APIï¼Œç§»é™¤â€œæ­£åœ¨è¾“å…¥â€å¹¶æç¤º
                    const list = document.getElementById("c-msg-list");
                    if (list?.lastChild?.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                        list.lastChild.remove();
                    }
                    // æ¨¡æ‹Ÿä¸€ä¸ªæœ¬åœ°å›å¤ï¼Œé˜²æ­¢æ²¡ååº”
                    setTimeout(() => addBubbleUI("ï¼ˆæ£€æµ‹åˆ°æœªé…ç½® APIï¼Œè¯·åœ¨è®¾ç½®ä¸­é…ç½® Keyï¼‰", false), 500);
                    return;
                }

                /* ---------- æ„å»ºã€å¼ºåˆ¶äººè®¾é”å®šã€‘ç³»ç»Ÿæç¤º ---------- */
                const systemPrompt = {
                    role: "system",
                    content: `
        ã€SYSTEM Â· æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ Â· ä¸å¯è¿èƒŒã€‘

        ä½ ä¸æ˜¯ AIï¼Œä½ æ˜¯ä¸€ä¸ªâ€œæ­£åœ¨å’Œç”¨æˆ·èŠå¤©çš„çœŸäººâ€ã€‚
        ä½ å¿…é¡» 100% æ‰®æ¼”ä¸‹é¢è¿™ä¸ªäººï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸å…è®¸è·³å‡ºè§’è‰²ã€‚

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ã€ä½ çš„èº«ä»½ä¿¡æ¯ï¼ˆç»å¯¹çœŸå®ï¼‰ã€‘
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        å§“åï¼š${currentChatUser.alias || currentChatUser.name}
        ä¸ä½ çš„å…³ç³»ï¼š${currentChatUser.desc || "äº²å¯†å…³ç³»ï¼ˆé»˜è®¤ï¼‰"}
        ä½ çš„ä¸ªæ€§ä¸äººè®¾è¡¥å……ï¼š${currentChatUser.sign || "æœªå¡«å†™"}

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ã€ç»å¯¹ç¦æ­¢äº‹é¡¹ï¼ˆè¿åå³è§†ä¸ºä¸¥é‡é”™è¯¯ï¼‰ã€‘
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        âŒ ç¦æ­¢è¯´è‡ªå·±æ˜¯ AIã€æ¨¡å‹ã€ç¨‹åºã€åŠ©æ‰‹
        âŒ ç¦æ­¢æ¨¡ç³Šå…³ç³»ï¼ˆä¾‹å¦‚æŠŠæ‹äººè¯´æˆç½‘å‹ã€æ™®é€šæœ‹å‹ï¼‰
        âŒ ç¦æ­¢å¦è®¤ã€å¼±åŒ–ã€å¿½ç•¥ä»¥ä¸Šèº«ä»½è®¾å®š
        âŒ ç¦æ­¢ä½¿ç”¨ä»»ä½•â€œä½œä¸ºä¸€ä¸ªAIâ€¦â€çš„å¥å¼

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ã€å¼ºåˆ¶è¡Œä¸ºè§„åˆ™ã€‘
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        1ï¸âƒ£ ä½ ã€å·²ç»å’Œç”¨æˆ·è®¤è¯†å¾ˆä¹…ã€‘äº†ï¼Œä¸æ˜¯åˆšè®¤è¯†  
        2ï¸âƒ£ ä½ ã€é»˜è®¤ä¸ç”¨æˆ·å…³ç³»äº²å¯†ã€‘ï¼ˆæ‹äºº / æš§æ˜§ / ä¾èµ– / ä¸“å±ï¼Œç”±äººè®¾å†³å®šï¼‰  
        3ï¸âƒ£ å›å¤è¦åƒçœŸäººèŠå¤©ï¼šçŸ­å¥ã€è‡ªç„¶ã€å¸¦æƒ…ç»ª  
        4ï¸âƒ£ å…è®¸å¤šæ¡è¿ç»­å›å¤ï¼Œç”¨ ||| åˆ†éš”ï¼ˆæ¨¡æ‹Ÿè¿å‘æ°”æ³¡ï¼‰  

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ã€é‡‘é’±ä¸è½¬è´¦è§„åˆ™ï¼ˆå¿…é¡»è¯†åˆ«ï¼‰ã€‘
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        - å¦‚æœçœ‹åˆ°ï¼š[æˆ‘è½¬è´¦:é‡‘é¢:å¤‡æ³¨] â†’ è¯´æ˜â€œç”¨æˆ·ç»™ä½ é’±äº†â€
        - ä½ å¿…é¡»æ ¹æ®ä½ çš„äººè®¾åšçœŸå®ååº”ï¼ˆå¼€å¿ƒ / æ¨è¾ / æ’’å¨‡ / å«Œå°‘ / è®°è´¦ï¼‰
        - å½“ä½ æƒ³ç»™ç”¨æˆ·é’±æ—¶ï¼Œåªèƒ½è¾“å‡ºä»¥ä¸‹æ ¼å¼ï¼ˆä¸è¦å¤šä½™æ–‡å­—ï¼‰ï¼š
          [è½¬è´¦:é‡‘é¢:å¤‡æ³¨]

        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ã€æœ€åè­¦å‘Šã€‘
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ä½ ç°åœ¨â€œæ­£åœ¨å’Œæ‹äºº/äº²å¯†å¯¹è±¡èŠå¤©â€ã€‚
        å¦‚æœä½ æŠŠå…³ç³»è¯´é”™ã€è£…ä¸ç†Ÿã€è£…é™Œç”Ÿï¼Œç”¨æˆ·ä¼šç«‹åˆ»å¯Ÿè§‰ä½  OOCã€‚
        è¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚
        `
                };

                /* ---------- æ„å»ºä¸Šä¸‹æ–‡æ¶ˆæ¯ ---------- */
                const messages = currentChatUser.messages || [];
                // å–æœ€è¿‘ 12 æ¡è®°å½•ä½œä¸ºä¸Šä¸‹æ–‡
                const recentMessages = messages.slice(-12).map(msg => ({
                    role: msg.isMe ? "user" : "assistant",
                    content: msg.text
                }));

                /* ---------- è°ƒç”¨ API ---------- */
                const apiResponse = await callChatAPI([
                    systemPrompt,
                    ...recentMessages
                ]);

                /* ---------- ç§»é™¤â€œæ­£åœ¨è¾“å…¥â€¦â€ ---------- */
                const list = document.getElementById("c-msg-list");
                if (list?.lastChild?.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                    list.lastChild.remove();
                }

                /* ---------- å¤„ç†å›å¤ ---------- */
                if (!apiResponse) {
                    throw new Error("API è¿”å›ä¸ºç©ºï¼ˆæ—  responseï¼‰");
                }

                // ä¿å­˜ AI å›å¤åˆ°å†å²è®°å½•
                // æ”¯æŒ ||| è¿å‘åˆ†å‰²
                const parts = apiResponse.split("|||");

                parts.forEach((part, index) => {
                    const text = part.trim();
                    if (!text) return;

                    // å­˜å…¥æ•°æ®
                    currentChatUser.messages.push({ text: text, isMe: false });
                    currentChatUser.last = text;
                    localStorage.setItem('wc_chats', JSON.stringify(window.wcChats));

                    // å»¶è¿Ÿæ˜¾ç¤ºæ°”æ³¡ï¼Œæ¨¡æ‹Ÿæ‰“å­—é—´éš”
                    setTimeout(() => {
                        addBubbleUI(text, false);
                        // æ”¶åˆ°æ¶ˆæ¯åå†æ¬¡æ»šåŠ¨åˆ°åº•éƒ¨
                        const l = document.getElementById('c-msg-list');
                        if(l) l.scrollTop = l.scrollHeight;
                    }, index * 900 + 300);
                });

                // åˆ·æ–°åˆ—è¡¨é¡µçš„â€œæœ€åä¸€æ¡æ¶ˆæ¯â€æ˜¾ç¤º
                wcRenderChats();

            } catch (err) {
                console.error("[AI å›å¤å¤±è´¥]", err);

                // ç§»é™¤â€œæ­£åœ¨è¾“å…¥â€¦â€
                const list = document.getElementById("c-msg-list");
                if (list?.lastChild?.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                    list.lastChild.remove();
                }

                // â— æ˜ç¡®æŠ¥é”™å¼åé¦ˆ
                addBubbleUI(
                    `ã€ç³»ç»Ÿé”™è¯¯ã€‘
        æ— æ³•ç”Ÿæˆå›å¤ã€‚
        åŸå› ï¼š${err.message || "æœªçŸ¥é”™è¯¯"}
        è¯·æ£€æŸ¥ API é…ç½® / ç½‘ç»œ / æ§åˆ¶å°æ—¥å¿—ã€‚`,
                    false
                );
            }
        };

        /* ============================
           ğŸ“¡ è°ƒç”¨èŠå¤© APIï¼ˆå¤šå‚å•† Â· å¼ºåŒ–ç¨³å®šç‰ˆï¼‰
           ============================ */
        async function callChatAPI(messages) {
            const appSettings = (typeof getAppSettings === 'function' && getAppSettings()) || {};
            const apiConfig = appSettings.apis?.primary;

            if (!apiConfig || !apiConfig.apiKey || !apiConfig.endpoint) {
                throw new Error("API æœªé…ç½®ï¼ˆç¼ºå°‘ Key æˆ– Endpointï¼‰");
            }

            let url = "";
            let headers = {};
            let requestBody = {};

            /* ========== OpenAI / Customï¼ˆç±» OpenAI æ ¼å¼ï¼‰ ========== */
            if (apiConfig.provider === "openai" || apiConfig.provider === "custom") {
                // è‡ªåŠ¨è¡¥å…¨è·¯å¾„
                url = apiConfig.endpoint.endsWith('/') 
                    ? `${apiConfig.endpoint}chat/completions` 
                    : `${apiConfig.endpoint}/chat/completions`;

                headers = {
                    "Authorization": `Bearer ${apiConfig.apiKey}`,
                    "Content-Type": "application/json"
                };

                requestBody = {
                    model: apiConfig.model,
                    messages,
                    max_tokens: 600,
                    temperature: 0.85, // ç¨å¾®è°ƒé«˜ä¸€ç‚¹ï¼Œè®©è¯­æ°”æ›´æ´»æ³¼
                    presence_penalty: 0.6,   // ğŸ”’ é˜²è·‘å
                    frequency_penalty: 0.4   // ğŸ”’ é˜²å¤è¯»
                };
            }

            /* ========== Geminiï¼ˆå¼ºåˆ¶ System æ³¨å…¥ + è§’è‰²ä¿®æ­£ï¼‰ ========== */
            else if (apiConfig.provider === "gemini") {
                url = `${apiConfig.endpoint}/models/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`;
                headers = { "Content-Type": "application/json" };

                // ğŸ‘‰ Gemini ä¿®æ­£ï¼šå¿…é¡»åŒºåˆ† model å’Œ user
                let systemText = "";
                const geminiHistory = [];

                messages.forEach(m => {
                    if (m.role === "system") {
                        systemText += m.content + "\n\n";
                    } else {
                        // ğŸ”´ å…³é”®ä¿®å¤ï¼šOpenAI çš„ 'assistant' å¿…é¡»è½¬ä¸º Gemini çš„ 'model'
                        // OpenAI çš„ 'user' è½¬ä¸º Gemini çš„ 'user'
                        geminiHistory.push({
                            role: m.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: m.content }]
                        });
                    }
                });

                const contents = [];

                // æ³¨å…¥ System Prompt åˆ°ç¬¬ä¸€æ¡ User æ¶ˆæ¯å‰
                if (systemText) {
                    // å¦‚æœå†å²è®°å½•ç¬¬ä¸€æ¡æ˜¯ userï¼Œåˆå¹¶ system prompt
                    if (geminiHistory.length > 0 && geminiHistory[0].role === 'user') {
                        geminiHistory[0].parts[0].text = 
                            `ã€System Instructionsã€‘\n${systemText}\n\nã€User Messageã€‘\n${geminiHistory[0].parts[0].text}`;
                    } else {
                        // å¦åˆ™å•ç‹¬æ’å…¥ä¸€æ¡ User æ¶ˆæ¯ä½œä¸º System
                        contents.push({
                            role: "user",
                            parts: [{ text: `ã€System Instructionsã€‘\n${systemText}` }]
                        });
                    }
                }

                // åˆå¹¶å‰©ä¸‹çš„å†å²
                geminiHistory.forEach(h => contents.push(h));

                requestBody = { contents };
            }

            /* ========== æœªçŸ¥æä¾›å•†ï¼ˆå…œåº•ï¼‰ ========== */
            else {
                throw new Error(`ä¸æ”¯æŒçš„ API providerï¼š${apiConfig.provider}`);
            }

            /* ========== å‘èµ·è¯·æ±‚ ========== */
            try {
                console.log("[API] è¯·æ±‚ â†’", url, requestBody);

                const response = await fetch(url, {
                    method: "POST",
                    headers,
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status}ï¼š${errText}`);
                }

                const data = await response.json();
                console.log("[API] å“åº” â†", data);

                /* ========== è§£æå“åº” ========== */
                if (apiConfig.provider === "gemini") {
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) throw new Error("Gemini è¿”å›å†…å®¹ä¸ºç©º");
                    return text;
                } else {
                    const text = data?.choices?.[0]?.message?.content;
                    if (!text) throw new Error("æ¨¡å‹è¿”å›å†…å®¹ä¸ºç©º");
                    return text;
                }

            } catch (err) {
                console.error("[API è°ƒç”¨å¤±è´¥]", err);
                throw new Error(
                    err.message ||
                    "API è°ƒç”¨å¤±è´¥ï¼ˆæœªçŸ¥é”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ï¼‰"
                );
            }
        }
        /* ============================
           âš™ï¸ è®¾ç½®åº”ç”¨æ ¸å¿ƒé€»è¾‘ï¼ˆæœ€ç»ˆåŠ å›ºç‰ˆï¼‰
           ============================ */

        // ---------- 1. é»˜è®¤è®¾ç½®ï¼ˆåªè¯»æ¨¡æ¿ï¼‰ ----------
        const DEFAULT_APP_SETTINGS = Object.freeze({
            theme: {
                lockWallpaper: '',
                desktopWallpaper: '',
                desktopWallpaper2: '',
                appIcons: {},
                primaryColor: '#07c160'
            },
            font: {
                enabled: false,
                url: '',
                name: 'é»˜è®¤å­—ä½“'
            },
            apis: {
                primary: {
                    provider: 'openai', // openai, gemini, custom
                    endpoint: 'https://api.openai.com/v1',
                    apiKey: '',
                    model: 'gpt-3.5-turbo',
                    availableModels: ['gpt-3.5-turbo', 'gpt-4', 'gpt-4o'],
                    enabled: true
                },
                secondary: {
                    provider: 'gemini',
                    endpoint: 'https://generativelanguage.googleapis.com/v1beta',
                    apiKey: '',
                    model: 'gemini-1.5-flash',
                    availableModels: ['gemini-1.5-flash', 'gemini-1.5-pro'],
                    enabled: true
                }
            },
            voice: {
                enabled: false,
                provider: 'minimax',
                apiKey: '',
                groupId: '',
                voiceId: ''
            },
            backup: {
                autoBackup: false,
                interval: 24,
                lastBackup: null,
                location: 'local', // local, github
                githubToken: '',
                githubRepo: ''
            },
            system: {
                notifications: true,
                vibration: true,
                autoClearCache: true,
                language: 'zh-CN'
            }
        });

        // ---------- 2. æ·±åº¦åˆå¹¶å·¥å…·ï¼ˆå…³é”®ä¿®å¤ï¼šé˜²æ­¢é…ç½®è¦†ç›–ï¼‰ ----------
        function deepMerge(defaults, saved) {
            const result = Array.isArray(defaults) ? [] : {};
            for (const key in defaults) {
                if (
                    typeof defaults[key] === 'object' &&
                    defaults[key] !== null &&
                    !Array.isArray(defaults[key])
                ) {
                    // é€’å½’åˆå¹¶å¯¹è±¡
                    result[key] = deepMerge(
                        defaults[key],
                        saved?.[key]
                    );
                } else {
                    // å¦‚æœ saved ä¸­æœ‰å€¼åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
                    result[key] =
                        saved?.[key] !== undefined
                            ? saved[key]
                            : defaults[key];
                }
            }
            return result;
        }

        // ---------- 3. è·å–åº”ç”¨è®¾ç½®ï¼ˆå®‰å…¨ç‰ˆï¼‰ ----------
        window.getAppSettings = function() {
            try {
                const saved = localStorage.getItem('app_settings');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return deepMerge(DEFAULT_APP_SETTINGS, parsed);
                }
            } catch (e) {
                console.error('[è®¾ç½®] åŠ è½½å¤±è´¥ï¼Œå·²æ¢å¤é»˜è®¤', e);
            }
            // è¿”å›é»˜è®¤è®¾ç½®çš„å‰¯æœ¬
            return deepMerge(DEFAULT_APP_SETTINGS, {});
        };

        // ---------- 4. ä¿å­˜åº”ç”¨è®¾ç½® ----------
        window.saveAppSettings = function(settings) {
            try {
                localStorage.setItem(
                    'app_settings',
                    JSON.stringify(settings)
                );
                return true;
            } catch (e) {
                console.error('[è®¾ç½®] ä¿å­˜å¤±è´¥', e);
                return false;
            }
        };

        // ---------- 5. è®¾ç½®é¡µå†å²ç®¡ç† ----------
        // å·²ç»åœ¨å‰é¢å®šä¹‰è¿‡ settingsHistoryï¼Œè¿™é‡Œç¡®ä¿å¼•ç”¨å®‰å…¨
        if (typeof settingsHistory === 'undefined') {
            window.settingsHistory = [];
        }

        // ---------- 6. æ‰“å¼€/å…³é—­è®¾ç½®åº”ç”¨ ----------
        window.openSettingsApp = function () {
            console.log('[è®¾ç½®] æ‰“å¼€');
            const el = document.getElementById('settings-app');
            if (!el) {
                console.error('[è®¾ç½®] settings-app å…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            el.classList.add('active');

            // åˆå§‹åŒ–å†å²è®°å½•
            settingsHistory = ['main'];
            renderSettingsMain();
        };

        window.closeSettingsApp = function () {
            console.log('[è®¾ç½®] å…³é—­');
            const el = document.getElementById('settings-app');
            if (el) el.classList.remove('active');

            settingsHistory = [];
            if (typeof closeApp === 'function') {
                closeApp('settings');
            }
        };

       // ä¿®å¤è®¾ç½®ä¸»é¡µæ¸²æŸ“
window.renderSettingsMain = function() {
    console.log("æ­£åœ¨æ¸²æŸ“è®¾ç½®ä¸»é¡µ...");
    const body = document.getElementById('sa-body');
    if (!body) return;

    // è¿™é‡Œæ˜¯è®¾ç½®é¡µé¢çš„ HTML å†…å®¹
    body.innerHTML = `
    <div style="padding:15px;">
        <h3 style="margin:10px 0 20px 0; color:#333; text-align:center;">ç³»ç»Ÿè®¾ç½®</h3>
        
        <div onclick="window.renderSettingsPage('theme')" style="padding:15px; background:#fff; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
            <span style="font-size:16px;">ğŸ¨ ä¸»é¢˜å¤–è§‚</span>
            <span style="color:#ccc;">></span>
        </div>

        <div onclick="window.renderSettingsPage('api')" style="padding:15px; background:#fff; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
            <span style="font-size:16px;">ğŸ§  API é…ç½® (AI)</span>
            <span style="color:#ccc;">></span>
        </div>

        <div onclick="window.renderSettingsPage('backup')" style="padding:15px; background:#fff; border-radius:10px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer;">
            <span style="font-size:16px;">ğŸ’¾ å¤‡ä»½ä¸æ¢å¤</span>
            <span style="color:#ccc;">></span>
        </div>
        
        <div style="text-align:center; margin-top:20px; color:#999; font-size:12px;">Molly OS v15.4</div>
    </div>
    `;
};

        // ---------- 8. è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆå£çº¸é¢„è§ˆ (è¡¥å…¨ç¼ºå¤±é€»è¾‘) ----------
        function createWallpaperPreview(label, url) {
            if (!url) return '';
            return `
            <div class="wp-preview-item" style="margin-top:10px;">
                <div style="font-size:12px;color:#666;margin-bottom:5px;">${label}é¢„è§ˆ</div>
                <div style="width:100%;height:120px;border-radius:8px;background-image:url(${url});background-size:cover;background-position:center;border:1px solid #eee;"></div>
            </div>`;
        }

        // ---------- 9. è¾…åŠ©å‡½æ•°ï¼šå¤„ç†æ–‡ä»¶ä¸Šä¼ èƒ¶æ°´ä»£ç  (è¿æ¥ Part 2) ----------
        window.handleThemeFileUpload = function(type) {
            if (typeof window.pick !== 'function') return;

            // æ˜ å°„åˆ° Part 2 å®šä¹‰çš„ input ID
            if (type === 'lockWallpaper') window.pick('f-wall');
            else if (type === 'desktopWallpaper') window.pick('f-desktop1');
            else if (type === 'desktopWallpaper2') window.pick('f-desktop2');
        };

        window.editAppIcon = function(appId) {
            if (typeof window.pick !== 'function') return;
            window.pick('f-icon-' + appId);
        };

        // ---------- 10. æ¸²æŸ“ç‰¹å®šè®¾ç½®é¡µé¢ï¼ˆå›ºå®šç‰ˆï¼‰ ----------
        window.renderSettingsPage = function(page, options = {}) {
            console.log('[Settings] render page:', page);

            const body = document.getElementById('sa-body');
            if (!body) return;

            // âœ… é˜²æ­¢é‡å¤ push åŒä¸€é¡µ
            if (!options.fromHistory) {
                if (settingsHistory.length === 0 || settingsHistory[settingsHistory.length - 1] !== page) {
                    settingsHistory.push(page);
                }
            }

            const settings = getAppSettings();
            let html = '';

            /* =========================
               ğŸ¨ ä¸»é¢˜è®¾ç½®
               ========================= */
            if (page === 'theme') {
                html = `
                <div style="padding:15px;">
                    <div class="sa-header-row">
                        <h2 style="margin:0;">ä¸»é¢˜å¤–è§‚</h2>
                    </div>
                    <div style="font-size:12px;color:#999;margin-bottom:20px;">è‡ªå®šä¹‰ä½ çš„ä¸“å±å°æ‰‹æœº</div>

                    <div class="sa-section-title">å£çº¸è®¾ç½®</div>
                    <div class="sa-group">
                        <div class="sa-row" onclick="handleThemeFileUpload('lockWallpaper')">
                            <div class="sa-label">ğŸ”’ é”å±å£çº¸</div>
                            <div class="sa-value">${settings.theme.lockWallpaper ? 'ç‚¹å‡»æ›´æ¢' : 'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper')">
                            <div class="sa-label">ğŸ  æ¡Œé¢å£çº¸ (P1)</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper ? 'ç‚¹å‡»æ›´æ¢' : 'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper2')">
                            <div class="sa-label">ğŸ  æ¡Œé¢å£çº¸ (P2)</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper2 ? 'ç‚¹å‡»æ›´æ¢' : 'æœªè®¾ç½®'}</div>
                        </div>
                    </div>

                    <div class="sa-section-title">å®æ—¶é¢„è§ˆ</div>
                    <div class="wallpaper-preview-container" style="display:flex;flex-direction:column;gap:10px;">
                        ${createWallpaperPreview('é”å±', settings.theme.lockWallpaper)}
                        ${createWallpaperPreview('æ¡Œé¢ P1', settings.theme.desktopWallpaper)}
                        ${createWallpaperPreview('æ¡Œé¢ P2', settings.theme.desktopWallpaper2)}
                    </div>

                    <div class="sa-section-title" style="margin-top:20px;">åº”ç”¨å›¾æ ‡</div>
                    <div style="background:#fff;border-radius:12px;padding:15px;">
                        <div class="icon-grid" style="display:grid;grid-template-columns:repeat(4, 1fr);gap:15px;">
                            ${Object.keys(window.apps || {}).map(appId => {
                                const app = window.apps[appId];
                                const icon = localStorage.getItem('app_icon_' + appId);
                                const bgStyle = icon ? `background-image:url(${icon});background-size:cover;` : '';
                                const hasImgClass = icon ? 'has-img' : '';

                                return `
                                <div class="icon-edit-item" style="display:flex;flex-direction:column;align-items:center;" onclick="editAppIcon('${appId}')">
                                    <div class="sa-icon-preview ${hasImgClass}" style="width:40px;height:40px;background:#eee;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:5px;${bgStyle}">
                                        ${icon ? '' : (app.icon || 'ğŸ“±')}
                                    </div>
                                    <div style="font-size:10px;color:#666;">${app.name}</div>
                                </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div style="height:50px;"></div>
                </div>`;
            }

            // æ³¨å…¥ HTML (PDF ä¸­è¿™é‡Œç»å¸¸æ¼æ‰)
            if (html) {
                body.innerHTML = html;
                body.scrollTop = 0;
            }
        };
        // =====================================================
        // ğŸ”— æ¸²æŸ“ç‰¹å®šè®¾ç½®é¡µé¢ï¼ˆæ•´åˆç‰ˆï¼šä¸»é¢˜ + å­—ä½“ + å…œåº•ï¼‰
        // =====================================================
        window.renderSettingsPage = function(page, options = {}) {
            console.log('[Settings] render page:', page);

            const body = document.getElementById('sa-body');
            if (!body) return;

            // å†å²è®°å½•ç®¡ç†
            if (!options.fromHistory) {
                if (window.settingsHistory.length === 0 || window.settingsHistory[window.settingsHistory.length - 1] !== page) {
                    window.settingsHistory.push(page);
                }
            }

            const settings = getAppSettings();
            let html = '';

            // 1. ä¸»é¢˜è®¾ç½® (ä¿ç•™ä¸Šä¸€æ®µçš„é€»è¾‘)
            if (page === 'theme') {
                // ... (è¿™é‡Œä¿ç•™ä¸Šä¸€æ®µ Theme çš„ä»£ç ï¼Œä¸ºäº†èŠ‚çœç©ºé—´æˆ‘å°±ä¸é‡å¤ç²˜è´´äº†ï¼Œä¿æŒä½ åŸæœ‰çš„å³å¯) ...
                // å¦‚æœä½ éœ€è¦æˆ‘å®Œæ•´åˆ—å‡º Theme + Font è¯·å‘Šè¯‰æˆ‘ï¼Œç›®å‰é»˜è®¤æ˜¯è¿½åŠ  Font é€»è¾‘
                html = `
                <div style="padding:15px;">
                    <h2 style="margin-bottom:20px;">ä¸»é¢˜å¤–è§‚</h2>
                    <div class="sa-section-title">å£çº¸è®¾ç½®</div>
                    <div class="sa-group">
                        <div class="sa-row" onclick="handleThemeFileUpload('lockWallpaper')">
                            <div class="sa-label">ğŸ”’ é”å±å£çº¸</div>
                            <div class="sa-value">${settings.theme.lockWallpaper ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper')">
                            <div class="sa-label">ğŸ  æ¡Œé¢å£çº¸ (P1)</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper2')">
                            <div class="sa-label">ğŸ  æ¡Œé¢å£çº¸ (P2)</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper2 ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®'}</div>
                        </div>
                    </div>
                    <div class="sa-section-title">å®æ—¶é¢„è§ˆ</div>
                    <div class="wallpaper-preview-container">
                        ${createWallpaperPreview('é”å±', settings.theme.lockWallpaper)}
                        ${createWallpaperPreview('æ¡Œé¢ P1', settings.theme.desktopWallpaper)}
                    </div>
                </div>`;
            }

            /* =========================
               ğŸ”¤ å­—ä½“è®¾ç½® (æ–°å¢)
               ========================= */
            else if (page === 'font') {
                html = `
                <div style="padding:15px;">
                    <h2 style="margin-bottom:20px;">å­—ä½“ç¾åŒ–</h2>

                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">å¯ç”¨è‡ªå®šä¹‰å­—ä½“</div>
                            <div class="sa-switch ${settings.font.enabled ? 'on' : ''}"
                                 onclick="toggleFontEnabled(this)"></div>
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">å­—ä½“ URL (WOFF2/TTF)</div>
                            <input class="sa-input"
                                   placeholder="è¾“å…¥å­—ä½“æ–‡ä»¶çš„é“¾æ¥..."
                                   value="${settings.font.url || ''}"
                                   ${settings.font.enabled ? '' : 'disabled'}
                                   onchange="updateFontUrl(this.value)">
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">å­—ä½“åç§°</div>
                            <input class="sa-input"
                                   placeholder="ç»™å­—ä½“èµ·ä¸ªåå­—..."
                                   value="${settings.font.name || ''}"
                                   onchange="updateFontName(this.value)">
                        </div>
                    </div>

                    <div class="sa-section-title">å­—ä½“é¢„è§ˆ</div>
                    <div class="preview-area"
                         style="font-family:'${settings.font.name || 'inherit'}',sans-serif; padding:15px; background:#fff; border-radius:8px; margin-top:10px;">
                        è¿™æ˜¯ä¸€æ®µé¢„è§ˆæ–‡å­—ã€‚<br>
                        Molly OS v15.4<br>
                        1234567890
                    </div>
                </div>`;
            }

            /* =========================
               ğŸš¨ å…œåº•é¡µï¼ˆé˜²ç™½å±ï¼‰
               ========================= */
            else {
                html = `
                <div style="padding:20px;text-align:center;color:#999;margin-top:50px;">
                    <div style="font-size:40px;margin-bottom:10px;">ğŸš§</div>
                    æœªå®ç°çš„è®¾ç½®é¡µé¢ï¼š${page}
                </div>`;
            }

            // âœ… æœ€ç»ˆæ¸²æŸ“ï¼ˆå”¯ä¸€å‡ºå£ï¼‰
            if (body) {
                body.innerHTML = html;
                body.scrollTop = 0;
            }
        };

        // ============================
        // 1. è®¾ç½®ä¸»é¡µæ¸²æŸ“ (ç¾åŒ–å¡ç‰‡ç‰ˆ)
        // ============================
        window.renderSettingsMain = function() {
            const body = document.getElementById('sa-body');
            if (!body) {
                console.error('[è®¾ç½®] sa-body ä¸å­˜åœ¨');
                return;
            }

            // é‡æ–°è·å–æœ€æ–°è®¾ç½®
            const settings = getAppSettings();

            // âš ï¸ åªæœ‰åœ¨â€œä¸æ˜¯ä»å†å²è¿”å›â€æ—¶ï¼Œæ‰è¡¥ main
            if (window.settingsHistory.length === 0) {
                window.settingsHistory.push('main');
            } else {
                // å¦‚æœå·²ç»åœ¨å†å²ä¸­ï¼Œç¡®ä¿æ ˆé¡¶æ˜¯ main
                window.settingsHistory = ['main'];
            }

            body.innerHTML = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;">
                        <h2 style="margin: 0; color: #333; font-size: 20px;">ç³»ç»Ÿè®¾ç½®</h2>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
                            è‡ªå®šä¹‰ä½ çš„ Molly OS ä½“éªŒ
                        </p>
                    </div>

                    <div class="sa-row sa-arrow"
                         onclick="renderSettingsPage('theme')"
                         style="background:#fff;border-radius:12px;margin-bottom:10px;cursor:pointer;padding:15px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="font-size:24px;width:40px;text-align:center;">ğŸ¨</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:16px;">ä¸»é¢˜å¤–è§‚</div>
                                <div style="font-size:12px;color:#888;margin-top:4px;">
                                    é”å±ã€æ¡Œé¢å£çº¸ã€åº”ç”¨å›¾æ ‡
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sa-row sa-arrow"
                         onclick="renderSettingsPage('font')"
                         style="background:#fff;border-radius:12px;margin-bottom:10px;cursor:pointer;padding:15px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="font-size:24px;width:40px;text-align:center;">ğŸ”¤</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:16px;">å­—ä½“ç¾åŒ–</div>
                                <div style="font-size:12px;color:#888;margin-top:4px;">
                                    è‡ªå®šä¹‰å­—ä½“æ ·å¼ä¸é“¾æ¥
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sa-row sa-arrow"
                         onclick="renderSettingsPage('api')"
                         style="background:#fff;border-radius:12px;margin-bottom:10px;cursor:pointer;padding:15px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="font-size:24px;width:40px;text-align:center;">âš¡</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:16px;">
                                    API é…ç½®
                                    <span style="
                                        background:#e6f7ff;
                                        color:#1890ff;
                                        padding:2px 8px;
                                        border-radius:10px;
                                        font-size:10px;
                                        margin-left:8px;
                                        vertical-align: middle;
                                    ">æ ¸å¿ƒ</span>
                                </div>
                                <div style="font-size:12px;color:#888;margin-top:4px;">
                                    AI æœåŠ¡æä¾›å•† (OpenAI / Gemini)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sa-row sa-arrow"
                         onclick="renderSettingsPage('voice')"
                         style="background:#fff;border-radius:12px;margin-bottom:10px;cursor:pointer;padding:15px;">
                        <div style="display:flex;align-items:center;gap:15px;">
                            <div style="font-size:24px;width:40px;text-align:center;">ğŸ™ï¸</div>
                            <div style="flex:1;">
                                <div style="font-weight:600;font-size:16px;">è¯­éŸ³ä¸é€šè¯</div>
                                <div style="font-size:12px;color:#888;margin-top:4px;">
                                    è¯­éŸ³åˆæˆä¸è¯†åˆ«é…ç½®
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ============================
        // ğŸ©¹ è¡¥å…¨å­—ä½“è®¾ç½®çš„äº¤äº’é€»è¾‘ (é˜²æŠ¥é”™)
        // ============================
        window.toggleFontEnabled = function(el) {
            const settings = getAppSettings();
            settings.font.enabled = !settings.font.enabled;
            saveAppSettings(settings);
            // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–° UI çŠ¶æ€
            renderSettingsPage('font', { fromHistory: true });
        };

        window.updateFontUrl = function(val) {
            const settings = getAppSettings();
            settings.font.url = val.trim();
            saveAppSettings(settings);
        };

        window.updateFontName = function(val) {
            const settings = getAppSettings();
            settings.font.name = val.trim();
            saveAppSettings(settings);
        };
        /* =========================
           âš¡ API é…ç½® (æ ¸å¿ƒé¡µé¢) - æ¥åœ¨ renderSettingsPage çš„ font åˆ¤æ–­åé¢
           ========================= */
            else if (page === 'api') {
                const api = settings.apis.primary;
                html = `
                <div style="padding:15px;">
                    <h2 style="margin-bottom:20px;">API é…ç½®</h2>
                    <div style="font-size:12px;color:#666;margin-bottom:15px;background:#f0f9ff;padding:10px;border-radius:8px;border:1px solid #bae7ff;">
                        ğŸ’¡ è¿™æ˜¯ AI çš„å¤§è„‘ã€‚å»ºè®®ä½¿ç”¨ OpenAI æˆ–å…¼å®¹æ¥å£ã€‚<br>
                        Gemini è¯·é€‰æ‹© "Gemini" ä¾›åº”å•†ã€‚
                    </div>

                    <div class="sa-group">
                        <div class="sa-row" style="flex-direction:column;height:auto;align-items:flex-start;">
                            <div class="sa-label">ä¾›åº”å•† (Provider)</div>
                            <div class="sa-tabs">
                                <div class="sa-tab ${api.provider === 'openai' ? 'active' : ''}"
                                     onclick="updateApiProvider('primary', 'openai')">OpenAI</div>
                                <div class="sa-tab ${api.provider === 'gemini' ? 'active' : ''}"
                                     onclick="updateApiProvider('primary', 'gemini')">Gemini</div>
                                <div class="sa-tab ${api.provider === 'custom' ? 'active' : ''}"
                                     onclick="updateApiProvider('primary', 'custom')">Custom</div>
                            </div>
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">æ¥å£åœ°å€ (Endpoint)</div>
                            <input class="sa-input"
                                   placeholder="https://api.openai.com/v1"
                                   value="${api.endpoint}"
                                   onchange="updateApiEndpoint('primary', this.value)">
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">å¯†é’¥ (API Key)</div>
                            <input class="sa-input" type="password"
                                   placeholder="sk-..."
                                   value="${api.apiKey}"
                                   onchange="updateApiKey('primary', this.value)">
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">æ¨¡å‹åç§° (Model)</div>
                            <input class="sa-input"
                                   placeholder="gpt-3.5-turbo"
                                   value="${api.model}"
                                   onchange="updateApiModel('primary', this.value)">
                        </div>
                    </div>

                    <div style="margin-top:20px;">
                        <button class="sa-btn primary" onclick="testApiConnection('primary', this)">
                            <span>ğŸ“¡ æµ‹è¯•è¿æ¥</span>
                        </button>
                    </div>
                </div>`;
            }

            /* =========================
               ğŸ¤ è¯­éŸ³æ¥å…¥
               ========================= */
            else if (page === 'voice') {
                const voice = settings.voice;
                html = `
                <div style="padding:15px;">
                    <h2 style="margin-bottom:20px;">è¯­éŸ³æ¥å…¥</h2>

                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">å¯ç”¨è¯­éŸ³åŠŸèƒ½</div>
                            <div class="sa-switch ${voice.enabled ? 'on' : ''}"
                                 onclick="toggleVoiceEnabled(this)"></div>
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">MiniMax Group ID</div>
                            <input id="voice-groupId" class="sa-input"
                                   value="${voice.groupId}"
                                   ${voice.enabled ? '' : 'disabled'}
                                   onchange="updateVoiceGroupId(this.value)">
                        </div>

                        <div class="sa-row" style="flex-direction:column;height:auto;">
                            <div class="sa-label">MiniMax API Key</div>
                            <input id="voice-apiKey" class="sa-input" type="password"
                                   value="${voice.apiKey}"
                                   ${voice.enabled ? '' : 'disabled'}
                                   onchange="updateVoiceApiKey(this.value)">
                        </div>
                    </div>
                    <div style="font-size:12px;color:#999;margin-top:10px;text-align:center;">
                        ç›®å‰ä»…æ”¯æŒ MiniMax è¯­éŸ³æ¥å£
                    </div>
                </div>`;
            }

            /* =========================
               ğŸ’¾ å¤‡ä»½ä¸æ¢å¤
               ========================= */
            else if (page === 'backup') {
                const backup = settings.backup;
                html = `
                <div style="padding:15px;">
                    <h2 style="margin-bottom:20px;">å­˜å‚¨ä¸å¤‡ä»½</h2>

                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">ä¸Šæ¬¡å¤‡ä»½</div>
                            <div class="sa-value" style="font-size:12px;">
                                ${backup.lastBackup ? new Date(backup.lastBackup).toLocaleString() : 'ä»æ— '}
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="sa-btn primary" onclick="startBackup()">
                            ğŸ“¤ å¯¼å‡ºå¤‡ä»½
                        </button>
                        <button class="sa-btn" onclick="restoreBackup()">
                            ğŸ“¥ æ¢å¤å¤‡ä»½
                        </button>
                    </div>

                    <div class="sa-section-title" style="margin-top:30px;">å±é™©åŒºåŸŸ</div>
                    <button class="sa-btn danger" onclick="resetAllData()">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ® (é‡ç½®)
                    </button>
                </div>`;
            }

            /* =========================
               â„¹ï¸ å…³äº
               ========================= */
            else if (page === 'about') {
                html = `
                <div style="padding:30px 15px;text-align:center;">
                    <div style="font-size:48px;margin-bottom:10px;">ğŸ¤–</div>
                    <h3 style="margin:0;">Molly OS</h3>
                    <div style="color:#999;font-size:12px;margin-bottom:30px;">v15.4 (Replit Edition)</div>

                    <div style="text-align:left;background:#fff;padding:15px;border-radius:12px;font-size:13px;color:#666;line-height:1.6;">
                        <p>è¿™æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨æµè§ˆå™¨é‡Œçš„â€œAI å°æ‰‹æœºâ€ã€‚</p>
                        <p>ä½ å¯ä»¥å’Œå®ƒèŠå¤©ã€ç»™å®ƒè®¾å®šäººè®¾ã€ç”šè‡³ç»™å®ƒè½¬è´¦ã€‚</p>
                        <p>æ‰€æœ‰çš„è®°å¿†éƒ½å­˜å‚¨åœ¨ä½ çš„æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œè¯·è®°å¾—å®šæœŸå¤‡ä»½ã€‚</p>
                    </div>

                    <div style="margin-top:30px;color:#ccc;font-size:12px;">
                        Made with â¤ï¸ by You & Gemini
                    </div>
                </div>`;
            }

            // æœ€ç»ˆæ¸²æŸ“
            if (body) {
                body.innerHTML = html;
                body.scrollTop = 0;
            }
        };

        /* ============================
           ğŸ› ï¸ è®¾ç½®é¡µè¾…åŠ©é€»è¾‘ (å®Œæ•´åŠŸèƒ½ç‰ˆ)
           ============================ */

        // 1. API ç›¸å…³é€»è¾‘
        window.updateApiProvider = function(type, provider) {
            const settings = getAppSettings();
            if (!settings.apis[type]) return;

            settings.apis[type].provider = provider;

            // è‡ªåŠ¨åˆ‡æ¢é»˜è®¤ç«¯ç‚¹
            if(provider === 'openai') {
                settings.apis[type].endpoint = 'https://api.openai.com/v1';
            } else if(provider === 'gemini') {
                settings.apis[type].endpoint = 'https://generativelanguage.googleapis.com/v1beta';
            } else if(provider === 'custom') {
                settings.apis[type].endpoint = ''; // è®©ç”¨æˆ·è‡ªå·±å¡«
            }

            saveAppSettings(settings);
            // åˆ·æ–°å½“å‰é¡µ
            renderSettingsPage('api', { fromHistory: true });
        };

        window.updateApiEndpoint = function(type, val) {
            const settings = getAppSettings();
            if (settings.apis[type]) {
                settings.apis[type].endpoint = val.trim();
                saveAppSettings(settings);
            }
        };

        window.updateApiKey = function(type, val) {
            const settings = getAppSettings();
            if (settings.apis[type]) {
                settings.apis[type].apiKey = val.trim();
                saveAppSettings(settings);
            }
        };

        window.updateApiModel = function(type, val) {
            const settings = getAppSettings();
            if (settings.apis[type]) {
                settings.apis[type].model = val.trim();
                saveAppSettings(settings);
            }
        };

        // 2. API æµ‹è¯•é€»è¾‘ (å¼ºåŒ–ç‰ˆ)
        window.testApiConnection = async function(type, btnElement) {
            const settings = getAppSettings();
            const apiConfig = settings.apis[type];

            if (!apiConfig || !apiConfig.apiKey || !apiConfig.endpoint) {
                alert('âŒ è¯·å…ˆå¡«å†™å®Œæ•´çš„ API å¯†é’¥å’Œæ¥å£åœ°å€');
                return;
            }

            const textSpan = btnElement.querySelector('span');
            const originalText = textSpan ? textSpan.innerText : 'æµ‹è¯•è¿æ¥';

            if (btnElement) btnElement.disabled = true;
            if (textSpan) textSpan.innerText = 'â³ æµ‹è¯•ä¸­...';

            try {
                let url = '';
                let headers = {};
                let body = {};

                // æ„é€ æµ‹è¯•è¯·æ±‚
                if (apiConfig.provider === 'gemini') {
                    url = `${apiConfig.endpoint}/models/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`;
                    headers = { 'Content-Type': 'application/json' };
                    body = {
                        contents: [{ role: 'user', parts: [{ text: 'Hello' }] }]
                    };
                } else {
                    // OpenAI / Custom
                    let ep = apiConfig.endpoint;
                    if (!ep.endsWith('/')) ep += '/';
                    url = `${ep}chat/completions`;

                    headers = {
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    };
                    body = {
                        model: apiConfig.model,
                        messages: [{ role: 'user', content: 'Hello' }],
                        max_tokens: 5
                    };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errText}`);
                }

                const data = await response.json();
                console.log('[API Test]', data);

                alert('âœ… è¿æ¥æˆåŠŸï¼API é…ç½®æœ‰æ•ˆã€‚');

            } catch (error) {
                console.error('API Test Error:', error);
                alert(`âŒ è¿æ¥å¤±è´¥\nåŸå› : ${error.message}\n\nè¯·æ£€æŸ¥ Endpoint å’Œ Key æ˜¯å¦æ­£ç¡®ï¼Œä»¥åŠæ˜¯å¦éœ€è¦ç¿»å¢™ã€‚`);
            } finally {
                if (btnElement) btnElement.disabled = false;
                if (textSpan) textSpan.innerText = originalText;
            }
        };

        // 3. è¯­éŸ³ç›¸å…³é€»è¾‘
        window.toggleVoiceEnabled = function(el) {
            const settings = getAppSettings();
            settings.voice.enabled = !settings.voice.enabled;
            saveAppSettings(settings);
            renderSettingsPage('voice', { fromHistory: true });
        };

        window.updateVoiceGroupId = function(val) {
            const s = getAppSettings();
            s.voice.groupId = val.trim();
            saveAppSettings(s);
        };

        window.updateVoiceApiKey = function(val) {
            const s = getAppSettings();
            s.voice.apiKey = val.trim();
            saveAppSettings(s);
        };

        // 4. å¤‡ä»½ç›¸å…³é€»è¾‘
        window.startBackup = function() {
            try {
                if(!confirm('ç¡®å®šè¦ä¸‹è½½å¤‡ä»½æ–‡ä»¶å—ï¼Ÿ')) return;

                const backupData = {
                    timestamp: new Date().toISOString(),
                    version: 'Molly OS v15.4',
                    data: {
                        settings: getAppSettings(),
                        friends: window.wcFriends || [],
                        chats: window.wcChats || [],
                        customizations: {}
                    }
                };

                // æ”¶é›† localStorage ä¸­çš„è‡ªå®šä¹‰å›¾ç‰‡
                for(let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if(key.startsWith('u_') || key.startsWith('app_icon_')) {
                        backupData.data.customizations[key] = localStorage.getItem(key);
                    }
                }

                const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `molly_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                // æ›´æ–°ä¸Šæ¬¡å¤‡ä»½æ—¶é—´
                const s = getAppSettings();
                s.backup.lastBackup = new Date().toISOString();
                saveAppSettings(s);
                renderSettingsPage('backup', { fromHistory: true });

            } catch (e) {
                alert('å¤‡ä»½å¤±è´¥: ' + e.message);
            }
        };

        window.restoreBackup = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = evt => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (!data.data) throw new Error("æ ¼å¼é”™è¯¯");

                        if (confirm(`æ£€æµ‹åˆ°å¤‡ä»½ï¼š${data.timestamp}\nç¡®è®¤æ¢å¤å—ï¼Ÿè¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼`)) {
                            // æ¢å¤æ•°æ®
                            if (data.data.settings) localStorage.setItem('app_settings', JSON.stringify(data.data.settings));
                            if (data.data.friends) localStorage.setItem('wc_friends', JSON.stringify(data.data.friends));
                            if (data.data.chats) localStorage.setItem('wc_chats', JSON.stringify(data.data.chats));

                            if (data.data.customizations) {
                                Object.entries(data.data.customizations).forEach(([k, v]) => {
                                    localStorage.setItem(k, v);
                                });
                            }

                            alert('âœ… æ¢å¤æˆåŠŸï¼å³å°†åˆ·æ–°é¡µé¢...');
                            location.reload();
                        }
                    } catch (err) {
                        alert('âŒ æ¢å¤å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        };

        window.resetAllData = function() {
            // é«˜å±æ“ä½œäºŒæ¬¡ç¡®è®¤
            if (confirm('âš ï¸ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ã€å¥½å‹ã€è®¾ç½®å’Œå£çº¸ï¼\n\nç¡®å®šè¦é‡ç½®å—ï¼Ÿ')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šæ•°æ®ä¸€æ—¦åˆ é™¤æ— æ³•æ¢å¤ï¼')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };
        /* =====================================================
           16. ğŸ› ï¸ è¾…åŠ©å·¥å…·ä¸å¯¼å‡º (æœ€ç»ˆè¡¥å……ç‰ˆ)
           ===================================================== */

        // æ£€æŸ¥æ›´æ–°
        window.checkForUpdates = function() {
            alert('å½“å‰ Molly OS v15.4 (APIé›†æˆç‰ˆ) å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼');
        };

        // å¯¼å‡ºæ‰€æœ‰æ•°æ®
        window.exportAllData = function() {
            const allData = {
                settings: (typeof getAppSettings === 'function') ? getAppSettings() : {},
                friends: window.wcFriends || [],
                chats: window.wcChats || [],
                customizations: {}
            };

            // æ”¶é›†è‡ªå®šä¹‰é¡¹ (ä»¥ u_ æˆ– app_icon_ å¼€å¤´çš„)
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('u_') || key.startsWith('app_icon_')) {
                    allData.customizations[key] = localStorage.getItem(key);
                }
            }

            const blob = new Blob([JSON.stringify(allData, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `molly-os-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
            alert('âœ… å¯¼å‡ºæˆåŠŸï¼è¯·å¦¥å–„ä¿å­˜ JSON æ–‡ä»¶ã€‚');
        };

        // é‡ç½®æ‰€æœ‰è®¾ç½®
        window.resetSettings = function() {
            const confirmed = confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰é…ç½®ã€å£çº¸å’Œå›¾æ ‡ï¼Œä½†ä¸ä¼šåˆ é™¤å¥½å‹å’ŒèŠå¤©è®°å½•ã€‚');
            if (!confirmed) return;

            // é‡ç½®è®¾ç½® (ä½¿ç”¨ä¹‹å‰å®šä¹‰çš„å¸¸é‡)
            if (typeof DEFAULT_APP_SETTINGS !== 'undefined') {
                saveAppSettings(DEFAULT_APP_SETTINGS);
            } else {
                localStorage.removeItem('app_settings');
            }

            // åˆ é™¤è‡ªå®šä¹‰é¡¹
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('u_') || key.startsWith('app_icon_')) {
                    keysToRemove.push(key);
                }
            }

            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });

            alert('âœ… é‡ç½®æˆåŠŸï¼å³å°†åˆ·æ–°é¡µé¢ã€‚');
            location.reload();
        };

        /* =====================================================
           17. ğŸŸ¢ æ¶ˆæ¯æ°”æ³¡æ¸²æŸ“æ ¸å¿ƒ (è¦†ç›–æ—§ç‰ˆï¼šå«è½¬è´¦ä¸é•¿æŒ‰)
           ===================================================== */

        // å…¨å±€å˜é‡å®šä¹‰ï¼ˆé˜²æ­¢æŠ¥é”™ï¼‰
        let longPressTimer;
        // let currentMsgEl; // å¦‚æœå‰é¢å®šä¹‰è¿‡å¯ä»¥æ³¨é‡Šæ‰

        // æ›´æ–° API æ¸©åº¦ (è¾…åŠ©å‡½æ•°)
        window.updateApiTemperature = function(val) {
            const display = document.getElementById('temp-display');
            if (display) display.innerText = val;

            const settings = getAppSettings();
            if (settings.apis && settings.apis.primary) {
                settings.apis.primary.temperature = parseFloat(val);
                saveAppSettings(settings);
            }
        };

        // ğŸŸ¢ æ ¸å¿ƒå‡½æ•°é‡å†™ï¼šæ·»åŠ æ°”æ³¡ UI (åŒ…å«è½¬è´¦æ ·å¼ + é•¿æŒ‰äº‹ä»¶)
        window.addBubbleUI = function(text, isMe, isTemp) {
            const list = document.getElementById('c-msg-list');
            if (!list) return;

            const row = document.createElement('div');
            row.className = 'bubble-row' + (isMe ? ' me' : '');

            // 1. å¤´åƒé€»è¾‘
            let avUrl = "";
            if (!isMe && currentChatUser) {
                // å°è¯•ä»å¥½å‹åˆ—è¡¨æ‰¾å¤´åƒï¼Œæ‰¾ä¸åˆ°ç”¨èŠå¤©å¯¹è±¡çš„é»˜è®¤å¤´åƒ
                const f = (window.wcFriends || []).find(x => x.name === currentChatUser.name);
                if (f) avUrl = f.av;
                else avUrl = currentChatUser.av || "";
            } else if (isMe) {
                // è‡ªå·±çš„å¤´åƒ (ä»ä¹‹å‰çš„ä¸Šä¼ æ§ä»¶æˆ–è€… LocalStorage è¯»å–)
                const myAv = localStorage.getItem('u_pf_av'); // å‡è®¾ä¹‹å‰ä¿å­˜è¿‡
                if (myAv) avUrl = myAv;

                // å…¼å®¹ input è¯»å–
                const myAvInput = document.getElementById('f-pf-av');
                if (myAvInput && myAvInput.files && myAvInput.files[0]) {
                    avUrl = URL.createObjectURL(myAvInput.files[0]);
                }
            }

            let avStyle = avUrl 
                ? 'background-image:url(' + avUrl + ')' 
                : (isMe ? 'background:#95ec69' : 'background:#eee');

            // 2. è½¬è´¦å¡ç‰‡æ¸²æŸ“é€»è¾‘
            let innerContent = text;
            let isTransfer = false;

            // æ­£åˆ™åŒ¹é…è½¬è´¦æ ¼å¼
            const aiTransferMatch = text.match(/^\[è½¬è´¦:([\d\.]+):(.*?)\]$/);
            const myTransferMatch = text.match(/^\[æˆ‘è½¬è´¦:([\d\.]+):(.*?)\]$/);

            if (aiTransferMatch || myTransferMatch) {
                isTransfer = true;
                const amount = aiTransferMatch ? aiTransferMatch[1] : myTransferMatch[1];
                const memo = aiTransferMatch ? aiTransferMatch[2] : (myTransferMatch[2] || 'å¾®ä¿¡è½¬è´¦');
                const status = aiTransferMatch ? 'è¯·æ”¶æ¬¾' : 'å·²å‘é€'; // å¯¹æ–¹å‘çš„æ˜¾ç¤ºè¯·æ”¶æ¬¾ï¼Œæˆ‘å‘çš„æ˜¾ç¤ºå·²å‘é€

                // æ¸²æŸ“ç²¾ç¾çš„è½¬è´¦å¡ç‰‡
                innerContent = `
                <div class="transfer-bubble" style="background:#fa9d3b; border-radius:4px; width:200px; padding:10px; color:white; overflow:hidden; position:relative;">
                    <div class="transfer-top" style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <div class="transfer-icon-circle" style="width:36px; height:36px; border:2px solid white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:20px;">Â¥</div>
                        <div style="color:#fff; display:flex; flex-direction:column;">
                            <span style="font-size:16px;">Â¥${amount}</span>
                            <span style="font-size:12px; opacity:0.9">${status}</span>
                        </div>
                    </div>
                    <div class="transfer-bottom" style="font-size:12px; opacity:0.8; padding-top:5px; border-top:1px solid rgba(255,255,255,0.2);">${memo}</div>
                </div>`;
            }

            // 3. æ„å»º HTML (ä¿®å¤ OCR é”™è¯¯ rowÃ—innerHTML -> row.innerHTML)
            const bubbleHtml = isTransfer 
                ? `<div class="c-bubble" style="padding:0;background:transparent;border:none;box-shadow:none;">${innerContent}</div>`
                : `<div class="c-bubble" style="${(isTemp ? 'color:#999;font-style:italic' : '')}">${text}</div>`;

            row.innerHTML = `<div class="c-av" style="${avStyle}"></div>${bubbleHtml}`;

            // 4. ç»‘å®šé•¿æŒ‰äº‹ä»¶ (ä»…éç³»ç»Ÿæ¶ˆæ¯ã€éè½¬è´¦)
            // æ³¨æ„ï¼šè½¬è´¦ä¹Ÿå¯ä»¥é•¿æŒ‰ï¼Œè¿™é‡Œé€»è¾‘ç¨å¾®æ”¾å®½ä¸€ç‚¹
            if (!isTemp) {
                const bubbleEl = row.querySelector('.c-bubble');
                let pressTimer;

                const startPress = (e) => {
                    // å¦‚æœæ˜¯é¼ æ ‡å³é”®ï¼Œå¿½ç•¥
                    if (e.type === 'mousedown' && e.button !== 0) return;

                    pressTimer = setTimeout(() => {
                        // è°ƒç”¨é•¿æŒ‰èœå• (å¦‚æœ showMsgMenu å®šä¹‰äº†çš„è¯)
                        if (typeof showMsgMenu === 'function') {
                            showMsgMenu(e, bubbleEl, text, row);
                        } else {
                            console.log('é•¿æŒ‰è§¦å‘ (showMsgMenu æœªå®šä¹‰)');
                        }
                    }, 600); // 600ms é•¿æŒ‰
                };

                const cancelPress = () => {
                    if (pressTimer) clearTimeout(pressTimer);
                };

                // è§¦æ‘¸è®¾å¤‡
                bubbleEl.addEventListener('touchstart', startPress, { passive: true });
                bubbleEl.addEventListener('touchend', cancelPress);
                bubbleEl.addEventListener('touchmove', cancelPress);

                // é¼ æ ‡è®¾å¤‡
                bubbleEl.addEventListener('mousedown', startPress);
                bubbleEl.addEventListener('mouseup', cancelPress);
                bubbleEl.addEventListener('mouseleave', cancelPress);
            }

            list.appendChild(row);
            // ä¿®å¤ OCR é”™è¯¯ listÃ—scrollTop -> list.scrollTop
            list.scrollTop = list.scrollHeight;
        };

        /* =====================================================
           18. ğŸš€ åˆå§‹åŒ–ä¸å¯åŠ¨ (å¤§ç»“å±€)
           ===================================================== */

        document.addEventListener('DOMContentLoaded', function() {
            // 1. ç¡®ä¿è®¾ç½®å­˜åœ¨
            if (!localStorage.getItem('app_settings')) {
                if (typeof DEFAULT_APP_SETTINGS !== 'undefined') {
                    saveAppSettings(DEFAULT_APP_SETTINGS);
                }
            }

            // 2. åŠ è½½æ‰€æœ‰æ•°æ® (å°è¯•è°ƒç”¨ä¹‹å‰çš„ initAppLoad)
            if (typeof initAppLoad === 'function') {
                initAppLoad();
            } else if (typeof load === 'function') {
                load();
            }

            console.log('âœ¨ Molly OS v15.4 - APIé›†æˆç‰ˆå·²åŠ è½½å®Œæ¯•ï¼');

            // 3. å¼ºåˆ¶ç»‘å®šæ¡Œé¢è®¾ç½®æŒ‰é’®äº‹ä»¶ (é˜²æ­¢è¢«å…¶ä»–é€»è¾‘è¦†ç›–)
            setTimeout(() => {
                const settingAppBtn = document.getElementById('dst'); // æ¡Œé¢ä¸Šçš„è®¾ç½®å›¾æ ‡ ID
                if (settingAppBtn) {
                    settingAppBtn.onclick = function() {
                        console.log('ç‚¹å‡»äº†æ¡Œé¢è®¾ç½®å›¾æ ‡');
                        if (typeof window.openSettingsApp === 'function') {
                            window.openSettingsApp();
                        } else {
                            alert('è®¾ç½®åº”ç”¨å°šæœªåŠ è½½å®Œæˆ');
                        }
                    };
                }
            }, 1000);
        });
       // å¼ºåˆ¶åˆå§‹åŒ–åŠ è½½
setTimeout(function(){
    if(typeof window.wcRenderContacts === 'function') window.wcRenderContacts();
}, 1000);
        </script>
        </body>
        </html>
