<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Molly OS v15.4 - APIé›†æˆç‰ˆ</title>
    <style>
        :root { 
    --pink: #ff99aa; --morandi-pink: #d4a5ae; --glass: rgba(255,255,255,0.7);
    --soft-white: #fdfdfd; --text: #665a5c;
    /* WeChat Colors */
    --wc-main: #ededed; --wc-bg: #F8F9FA; --wc-accent: #FF85A2; 
    --wc-accent-blue: #5CD1E5; --wc-purple: #E6D4FF; 
    --wc-txt-main: #111; --wc-txt-sub: #777; --wc-green: #95ec69;
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
body { margin: 0; background: #222; display: flex; justify-content: center; align-items: flex-start; height: 100vh; overflow: hidden; padding-top: 15px; font-family: -apple-system, "PingFang SC", sans-serif; }

/* ğŸ“± æ‰‹æœºå¤–å£³ */
.iphone { width: 375px; height: 780px; background: #fffcfd; border-radius: 50px; position: relative; border: 8px solid #222; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
.wall-global { position: absolute; top:0; left:0; width:100%; height:100%; background-size: cover; background-position: center; z-index: 1; transition: 0.5s; background-color: #fdf2f5; }

/* ğŸ‡ çµåŠ¨å²› (å…”å­ç‰ˆ) */
.island-box { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); z-index: 99999; pointer-events: none; width: 130px; height: 40px; }
.island { width: 130px; height: 32px; background: #000; border-radius: 20px; display: flex; align-items: center; justify-content: flex-end; padding-right: 15px; color: #fff; font-size: 11px; position: relative; z-index: 2; }
.ear { position: absolute; width: 10px; height: 12px; background: #000; border-radius: 4px; top: -6px; z-index: 1; transition: 0.3s; }
.ear.l { left: 22px; transform: rotate(-8deg); } .ear.r { left: 36px; transform: rotate(8deg); }
.tail-round { position: absolute; width: 12px; height: 12px; background: #000; border-radius: 50%; right: 0px; bottom: 8px; z-index: 0; }
.corgi-face { position: absolute; left: 20px; display: flex; align-items: center; gap: 8px; }
.eye { width: 3px; height: 3px; background: #fff; border-radius: 50%; }

/* ğŸ”’ é”å± (ä¿®å¤å¡é¡¿ä¸å½±å­) */
#lock-screen { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    z-index: 10000; 
    display: flex; flex-direction: column; align-items: center; padding-top: 60px; 
    transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.4s; 
    background: rgba(255,255,255,0.01); 
    backdrop-filter: blur(0px);
    cursor: pointer;
}
.iphone.unlocked #lock-screen { transform: translateY(-100%); opacity: 0; pointer-events: none; }

.l-time { font-size: 85px; font-weight: 800; color: #fff; font-family: "Arial Rounded MT Bold"; text-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.l-glass { background: rgba(255,255,255,0.4); backdrop-filter: blur(15px); border-radius: 25px; border: 1.5px solid #fff; }
.hand { position: absolute; bottom: 50%; left: 50%; background: #fff; transform-origin: bottom; border-radius: 2px; }

/* ğŸ  æ¡Œé¢ */
#main-desktop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; display: none; }
.iphone.unlocked #main-desktop { display: block; }
.swiper-wrapper { display: flex; width: 200%; height: 100%; transition: transform 0.3s ease-out; }
.iphone.page-2 .swiper-wrapper { transform: translateX(-50%); }
.desktop-page { width: 50%; height: 100%; padding: 60px 20px 110px; display: flex; flex-direction: column; gap: 15px; }

.unified-grid-4 { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px !important; width: 100%; height: 100%; }
.std-icon { width: 54px; height: 54px; background: var(--soft-white); border-radius: 14px; background-size: cover; background-position: center; box-shadow: 0 4px 8px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; font-size: 24px; border: 1px solid #dcdcdc; cursor: pointer; }
.std-icon.has-img { font-size: 0; }
.p1-time { font-size: 80px; font-weight: 800; color: #fff; text-align: center; margin-top: 10px; margin-bottom: 5px; }
.dashed-diary { height: 130px; display: flex; flex-direction: column; justify-content: center; gap: 18px; padding: 10px 20px; }
.diary-line { border-bottom: 2px dashed rgba(255,255,255,0.8); color: var(--morandi-pink); font-size: 12px; padding-bottom: 4px; text-align: center; }
.music-av-simple { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #fff; background-size: cover; background-color: #eee; cursor: pointer; }
.glass-card-msg { padding: 15px; display: flex; flex-direction: column; background: #fff; justify-content: center; border-radius: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
.sharp-bubble { padding: 8px 12px; border-radius: 4px; font-size: 10px; margin-bottom: 8px; position: relative; max-width: 90%; }
.sb-l { background: #e1f5fe; color: #555; align-self: flex-start; border-radius: 12px 12px 12px 2px; }
.sb-r { background: #fce4ec; color: #555; align-self: flex-end; border-radius: 12px 12px 2px 12px; }
.cat-cam-3d { background: #fffbf8; border-radius: 24px; border: 2px solid #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.08); padding: 10px; position: relative; height: 100%; display: flex; flex-direction: column; }
.cam-ear-3d { position: absolute; width: 20px; height: 12px; background: #fffbf8; border-radius: 10px 10px 0 0; top: -8px; z-index: 0; box-shadow: 0 -2px 2px rgba(0,0,0,0.02); }
.ce-3d-l { left: 15px; transform: rotate(-10deg); } .ce-3d-r { right: 15px; transform: rotate(10deg); }
.cam-screen-sq { flex: 1; background: #eee; border-radius: 12px; border: 2px solid #f0f0f0; background-size: cover; background-position: center; margin-bottom: 5px; cursor: pointer; }
.home-btn-area { height: 25px; display: flex; align-items: center; justify-content: space-between; padding: 0 5px; }
.iphone-home-btn { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ddd; background: #fff; }

.p2-header-clean { height: 160px; background: #fff; border-radius: 30px; overflow: hidden; position: relative; border: 3px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.04); display: flex; flex-direction: column; }
.p2-bg-c { height: 80px; width: 100%; background: #f0f0f0; background-size: cover; cursor: pointer; }
.p2-av-c { width: 75px; height: 75px; border-radius: 50%; border: 4px solid #fff; position: absolute; top: 80px; left: 50%; transform: translate(-50%, -50%); background: #ddd; background-size: cover; z-index: 5; cursor: pointer; }
.p2-text-c { flex: 1; display: flex; flex-direction: column; align-items: center; padding-top: 45px; gap: 2px; }
.info-clean { font-size: 11px; color: #888; font-weight: 500; cursor: pointer; }
.short-frame { width: 100%; height: 100%; background: #fff; border-radius: 20px; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; color: #eee; font-size: 30px; cursor: pointer; }
.gb-shell-long { background: #e8e8e8; border-radius: 30px; padding: 12px; display: flex; flex-direction: column; align-items: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 2px solid #dcdcdc; height: 155px; justify-content: space-between; cursor: pointer; }
.gb-screen-long { background: #1a1a1a; padding: 5px; border-radius: 12px; width: 100%; height: 80px; display: flex; align-items: center; justify-content: center; color: var(--morandi-pink); font-family: monospace; font-size: 9px; text-align: center; }

.dock-container { position: absolute; bottom: 30px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; z-index: 200; display: none; }
.iphone.unlocked .dock-container { display: flex; }
.dock-bar { pointer-events: auto; width: 320px; height: 80px; background: rgba(255,255,255,0.92); backdrop-filter: blur(40px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; border: 1.5px solid #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
.page-dots { display: flex; gap: 8px; }
.dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; opacity: 0.4; transition: 0.3s; }
.iphone.page-1 .d1, .iphone.page-2 .d2 { opacity: 1; background: var(--morandi-pink); transform: scale(1.3); }
input[type="file"] { display: none; }

/* ============================
   ğŸ’š å¾®ä¿¡ APP (ä¿®å¤åˆ‡æ¢å’Œå±‚çº§)
   ============================ */
.wc-app, .app-container { 
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
    background: var(--wc-bg); z-index: 5000; 
    display: none; flex-direction: column; 
    animation: slideUp 0.3s ease-out; font-family: -apple-system, sans-serif;
}
.wc-app.active, .app-container.active { display: flex; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

.wc-header, .app-header { height: 90px; background: #ededed; display: flex; align-items: flex-end; padding-bottom: 12px; padding-left: 20px; padding-right: 20px; justify-content: space-between; box-shadow: 0 1px 0 rgba(0,0,0,0.1); z-index: 5001; }
.wc-h-left, .app-h-left { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--wc-txt-main); font-weight: 600; font-size: 17px; }
.wc-h-right, .app-h-right { cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; color: var(--wc-txt-main); font-size: 22px; transition: 0.2s; }

/* åˆ—è¡¨å®¹å™¨ */
.wc-body, .app-body { flex: 1; overflow: hidden; background: var(--wc-bg); padding-top: 0; display:flex; flex-direction:column; position: relative; }

/* ä¸¤ä¸ªTabå†…å®¹ï¼Œç»å¯¹å®šä½é‡å ï¼Œé€šè¿‡ display åˆ‡æ¢ */
#wc-chat-list, #wc-contact-list {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    overflow-y: auto; padding-top: 0;
}
#wc-contact-list { display: none; } /* é»˜è®¤éšè—é€šè®¯å½• */

.wc-empty, .app-empty { text-align: center; color: var(--wc-txt-sub); font-size: 13px; margin-top: 60px; font-weight: 500; }

/* ğŸ“Œ ä¿®æ”¹ç½®é¡¶æ ·å¼ï¼šå·¦æ»‘æ˜¾ç¤ºä¸¤ä¸ªæŒ‰é’® - ä¼˜åŒ–ç‰ˆ */
.wc-list-item { 
    display: flex; height: 72px; align-items: center; padding: 0 15px; background: #fff; 
    cursor: pointer; transition: all 0.3s ease; border-bottom: 1px solid #f0f0f0; 
    position: relative; overflow: hidden;
    touch-action: pan-y;
}
.wc-list-item:active { background: #f5f5f5; }
.wc-list-item.pinned { background: #f9f9f9; }

.wc-avatar { width: 48px; height: 48px; border-radius: 6px; background: #eee; background-size: cover; flex-shrink: 0; }
.wc-info { margin-left: 12px; flex: 1; display: flex; flex-direction: column; justify-content: center; overflow: hidden; }
.wc-name { font-size: 16px; color: #000; font-weight: 500; }
.wc-last-msg { font-size: 13px; color: #999; margin-top: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.wc-time { font-size: 11px; color: #b2b2b2; margin-left: 10px; align-self: flex-start; margin-top: 15px; }

/* å·¦æ»‘æŒ‰é’®å®¹å™¨ */
.wc-swipe-actions {
    position: absolute;
    right: -160px;
    top: 0;
    height: 100%;
    display: flex;
    transition: right 0.3s ease;
}

/* å·¦æ»‘æŒ‰é’® */
.wc-swipe-btn {
    width: 80px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.wc-swipe-btn.pin {
    background: #07c160;
}

.wc-swipe-btn.unpin {
    background: #ff9500;
}

.wc-swipe-btn.delete {
    background: #ff3b30;
}

/* å·¦æ»‘æ—¶æ˜¾ç¤ºæŒ‰é’® */
.wc-list-item.swiping .wc-swipe-actions {
    right: 0;
}

/* é€šè®¯å½•åˆ—è¡¨é¡¹ */
.contact-group-title { padding: 8px 15px; font-size: 11px; color: #888; background: #f7f7f7; font-weight: normal; }
.contact-item { display: flex; align-items: center; padding: 10px 15px; background: #fff; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
.c-av-small { width: 38px; height: 38px; border-radius: 4px; background: #eee; background-size: cover; margin-right: 12px; }
.c-name-text { font-size: 16px; font-weight: 500; color: #333; }

/* åº•éƒ¨å¯¼èˆª - ç§»é™¤æœ‹å‹åœˆå’Œæˆ‘çš„ */
.wc-footer { height: 80px; background: #f7f7f7; display: flex; justify-content: space-around; padding-top: 8px; border-top: 1px solid #dcdcdc; z-index:5001; }
.wc-tab { display: flex; flex-direction: column; align-items: center; gap: 2px; cursor: pointer; color: #111; transition: 0.1s; }
.wc-tab.active { color: #07c160; }
.wc-tab-icon { font-size: 24px; } .wc-tab-txt { font-size: 10px; font-weight: 500; }

/* æ¨¡æ€æ¡† */
.wc-popover { position: absolute; top: 60px; right: 10px; width: 140px; background: #4c4c4c; border-radius: 6px; z-index: 6000; display: none; flex-direction: column; padding: 5px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.wc-menu-item { color: #fff; padding: 12px 15px; font-size: 14px; display: flex; align-items: center; gap: 12px; cursor: pointer; border-bottom: 1px solid #5d5d5d; }

.wc-modal-mask { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(50, 50, 50, 0.3); backdrop-filter: blur(3px); z-index: 7000; display: none; align-items: center; justify-content: center; }
.wc-modal { width: 300px; background: #fff; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; animation: popIn 0.2s ease-out; }
@keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.wc-modal-head { background: #f9f9f9; padding: 15px; text-align: center; font-weight: 600; font-size: 16px; color: #000; border-bottom: 1px solid #eee; }
.wc-add-content { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }

/* ğŸŸ© æ–¹å½¢å¤´åƒ */
.wc-up-av { width: 70px; height: 70px; background: #f0f0f0; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #ccc; font-size: 30px; background-size: cover; border: 1px solid #ddd; }
.wc-up-av.has-img { border: 1px solid #eee; }
.wc-up-av::after { content:"+"; } .wc-up-av.has-img::after { content:""; }

.wc-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; background: #fff; outline:none; }
.wc-modal-btns { display: flex; border-top: 1px solid #eee; }
.wc-m-btn { flex: 1; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; font-weight: 500; }
.wc-btn-cancel { color: #000; border-right: 1px solid #eee; }
.wc-btn-confirm { color: #576b95; }

.wc-sel-list { max-height: 300px; overflow-y: auto; }
.wc-sel-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
.wc-sel-check { width: 20px; height: 20px; border: 1px solid #ccc; border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; }
.wc-sel-item.selected .wc-sel-check { background: #07c160; border-color: #07c160; color: #fff; }
.wc-sel-item.selected .wc-sel-check::after { content: "âœ“"; font-size: 12px; font-weight: bold; }

/* ============================
   ğŸ’¬ èŠå¤©çª—å£ (å…¨å±)
   ============================ */
.wc-chat-window {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: #ededed; z-index: 6000; display: none; flex-direction: column;
    animation: slideInR 0.25s ease-out;
}
@keyframes slideInR { from { transform: translateX(100%); } to { transform: translateX(0); } }

.c-header { height: 90px; background: #ededed; display: flex; align-items: flex-end; padding: 0 15px 12px; border-bottom: 1px solid #dcdcdc; justify-content: space-between; z-index: 10; }
.ch-l { display:flex; align-items:center; gap:5px; font-size:16px; color:#111; cursor:pointer; width:70px; font-weight:500; }
.ch-m { display:flex; flex-direction:column; align-items:center; flex:1; }
.ch-name { font-size:16px; font-weight:600; display:flex; align-items:center; gap:5px; color:#000; }
.ch-status { font-size:10px; color:#666; margin-top:1px; display:flex; align-items:center; gap:3px; }
.ch-r { display:flex; gap:15px; width:70px; justify-content:flex-end; align-items:center; }
.ch-icon-btn { font-size:18px; cursor:pointer; color:#111; width:30px; height:30px; display:flex; align-items:center; justify-content:center; }

.c-body { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:15px; background:#ededed; background-size: cover; background-position: center; }
.bubble-row { display:flex; gap:10px; max-width:100%; align-items: flex-start; }
.bubble-row.me { flex-direction:row-reverse; }
.c-av { width:40px; height:40px; border-radius:4px; background:#ddd; background-size:cover; flex-shrink:0; }
.c-bubble { background:#fff; padding:10px 12px; border-radius:4px; font-size:15px; line-height:1.5; color:#000; position:relative; max-width:70%; word-wrap:break-word; border:1px solid #e5e5e5; }
.bubble-row.me .c-bubble { background: #95ec69; border-color:#86d65e; }
.c-bubble::before { content:""; position:absolute; top:12px; width:8px; height:8px; background:inherit; border:inherit; border-right:none; border-bottom:none; transform:rotate(45deg); }
.bubble-row:not(.me) .c-bubble::before { left:-5px; border-top:1px solid #e5e5e5; border-left:1px solid #e5e5e5; }
.bubble-row.me .c-bubble::before { right:-5px; border-top:1px solid #86d65e; border-right:1px solid #86d65e; border-left:none; background:#95ec69; }

.c-footer { min-height:55px; background:#f7f7f7; border-top:1px solid #dcdcdc; display:flex; align-items:center; padding:8px 10px; gap:8px; z-index:10; }
.cf-icon { font-size:28px; color:#111; cursor:pointer; width:34px; text-align:center; }
.cf-input { flex:1; height:38px; border:none; border-radius:4px; padding:0 10px; font-size:16px; outline:none; background:#fff; }
.cf-bone { width:34px; height:34px; background:#fff; border:1px solid #ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#333; font-size:16px; cursor:pointer; }
.cf-bone:active { background:#f0f0f0; }
.btn-send { display: none; background: #95ec69; color: #fff; font-size: 14px; padding: 6px 12px; border-radius: 4px; font-weight: 500; cursor: pointer; }

.c-panel { height:0; overflow:hidden; background:#f7f7f7; transition:height 0.2s; border-top:1px solid #eee; }
.c-panel.open { height:220px; overflow-y:auto; padding:20px; }
.grid-menu { display:grid; grid-template-columns:repeat(4, 1fr); gap:20px; }
.gm-item { display:flex; flex-direction:column; align-items:center; gap:6px; color:#666; font-size:12px; cursor:pointer; }
.gm-icon { width:55px; height:55px; background:#fff; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:26px; border:1px solid #e5e5e5; }

/* æµ®çª— & è®¾ç½® (æœ€é«˜å±‚çº§) */
.foot-panel { position:absolute; top:90px; right:10px; width:220px; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:8px; padding:15px; box-shadow:0 0 20px rgba(0,0,0,0.1); display:none; z-index:8000; flex-direction:column; gap:10px; animation:popIn 0.2s; }
.fp-row { display:flex; gap:8px; align-items:flex-start; font-size:13px; color:#333; line-height:1.4; }

.settings-page { position:absolute; top:0; left:0; width:100%; height:100%; background:#ededed; z-index:9000; display:none; flex-direction:column; animation:slideInR 0.25s; }
.s-header { height:90px; background:#ededed; display:flex; align-items:flex-end; padding:0 15px 12px; font-size:17px; font-weight:600; border-bottom:1px solid #dcdcdc; position:relative; }
.s-back { position:absolute; left:15px; bottom:12px; font-weight:400; color:#111; cursor:pointer; font-size:16px; display:flex; align-items:center; gap:5px; }
.s-body { flex:1; overflow-y:auto; padding-bottom:30px; }

.s-group { background:#fff; margin-top:10px; border-top:1px solid #e5e5e5; border-bottom:1px solid #e5e5e5; }
.s-row { display:flex; justify-content:space-between; align-items:center; padding:12px 15px; border-bottom:1px solid #f0f0f0; font-size:16px; color:#000; min-height:50px; }
.s-row:last-child { border-bottom:none; }
.s-label { color:#000; flex:1; }
.s-val { color:#888; font-size:14px; display:flex; align-items:center; gap:5px; max-width:60%; text-align:right; }
.s-arrow::after { content:">"; color:#ccc; margin-left:8px; font-family:monospace; font-weight:bold; }

.s-slider { width:120px; accent-color:#07c160; }
.s-switch { width:50px; height:30px; background:#e5e5e5; border-radius:15px; position:relative; cursor:pointer; transition:0.3s; }
.s-switch.on { background:#07c160; }
.s-switch::after { content:""; position:absolute; width:26px; height:26px; background:#fff; border-radius:50%; top:2px; left:2px; transition:0.3s; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
.s-switch.on::after { left:22px; }
.s-input { border:none; text-align:right; outline:none; color:#555; width:100%; font-size:15px; background:transparent; }
.s-btn-red { color:#fa5151; text-align:center; width:100%; font-weight:500; cursor:pointer; }
.section-title { padding:15px 15px 5px; font-size:13px; color:#888; }
.s-textarea { width:100%; border:none; resize:none; font-size:15px; color:#333; outline:none; font-family:inherit; text-align:left; background:#f9f9f9; padding:5px; border-radius:4px; margin-top:5px; }

/* --- ğŸ¨ ä¿®å¤ç‰ˆï¼šçœŸÂ·æ°”æ³¡é¢„è§ˆä¸æ ·å¼ --- */
.s-label { white-space: nowrap; min-width: 60px; font-weight: 500; }
.s-textarea { background: #f5f5f5; padding: 10px; border-radius: 8px; font-size: 14px; margin-top: 8px; width: 100%; box-sizing: border-box; border:none; outline:none; font-family: inherit; }
.slider-val { font-size: 12px; color: #888; width: 30px; text-align: right; font-variant-numeric: tabular-nums; }

/* é¢„è§ˆæ¡†å®¹å™¨ï¼šæ¨¡æ‹ŸèŠå¤©èƒŒæ™¯ */
.bubble-preview-box {
    background: #ededed; /* å¾®ä¿¡é»˜è®¤ç°èƒŒæ™¯ */
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    border: 1px solid #ddd;
    height: 140px; /* å›ºå®šé«˜åº¦ */
    overflow: hidden;
}

/* é€šç”¨é¢„è§ˆè¡Œ */
.pv-row { display: flex; align-items: flex-start; gap: 10px; }
.pv-row.me { flex-direction: row-reverse; }

/* é¢„è§ˆå¤´åƒ */
.pv-av { width: 36px; height: 36px; border-radius: 4px; background: #ddd; flex-shrink: 0; }

/* é¢„è§ˆæ°”æ³¡ */
.pv-bubble {
    padding: 10px 12px; border-radius: 4px; font-size: 15px; color: #000;
    max-width: 70%; position: relative; border: 1px solid #e5e5e5; background: #fff;
}
/* å¯¹æ–¹çš„æ°”æ³¡ (æˆ‘ä»¬è¦ä¿®æ”¹çš„ç›®æ ‡) */
.pv-bubble.them { background: #fff; } 
.pv-bubble.them::before {
    content: ""; position: absolute; top: 12px; left: -6px;
    width: 8px; height: 8px; background: inherit;
    border-bottom: 1px solid #e5e5e5; border-left: 1px solid #e5e5e5;
    transform: rotate(45deg);
}

/* è‡ªå·±çš„æ°”æ³¡ (å¯¹æ¯”ç”¨) */
.pv-bubble.me { background: #95ec69; border-color: #86d65e; }
.pv-bubble.me::before {
    content: ""; position: absolute; top: 12px; right: -6px;
    width: 8px; height: 8px; background: inherit;
    border-top: 1px solid #86d65e; border-right: 1px solid #86d65e;
    transform: rotate(45deg);
}

/* ç¡®è®¤æŒ‰é’® (å°å·§ç‰ˆ) */
.btn-confirm-mini {
    background: #07c160; color: #fff; font-size: 13px;
    padding: 6px 15px; border-radius: 4px; cursor: pointer;
    margin-left: auto; font-weight: 500;
}
.btn-confirm-mini:active { background: #06ad56; }

/* ============================
   âš™ï¸ è®¾ç½®åº”ç”¨æ–°å¢æ ·å¼
   ============================ */
.settings-app {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #ededed;
    z-index: 10000;
    display: none;
    flex-direction: column;
    animation: slideInR 0.25s ease-out;
}

.settings-app.active {
    display: flex;
}

.sa-header {
    height: 90px;
    background: #ededed;
    display: flex;
    align-items: flex-end;
    padding: 0 15px 12px;
    font-size: 17px;
    font-weight: 600;
    border-bottom: 1px solid #dcdcdc;
    position: relative;
}

.sa-back {
    position: absolute;
    left: 15px;
    bottom: 12px;
    font-weight: 400;
    color: #111;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* å°ç‹—è„šå°è¿”å›æŒ‰é’® */
.sa-back.paw-back::before {
    content: "ğŸ¾";
    font-size: 16px;
    margin-right: 5px;
}

.sa-body {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 30px;
    background: #f5f5f5;
}

.sa-group {
    background: #fff;
    margin-top: 10px;
    border-top: 1px solid #e5e5e5;
    border-bottom: 1px solid #e5e5e5;
}

.sa-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 16px;
    color: #000;
    min-height: 50px;
}

.sa-row:last-child {
    border-bottom: none;
}

.sa-label {
    color: #000;
    flex: 1;
    font-weight: 500;
}

.sa-value {
    color: #888;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    max-width: 60%;
    text-align: right;
}

.sa-arrow::after {
    content: "â€º";
    color: #ccc;
    margin-left: 8px;
    font-family: monospace;
    font-weight: bold;
    font-size: 18px;
}

.sa-section-title {
    padding: 15px 15px 5px;
    font-size: 13px;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 1px;
    background: #f5f5f5;
    margin-top: 10px;
}

.sa-switch {
    width: 50px;
    height: 30px;
    background: #e5e5e5;
    border-radius: 15px;
    position: relative;
    cursor: pointer;
    transition: 0.3s;
}

.sa-switch.on {
    background: #07c160;
}

.sa-switch::after {
    content: "";
    position: absolute;
    width: 26px;
    height: 26px;
    background: #fff;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.sa-switch.on::after {
    left: 22px;
}

.sa-input {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 14px;
    width: 100%;
    outline: none;
    background: #fff;
    transition: border-color 0.2s;
}

.sa-input:focus {
    border-color: #07c160;
}

.sa-textarea {
    width: 100%;
    border: 1px solid #ddd;
    border-radius: 6px;
    resize: none;
    font-size: 14px;
    padding: 10px;
    outline: none;
    font-family: inherit;
    background: #fff;
    min-height: 80px;
}

.sa-btn {
    background: #07c160;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.sa-btn:hover {
    background: #06ad56;
}

.api-config-block {
    background: #f8f9fa;
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
}

.api-config-title {
    font-size: 14px;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.model-selector {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    background: #fff;
    cursor: pointer;
    outline: none;
}

.color-picker-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
    margin: 10px 0;
}

.color-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: transform 0.2s;
}

.color-option:hover {
    transform: scale(1.1);
}

.color-option.selected {
    border-color: #333;
    box-shadow: 0 0 0 2px #fff, 0 0 0 4px #07c160;
}

.preview-area {
    background: #fafafa;
    border: 1px dashed #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    text-align: center;
    min-height: 100px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
}

.preview-img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #07c160;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ============================
   ğŸ® é€šç”¨åº”ç”¨å®¹å™¨æ ·å¼
   ============================ */
.app-empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    padding: 20px;
    text-align: center;
}

.app-empty-content .app-icon-large {
    font-size: 60px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.app-empty-content h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 18px;
}

.app-empty-content p {
    margin: 0;
    color: #666;
    font-size: 14px;
    max-width: 80%;
    line-height: 1.5;
}

/* åº”ç”¨å›¾æ ‡ç¼–è¾‘åŒºåŸŸ - æ”¹ä¸º3åˆ— */
.icon-edit-area {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    padding: 20px;
}

.icon-preview {
    width: 80px;
    height: 80px;
    border-radius: 18px;
    background-size: cover;
    background-position: center;
    background-color: #f0f0f0;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    color: #ccc;
}

.icon-preview.has-img {
    font-size: 0;
}

.icon-preview::after {
    content: "+";
}

.icon-preview.has-img::after {
    content: "";
}

.icon-edit-btn {
    background: #07c160;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 13px;
    cursor: pointer;
}

.icon-edit-btn:active {
    background: #06ad56;
}

/* ä¸Šä¼ æˆåŠŸæç¤º */
.upload-success {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    z-index: 100000;
    font-size: 14px;
    display: none;
    animation: fadeInOut 2s ease-in-out;
}

@keyframes fadeInOut {
    0% { opacity: 0; }
    20% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; }
}

/* å£çº¸é¢„è§ˆåŒºåŸŸ - ä¿®å¤ï¼šå¢åŠ é«˜åº¦æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ */
.wallpaper-preview-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}

.wallpaper-preview-title {
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
}

.wallpaper-preview-box {
    width: 100%;
    height: 200px; /* å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºå®Œæ•´é¢„è§ˆ */
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #ddd;
    background-size: cover;
    background-position: center;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* é”å±é¢„è§ˆåŒºåŸŸä¿®å¤ */
#l-pre {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: #fff;
}

/* è§£å†³ç™½å±é—®é¢˜çš„ä¿®å¤ */
.settings-page, .wc-popover, .wc-modal-mask, .foot-panel {
    will-change: transform, opacity;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* APIé…ç½®é¡µé¢è¿”å›æŒ‰é’® */
.api-config-back {
    position: absolute;
    left: 15px;
    bottom: 12px;
    font-weight: 400;
    color: #111;
    cursor: pointer;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.api-config-back::before {
    content: "ğŸ¾";
    font-size: 16px;
    margin-right: 5px;
}

/* è§£å†³è®¾ç½®é¡µé¢ç™½å±é—®é¢˜çš„å…³é”®CSS */
.settings-app * {
    -webkit-tap-highlight-color: rgba(0,0,0,0);
}

/* ä¼˜åŒ–æ»‘åŠ¨ä½“éªŒ */
.wc-list-item {
    touch-action: pan-y;
    -webkit-user-drag: none;
}

/* ä¿®å¤å¾®ä¿¡ç½®é¡¶æ ·å¼ */
.wc-list-item.pinned .wc-info .wc-name::before {
    content: "ğŸ“Œ ";
    font-size: 12px;
    color: #07c160;
}
    </style>
</head>
<body>
    <div class="iphone locked page-1" id="box">
        <div id="global-wall" class="wall-global"></div>

        <div class="island-box">
            <div class="ear l"></div><div class="ear r"></div>
            <div class="tail-round"></div>
            <div class="island"><div class="corgi-face"><div class="eye"></div><div class="eye"></div></div><span id="isl-bat">100%</span></div>
        </div>

        <div id="lock-screen" onclick="this.style.display='none'; document.getElementById('box').classList.add('unlocked');" ontouchend="this.style.display='none'; document.getElementById('box').classList.add('unlocked');">
            <div style="font-size:16px; color:#fff; font-weight:500; margin-top:10px" id="l-date">12æœˆ31æ—¥ æ˜ŸæœŸä¸‰</div>
            <div class="l-time" id="l-time">00:00</div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <div class="l-glass" style="width:125px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                    <div style="font-size:9px; font-weight:bold; color:var(--morandi-pink)" id="lkp" onclick="event.stopPropagation();editT('lkp','u_lkp')">ğŸ¾ èŒ‰è‰çš„å°çˆªæœº</div>
                    <div style="width:75%; height:6px; background:rgba(0,0,0,0.1); border-radius:3px; margin-top:5px;"><div style="width:85%; height:100%; background:var(--morandi-pink); border-radius:3px;"></div></div>
                </div>
                <div class="l-glass" style="width:50px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;"><span style="font-size:14px; font-weight:800; color:#fff" id="mini-d">31</span><span style="font-size:8px; color:var(--morandi-pink)">å‘¨ä¸‰</span></div>
                <div class="l-glass" style="width:50px; height:50px; display:flex; flex-direction:column; align-items:center; justify-content:center;"><span style="font-size:14px; font-weight:800; color:#fff">22Â°</span><span style="font-size:8px; color:var(--morandi-pink)">èˆ’é€‚</span></div>
            </div>
            <div class="l-glass" style="width:290px; height:80px; margin-top:25px; padding:15px;">
                <div style="font-size:12px; color:var(--morandi-pink); margin-bottom:10px; font-weight:bold">2025å¹´ 12æœˆ</div>
                <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:10px; color:#fff; gap:5px"><span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>28</span><span>29</span><span>30</span><span style="background:var(--morandi-pink); border-radius:50%; width:16px; height:16px; line-height:16px; margin:0 auto">31</span><span>1</span><span>2</span><span>3</span></div>
            </div>
            <!-- é”å±å£çº¸é¢„è§ˆ - ä¿®å¤é«˜åº¦ -->
            <div class="l-glass" style="width:290px; height:200px; margin-top:15px; overflow:hidden; display:flex; align-items:center; justify-content:center; cursor:pointer" onclick="event.stopPropagation();pick('f-lph')">
                <div id="l-pre" style="color:#fff; font-size:20px;">+</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1.5fr; gap:15px; width:290px; margin-top:15px;">
                <div class="l-glass" style="height:105px; position:relative;">
                    <div style="width:75px; height:75px; border-radius:50%; border:2px solid #fff; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%)">
                        <div class="hand" id="h-h" style="width:4px; height:22px; margin-left:-2px;"></div>
                        <div class="hand" id="h-m" style="width:3px; height:30px; margin-left:-1.5px;"></div>
                        <div class="hand" id="h-s" style="width:1.5px; height:32px; background:var(--morandi-pink); margin-left:-0.75px;"></div>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n1">ğŸ·ï¸ ä»Šæ—¥å¿ƒæƒ…ï¼šå¼€å¿ƒæ»¡æ»¡ âœ¨</div>
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n2">ğŸ·ï¸ å¾…åŠï¼šèŒ‰è‰å²›æ›´æ–° ğŸ’»</div>
                    <div class="l-glass" style="height:30px; font-size:9px; color:#fff; padding:0 12px; display:flex; align-items:center; background:rgba(255,255,255,0.2);" id="n3">ğŸ·ï¸ æƒ³å¿µï¼šæ¯æ—¶æ¯åˆ» â¤ï¸</div>
                </div>
            </div>
            <div style="margin-top:20px; color:#fff; font-size:12px; opacity:0.8;">å‘ä¸Šæ»‘åŠ¨è§£é”</div>
        </div>

        <div id="main-desktop">
            <div class="swiper-wrapper" id="sw">
                <div class="desktop-page">
                    <div class="p1-time" id="d-time">00:00</div>
                    <div style="display:grid; grid-template-columns:1.1fr 1fr; gap:12px; height:130px;">
                        <div class="l-glass dashed-diary">
                            <div class="diary-line" id="dl1" onclick="editT('dl1','u_dl1')">è®°å½•ä¸€åˆ»çš„å¿ƒåŠ¨...</div>
                            <div class="diary-line" id="dl2" onclick="editT('dl2','u_dl2')">ä»Šå¤©å¤©æ°”æ™´æœ—</div>
                            <div class="diary-line" id="dl3" onclick="editT('dl3','u_dl3')">è®°å¾—å–æ°´é¸­</div>
                        </div>
                        <!-- ç¬¬ä¸€é¡µå³ä¸Šè§’4ä¸ªåº”ç”¨ï¼šå¾®åšï¼Œçº¦ä¼šï¼Œç½‘æ˜“äº‘ï¼Œæ¸¸æˆ -->
                        <div class="unified-grid-4">
                            <div class="std-icon" id="i-weibo" onclick="openApp('weibo')" title="å¾®åš"></div>
                            <div class="std-icon" id="i-date" onclick="openApp('date')" title="çº¦ä¼š"></div>
                            <div class="std-icon" id="i-music" onclick="openApp('music')" title="ç½‘æ˜“äº‘"></div>
                            <div class="std-icon" id="i-game" onclick="openApp('game')" title="æ¸¸æˆ"></div>
                        </div>
                    </div>
                    <div style="height:80px; display:flex; align-items:center; justify-content:center; gap:25px; margin-top:10px">
                        <div class="music-av-simple" id="avL" onclick="pick('f-avL')"></div>
                        <div style="width:60px; text-align:center;"><svg style="width:100%;height:20px;"><polyline style="stroke:var(--morandi-pink); stroke-width:3; fill:none;" points="0,10 15,10 20,2 25,18 30,10 50,10"/></svg></div>
                        <div class="music-av-simple" id="avR" onclick="pick('f-avR')"></div>
                    </div>
                    <div style="display:flex; justify-content:space-around; width:100%; margin-top:-5px; margin-bottom:5px;">
                        <div id="mt1" onclick="editT('mt1','u_mt1')" style="color:var(--morandi-pink); font-size:9px; font-weight:bold; cursor:pointer">ç›¸è· 520 km</div>
                        <div id="mt2" onclick="editT('mt2','u_mt2')" style="color:var(--morandi-pink); font-size:9px; font-weight:bold; cursor:pointer">ä¸€èµ·å¬äº† 1314 h</div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; height:145px;">
                        <div class="glass-card-msg">
                            <div class="sharp-bubble sb-l" id="p1-msg1" onclick="editT('p1-msg1','u_msg1')">I miss u >ï¹<</div>
                            <div class="sharp-bubble sb-r" id="p1-msg2" onclick="editT('p1-msg2','u_msg2')">å—¯ã€‚çŸ¥é“äº†ã€‚</div>
                        </div>
                        <div class="cat-cam-3d">
                            <div class="cam-ear-3d ce-3d-l"></div>
                            <div class="cam-ear-3d ce-3d-r"></div>
                            <div class="cam-screen-sq" id="i-p-wall" onclick="pick('f-pwall')"></div>
                            <div class="home-btn-area"><div class="iphone-home-btn"></div></div>
                        </div>
                    </div>
                </div>
                <div class="desktop-page">
                    <div class="p2-header-clean">
                        <div class="p2-bg-c" id="p2bg" onclick="pick('f-p2bg')"></div>
                        <div class="p2-av-c" id="p2av" onclick="pick('f-p2av')"></div>
                        <div class="p2-text-c">
                            <div class="info-clean" id="p2bio" onclick="editT('p2bio','u_p2bio')">å…³äºèŒ‰è‰çš„ä¸€åˆ‡</div>
                            <div class="info-clean" id="p2loc" onclick="editT('p2loc','u_p2loc')">Molly Island</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:15px; height:125px; margin-top:10px">
                        <div class="short-frame" id="p2memo" onclick="pick('f-p2memo')">+</div>
                        <!-- ç¬¬äºŒé¡µå³ä¸Šè§’4ä¸ªåº”ç”¨ï¼šç§˜å¯†ï¼Œçºªå¿µæ—¥ï¼Œè§£å¿§æ‚è´§é“ºï¼Œæ·˜å®é—ªè´­ -->
                        <div class="unified-grid-4">
                            <div class="std-icon" id="i-secret" onclick="openApp('secret')" title="ç§˜å¯†"></div>
                            <div class="std-icon" id="i-memory" onclick="openApp('memory')" title="çºªå¿µæ—¥"></div>
                            <div class="std-icon" id="i-shop" onclick="openApp('shop')" title="è§£å¿§æ‚è´§é“º"></div>
                            <div class="std-icon" id="i-taobao" onclick="openApp('taobao')" title="æ·˜å®é—ªè´­"></div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1.2fr; gap:15px; flex:1">
                        <!-- å·¦ä¸‹è§’4ä¸ªåº”ç”¨ï¼šgogogoï¼ˆçº¿ä¸‹æ¨¡å¼ï¼‰ï¼Œé¢„è®¾ï¼ŒæŠ–éŸ³ï¼Œå°ç‹—æœˆå† -->
                        <div style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-content:flex-start;">
                            <div class="std-icon" id="i-gogogo" onclick="openApp('gogogo')" title="GoGoGo">ğŸ“</div>
                            <div class="std-icon" id="i-preset" onclick="openApp('preset')" title="é¢„è®¾">âš™ï¸</div>
                            <div class="std-icon" id="i-douyin" onclick="openApp('douyin')" title="æŠ–éŸ³">ğŸµ</div>
                            <div class="std-icon" id="i-calendar" onclick="openApp('calendar')" title="å°ç‹—æœˆå†">ğŸ“…</div>
                        </div>
                        <!-- å³ä¸‹è§’å•ç‹¬æ¸¸æˆæœºæ ·å¼çš„appï¼šæ¬²æœ›å›å»Š -->
                        <div class="gb-shell-long" onclick="openApp('desire')">
                            <div class="gb-screen-long"><div id="gs">â™¾ï¸<br>æ¬²æœ›å›å»Š</div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ 4ä¸ªåº”ç”¨ï¼šå¾®ä¿¡ï¼Œæ¼‚æµç“¶ï¼Œä¸–ç•Œä¹¦ï¼Œè®¾ç½® -->
        <div class="dock-container" id="dock">
            <div class="page-dots"><div class="dot d1"></div><div class="dot d2"></div></div>
            <div class="dock-bar">
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dch" onclick="openApp('wechat')">ğŸ’¬</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dbo" onclick="openApp('bottle')">ğŸ¼</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dbk" onclick="openApp('worldbook')">ğŸ“š</div>
                <div class="std-icon" style="width:52px; height:52px; font-size:24px;" id="dst" onclick="openApp('settings')">âš™ï¸</div>
            </div>
        </div>

        <!-- âš™ï¸ è®¾ç½®åº”ç”¨ -->
        <div class="settings-app" id="settings-app">
            <div class="sa-header">
                <div class="sa-back paw-back" onclick="closeCurrentPage()">è¿”å›</div>
                <div style="flex: 1; text-align: center;" id="settings-title">ç³»ç»Ÿè®¾ç½®</div>
                <div style="width: 40px;"></div>
            </div>

            <div class="sa-body" id="sa-body">
                <!-- å†…å®¹é€šè¿‡JSåŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- ğŸ’¬ å¾®ä¿¡åº”ç”¨ -->
        <div class="wc-app" id="wc-app">
            <div class="wc-header">
                <div class="wc-h-left" onclick="closeApp('wechat')">
                    <span id="wc-back-arrow" style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span id="wc-h-txt">æ¶ˆæ¯</span>
                </div>
                <div class="wc-h-right" id="wc-plus-btn" onclick="window.wcToggleMenu()">+</div>
            </div>

            <div class="wc-popover" id="wc-menu">
                <div class="wc-menu-item" onclick="window.wcShowAdd()"><span>ğŸ‘¤</span> æ·»åŠ å¥½å‹</div>
                <div class="wc-menu-item" onclick="window.wcShowNewChat()"><span>ğŸ’¬</span> å‘èµ·ç¾¤èŠ</div>
            </div>

            <div class="wc-body">
                <div id="wc-chat-list"></div>
                <div id="wc-contact-list"></div>
            </div>

            <!-- ä¿®æ”¹åçš„å¾®ä¿¡åº•éƒ¨å¯¼èˆªæ ï¼Œåªä¿ç•™æ¶ˆæ¯å’Œé€šè®¯å½• -->
            <div class="wc-footer">
                <div class="wc-tab active" id="tab-chat" onclick="window.wcSwitchTab('chat')"><div class="wc-tab-icon">ğŸ’¬</div><div class="wc-tab-txt">æ¶ˆæ¯</div></div>
                <div class="wc-tab" id="tab-contact" onclick="window.wcSwitchTab('contact')"><div class="wc-tab-icon">ğŸ“’</div><div class="wc-tab-txt">é€šè®¯å½•</div></div>
                <!-- ç§»é™¤äº†æœ‹å‹åœˆå’Œæˆ‘çš„ä¸¤ä¸ªé€‰é¡¹ -->
            </div>

            <div class="wc-modal-mask" id="wc-modal-add">
                <div class="wc-modal">
                    <div class="wc-modal-head">æ·»åŠ å¥½å‹</div>
                    <div class="wc-add-content"><div class="wc-up-av" id="wc-new-av" onclick="pick('f-wc-av')"></div><input type="text" id="wc-new-name" class="wc-input" placeholder="âœ¨ è¾“å…¥å¥½å‹å¤‡æ³¨"></div>
                    <div class="wc-modal-btns"><div class="wc-m-btn wc-btn-cancel" onclick="window.wcHideAdd()">å–æ¶ˆ</div><div class="wc-m-btn wc-btn-confirm" onclick="window.wcConfirmAdd()">ç¡®è®¤æ·»åŠ </div></div>
                </div>
            </div>

            <div class="wc-modal-mask" id="wc-modal-chat">
                <div class="wc-modal">
                    <div class="wc-modal-head">é€‰æ‹©å¥½å‹</div>
                    <div class="wc-sel-list" id="wc-friend-select"></div>
                    <div class="wc-modal-btns"><div class="wc-m-btn wc-btn-cancel" onclick="document.getElementById('wc-modal-chat').style.display='none'">å–æ¶ˆ</div><div class="wc-m-btn wc-btn-confirm" onclick="window.wcConfirmChat()">å‘èµ·ç¾¤èŠ</div></div>
                </div>
            </div>

            <div id="wc-chat-window" class="wc-chat-window">
                <div class="c-header">
                    <div class="ch-l" onclick="window.closeChat()"><span><</span><span>è¿”å›</span></div>
                    <div class="ch-m"><div class="ch-name" id="c-title">æ˜µç§°</div><div class="ch-status"><span style="color:#4caf50">â—</span> åœ¨çº¿</div></div>
                    <div class="ch-r"><div class="ch-icon-btn" onclick="window.toggleFootprint()">ğŸ¾</div><div class="ch-icon-btn" onclick="window.openSettings()">â€¢â€¢â€¢</div></div>
                </div>

                <div class="c-body" id="c-msg-list"></div>

                <div class="c-footer">
                    <div class="cf-icon" onclick="window.togglePanel('emoji')">â˜º</div>
                    <input type="text" class="cf-input" id="c-input" oninput="window.handleInput(this)" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <div class="cf-bone" id="btn-bone" onclick="window.triggerReply()">ğŸ¦´</div>
                    <div class="cf-icon" id="btn-plus" onclick="window.togglePanel('plus')">âŠ•</div>
                    <div class="btn-send" id="btn-send" onclick="window.sendMsg()">å‘é€</div>
                </div>

                <div class="c-panel" id="p-plus">
                    <div class="grid-menu"><div class="gm-item"><div class="gm-icon">ğŸ’°</div>è½¬è´¦</div><div class="gm-item"><div class="gm-icon">ğŸ±</div>é¥¿äº†å—</div><div class="gm-item"><div class="gm-icon">ğŸ“</div>ä½ç½®</div><div class="gm-item"><div class="gm-icon">ğŸ“</div>è¯­éŸ³é€šè¯</div><div class="gm-item"><div class="gm-icon">ğŸ“·</div>å›¾ç‰‡</div><div class="gm-item"><div class="gm-icon">ğŸµ</div>ä¸€èµ·å¬</div></div>
                </div>
                <div class="c-panel" id="p-emoji" style="text-align:center; color:#999; padding-top:20px;">(æš‚æ— è¡¨æƒ…)</div>
                <div class="foot-panel" id="p-foot"></div>

                <div class="settings-page" id="p-settings">
                    <div class="s-header">
                        <div class="s-back paw-back" onclick="document.getElementById('p-settings').style.display='none'">è¿”å›</div>
                        <div style="flex:1; text-align:center">èŠå¤©ä¿¡æ¯</div>
                        <div style="width:40px"></div>
                    </div>
                    <div class="s-body">
                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="window.sSearch()"><div class="s-label">æŸ¥æ‰¾èŠå¤©è®°å½•</div></div>
                            <div class="s-row s-arrow" onclick="window.sLinkGroup()"><div class="s-label">å…³è”ç¾¤èŠ</div></div>
                        </div>

                        <div class="section-title">å…³äº AI è®°å¿†</div>
                        <div class="s-group">
                            <div class="s-row">
                                <div class="s-label">è®°å¿†æ¡æ•°</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="200" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">200</span>
                                </div>
                            </div>
                            <div class="s-row">
                                <div class="s-label">å…³è”è®°å¿†</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="50" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">50</span>
                                </div>
                            </div>
                            <div class="s-row">
                                <div class="s-label">è‡ªåŠ¨æ€»ç»“</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="300" value="100" oninput="this.nextElementSibling.innerText=this.value; window.saveSettings()">
                                    <span class="slider-val">100</span>
                                </div>
                            </div>

                            <div class="s-row">
                                <div class="s-label">å…¬ä¼—äººç‰©</div>
                                <input type="text" class="s-input" placeholder="è¾“å…¥åç§°" style="text-align:right">
                            </div>

                            <div class="s-row" style="flex-direction:column; align-items:flex-start; height:auto; padding-bottom:15px;">
                                <div class="s-label" style="margin-bottom:5px">æè¿°</div>
                                <textarea class="s-textarea" rows="6" placeholder="è¯·è¾“å…¥æè¿°..."></textarea>
                            </div>
                        </div>

                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="window.sBindWorld()"><div class="s-label">ä¸–ç•Œä¹¦ç»‘å®š</div><div class="s-val">æ— </div></div>
                            <div class="s-row s-arrow" onclick="window.sBindPreset()"><div class="s-label">é¢„è®¾ç»‘å®š</div><div class="s-val">é»˜è®¤</div></div>
                        </div>

                        <div class="s-group">
                            <div class="s-row"><div class="s-label">æ‹ä¸€æ‹</div><div class="s-switch" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row"><div class="s-label">åç¼€</div><input type="text" class="s-input" value="æ‹äº†æ‹ä»–çš„è„‘è¢‹" style="text-align:right"></div>
                            <div class="s-row"><div class="s-label">éŸ³è‰² ID</div><input type="text" class="s-input" placeholder="è¾“å…¥ID" style="text-align:right"></div>
                        </div>

                        <div class="section-title">å¤–è§‚</div>
                        <div class="s-group">
                            <div class="s-row s-arrow" onclick="pick('f-chat-bg')"><div class="s-label">èŠå¤©å£çº¸</div></div>

                            <div class="s-row" style="flex-direction:column; align-items:stretch; height:auto; padding-bottom:15px;">
                                <div class="s-label" style="margin-bottom:8px">æ°”æ³¡CSS</div>
                                <div class="bubble-preview-box">
                                    <div class="pv-row">
                                        <div class="pv-av"></div>
                                        <div class="pv-bubble them" id="demo-bubble-them">å¯¹æ–¹çš„æ¶ˆæ¯æ°”æ³¡</div>
                                    </div>
                                    <div class="pv-row me">
                                        <div class="pv-av" style="background:#95ec69"></div>
                                        <div class="pv-bubble me">æˆ‘çš„æ¶ˆæ¯æ°”æ³¡</div>
                                    </div>
                                </div>
                                <textarea id="css-input-area" class="s-textarea" rows="4" placeholder="ä¾‹å¦‚ï¼šbackground: #ffe4e1; color: #d63384; border-radius: 12px;"></textarea>
                                <div style="display:flex; margin-top:8px;">
                                    <div class="btn-confirm-mini" onclick="window.updateCssPreview()">ç¡®è®¤</div>
                                </div>
                            </div>
                        </div>

                        <div class="section-title">AI ä¸»åŠ¨å‘é€</div>
                        <div class="s-group">
                            <div class="s-row"><div class="s-label">å›ºå®šæ—¶é—´å‘é€</div><div class="s-switch" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row"><div class="s-label">æ€è€ƒæ˜¯å¦å‘é€</div><div class="s-switch on" onclick="this.classList.toggle('on')"></div></div>
                            <div class="s-row">
                                <div class="s-label">é—´éš” (åˆ†)</div>
                                <div style="display:flex; align-items:center; gap:10px; flex:1; justify-content:flex-end">
                                    <input type="range" class="s-slider" min="0" max="60" value="30" oninput="this.nextElementSibling.innerText=this.value">
                                    <span class="slider-val">30</span>
                                </div>
                            </div>
                        </div>

                        <div class="s-group">
                            <div class="s-row" onclick="window.sExport()"><div class="s-label">å¯¼å‡ºèŠå¤©è®°å½•</div><div class="s-arrow"></div></div>
                            <div class="s-row"><div class="s-label s-btn-red" onclick="window.sClear()">æ¸…ç©ºèŠå¤©è®°å½•</div></div>
                            <div class="s-row"><div class="s-label s-btn-red" onclick="window.sDelete()">åˆ é™¤è¯¥èŠå¤©</div></div>
                            <div class="s-row"><div class="s-label s-btn-red" style="color:darkred" onclick="window.sBlock()">âš ï¸ æ‹‰é»‘è¯¥èŠå¤©</div></div>
                        </div>
                    </div>
                </div>
            </div> 
            <div class="settings-page" id="p-profile">
                <div class="s-header">
                    <div class="s-back paw-back" onclick="document.getElementById('p-profile').style.display='none'">è¿”å›</div>
                    <div style="flex:1; text-align:center">å¥½å‹èµ„æ–™</div>
                    <div style="width:40px"></div>
                </div>
                <div class="s-body">
                    <div class="s-group" style="padding:20px; display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <div class="wc-up-av" id="pf-av" onclick="pick('f-pf-av')"></div>
                        <div style="color:#999; font-size:12px;">ç‚¹å‡»æ›´æ¢å¤´åƒ</div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label">ç½‘å</div>
                            <input type="text" class="s-input" id="pf-name" style="text-align:right">
                        </div>
                        <div class="s-row">
                            <div class="s-label">å¤‡æ³¨</div>
                            <input type="text" class="s-input" id="pf-alias" placeholder="è®¾ç½®å¤‡æ³¨" style="text-align:right">
                        </div>
                    </div>

                    <div class="section-title">äººç‰©è®¾å®š</div>
                    <div class="s-group">
                        <div class="s-row" style="flex-direction:column; align-items:flex-start; height:auto; padding-bottom:15px;">
                            <div class="s-label" style="margin-bottom:5px">æè¿°</div>
                            <textarea class="s-textarea" id="pf-desc" rows="6" placeholder="å¹´é¾„ã€æ€§æ ¼ã€é•¿ç›¸ã€å…³ç³»..."></textarea>
                        </div>
                        <div class="s-row">
                            <div class="s-label">ä¸ªæ€§ç­¾å</div>
                            <input type="text" class="s-input" id="pf-sign" style="text-align:right">
                        </div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label">è®¾ä¸ºæ˜Ÿæ ‡å¥½å‹</div>
                            <div class="s-switch" id="pf-star" onclick="this.classList.toggle('on')"></div>
                        </div>
                    </div>

                    <div class="s-group">
                        <div class="s-row">
                            <div class="s-label s-btn-red" style="color:#576b95; font-weight:600;" onclick="window.saveProfile()">ä¿å­˜å¹¶æ›´æ–°</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ğŸ¼ æ¼‚æµç“¶åº”ç”¨ -->
        <div class="app-container" id="bottle-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('bottle')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span>æ¼‚æµç“¶</span>
                </div>
                <div class="app-h-right" onclick="alert('æ¼‚æµç“¶åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large">ğŸ¼</div>
                    <h3>æ¼‚æµç“¶</h3>
                    <p>æ‰”ä¸€ä¸ªæ¼‚æµç“¶ï¼Œæˆ–è€…æä¸€ä¸ªçœ‹çœ‹<br>åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ğŸ“š ä¸–ç•Œä¹¦åº”ç”¨ -->
        <div class="app-container" id="worldbook-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('worldbook')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span>ä¸–ç•Œä¹¦</span>
                </div>
                <div class="app-h-right" onclick="alert('ä¸–ç•Œä¹¦åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large">ğŸ“š</div>
                    <h3>ä¸–ç•Œä¹¦</h3>
                    <p>è®°å½•ä¸–ç•Œçš„æ•…äº‹<br>åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>

        <!-- ğŸ® å…¶ä»–åº”ç”¨å®¹å™¨ï¼ˆé€šç”¨ï¼‰ -->
        <div class="app-container" id="generic-app">
            <div class="app-header">
                <div class="app-h-left" onclick="closeApp('generic')">
                    <span style="font-weight:bold; margin-right:5px">&lt;</span>
                    <span id="generic-app-title">åº”ç”¨</span>
                </div>
                <div class="app-h-right" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­')">+</div>
            </div>
            <div class="app-body">
                <div class="app-empty-content">
                    <div class="app-icon-large" id="generic-app-icon">ğŸ“±</div>
                    <h3 id="generic-app-name">åº”ç”¨</h3>
                    <p id="generic-app-desc">åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </div>
        </div>
    <script>
        /* ===========================
       âœ… å…¨å±€é»˜è®¤é…ç½® (å¿…é¡»æ”¾åœ¨æœ€å‰é¢ï¼)
       =========================== */
    const defaultAppSettings = {
        theme: {
            lockWallpaper: '',
            desktopWallpaper: '',
            desktopWallpaper2: '',
            appIcons: {},
            primaryColor: '#07c160'
        },
        font: {
            enabled: false,
            url: '',
            name: 'é»˜è®¤å­—ä½“'
        },
        apis: {
            primary: {
                provider: 'openai',
                endpoint: 'https://api.openai.com/v1',
                apiKey: '',
                model: 'gpt-3.5-turbo',
                availableModels: ['gpt-3.5-turbo', 'gpt-4'],
                enabled: true
            },
            secondary: {
                provider: 'gemini',
                endpoint: 'https://generativelanguage.googleapis.com/v1',
                apiKey: '',
                model: 'gemini-2.0-flash-exp',
                availableModels: ['gemini-2.0-flash-exp', 'gemini-1.5-flash'],
                enabled: true,
                function: 'memory_management'
            }
        },
        voice: {
            enabled: false,
            provider: 'minimax',
            apiKey: '',
            groupId: '',
            voiceId: ''
        },
        backup: {
            autoBackup: false,
            interval: 24,
            lastBackup: null,
            location: 'local',
            githubToken: '',
            githubRepo: ''
        },
        system: {
            notifications: true,
            vibration: true,
            autoClearCache: true,
            language: 'zh-CN'
        }
    };

    // ğŸ”’ 1. é”å±æ»‘åŠ¨é€»è¾‘ (æœ€ä¼˜å…ˆï¼Œæ— ä¾èµ–)
    let sY=0, sX=0;
    const ls=document.getElementById('lock-screen'), box=document.getElementById('box'), sw=document.getElementById('main-desktop');

    ls.addEventListener('touchstart', e=>{ sY=e.touches[0].clientY; });
    ls.addEventListener('touchend', e=>{ 
        let dist = sY - e.changedTouches[0].clientY;
        if(dist > 50 || Math.abs(dist) < 10) { 
            box.classList.add('unlocked');
            setTimeout(()=>{ ls.style.display='none'; }, 400); 
        }
    });

            // 2. åŸºç¡€å·¥å…· - å…¨èƒ½ä¿®å¤ç‰ˆ (åŒ…å«ä¸Šä¼ ã€æ–‡å­—ã€æ—¶é’Ÿ)

    // è§¦å‘æ–‡ä»¶é€‰æ‹©
    window.pick = function(id){ 
        const el = document.getElementById(id);
        if(el) el.click(); 
        else console.error('æ‰¾ä¸åˆ°æ–‡ä»¶ä¸Šä¼ æ§ä»¶:', id);
    }

    // ä¿®æ”¹æ–‡å­—
    window.editT = function(id,k){ 
        const el = document.getElementById(id);
        if(!el) return;
        const n=prompt("ä¿®æ”¹æ–‡å­—ï¼š", el.innerText); 
        if(n){ 
            el.innerText=n; 
            localStorage.setItem(k,n); 
        }
    }

    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šé€šç”¨å›¾ç‰‡ä¸Šä¼  (å¤„ç†å¤´åƒã€ç›¸æ¡†ç­‰)
    window.h = function(k){ 
        // æ‰¾åˆ°å¯¹åº”çš„ hidden input
        const input = document.getElementById('f-'+k);
        if(!input || !input.files || !input.files[0]) return;

        const f = input.files[0]; 
        const r = new FileReader(); 
        r.onload = (e)=>{
            const dataUrl = e.target.result;
            // 1. å­˜å…¥ç¼“å­˜
            localStorage.setItem('u_'+k, dataUrl); 
            // 2. ç«‹å³åˆ·æ–°ç”»é¢
            updateWallpaperPreview(k, dataUrl);
            // 3. æç¤ºæˆåŠŸ
            showUploadSuccess();
        }; 
        r.readAsDataURL(f); 
    }

    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šåº”ç”¨å›¾æ ‡ä¸Šä¼ 
    window.hIcon = function(appId){ 
        const input = document.getElementById('f-icon-'+appId);
        if(!input || !input.files || !input.files[0]) return;

        const f = input.files[0]; 
        const r = new FileReader(); 
        r.onload = (e)=>{
            const dataUrl = e.target.result;
            localStorage.setItem('app_icon_'+appId, dataUrl); 

            const icon = document.getElementById('i-'+appId);
            if(icon) {
                icon.style.backgroundImage = 'url(' + dataUrl + ')';
                icon.classList.add('has-img');
                icon.innerHTML = '';
            }
            showUploadSuccess();
        }; 
        r.readAsDataURL(f); 
    }

    // ğŸŸ¢ æ ¸å¿ƒä¿®å¤ï¼šç”»é¢åˆ·æ–°é€»è¾‘ (ç¡®ä¿å›¾ç‰‡èƒ½æ˜¾ç¤ºå‡ºæ¥)
    window.updateWallpaperPreview = function(type, dataUrl) {
        const settings = getAppSettings();

        // A. å£çº¸ç±»
        if(type === 'wall' || type === 'lph') {
            document.getElementById('global-wall').style.backgroundImage = 'url(' + dataUrl + ')';
            const lPre = document.getElementById('l-pre');
            if(lPre) {
                lPre.innerHTML = '';
                lPre.style.backgroundImage = 'url(' + dataUrl + ')';
                lPre.style.backgroundSize = 'cover';
                lPre.style.backgroundPosition = 'center';
            }
            settings.theme.lockWallpaper = dataUrl;
        } 
        else if(type === 'desktop1') {
            const d1 = document.querySelector('.desktop-page:first-child');
            if(d1) d1.style.backgroundImage = 'url(' + dataUrl + ')';
            settings.theme.desktopWallpaper = dataUrl;
        } 
        else if(type === 'desktop2') {
            const d2 = document.querySelector('.desktop-page:nth-child(2)');
            if(d2) d2.style.backgroundImage = 'url(' + dataUrl + ')';
            settings.theme.desktopWallpaper2 = dataUrl;
        }

        // B. å°ç»„ä»¶ç±» (å…³é”®æ˜ å°„è¡¨)
        const componentMap = {
            'avL': 'avL',        // æ¡Œé¢1 å·¦å¤´åƒ
            'avR': 'avR',        // æ¡Œé¢1 å³å¤´åƒ
            'pwall': 'i-p-wall', // æ¡Œé¢1 çŒ«è€³æœµç›¸æ¡†
            'p2bg': 'p2bg',      // æ¡Œé¢2 é¡¶éƒ¨èƒŒæ™¯
            'p2av': 'p2av',      // æ¡Œé¢2 å¤´åƒ
            'p2memo': 'p2memo'   // æ¡Œé¢2 å°æ–¹æ¡†
        };

        if (componentMap[type]) {
            const el = document.getElementById(componentMap[type]);
            if (el) {
                el.style.backgroundImage = 'url(' + dataUrl + ')';
                el.style.backgroundSize = 'cover';
                el.style.backgroundPosition = 'center';
                // æ¸…ç©ºé‡Œé¢çš„"+"å·
                if(el.innerHTML.includes('+') || el.innerText.trim() === '+') {
                    el.innerHTML = '';
                }
            }
        }

        saveAppSettings(settings);
    }

    // æ˜¾ç¤ºæˆåŠŸæç¤º
    function showUploadSuccess() {
        const successDiv = document.getElementById('upload-success');
        if(successDiv) {
            successDiv.style.display = 'block';
            successDiv.style.animation = 'fadeInOut 2s ease-in-out';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 2000);
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°æç¤ºæ¡†ï¼Œç”¨å¼¹çª—å…œåº•
            console.log('âœ… ä¸Šä¼ æˆåŠŸ'); 
        }
    }

    // â° æ—¶é’Ÿé€»è¾‘ (æ”¾åœ¨è¿™é‡Œç¡®ä¿ä¸ä¸¢å¤±)
    function up(){
        const n=new Date(); 
        const t=n.getHours().toString().padStart(2,'0')+":"+n.getMinutes().toString().padStart(2,'0');

        const lTime = document.getElementById('l-time');
        const dTime = document.getElementById('d-time');
        if(lTime) lTime.innerText = t;
        if(dTime) dTime.innerText = t;

        const opt={month:'long',day:'numeric',weekday:'long'}; 
        const lDate = document.getElementById('l-date');
        if(lDate) lDate.innerText=n.toLocaleDateString('zh-CN',opt);

        const s=n.getSeconds()*6, m=n.getMinutes()*6, h=n.getHours()%12*30+m/12;
        const hs = document.getElementById('h-s');
        const hm = document.getElementById('h-m');
        const hh = document.getElementById('h-h');

        if(hs) hs.style.transform = "rotate(" + s + "deg)";
        if(hm) hm.style.transform = "rotate(" + m + "deg)";
        if(hh) hh.style.transform = "rotate(" + h + "deg)";
    }
    setInterval(up, 1000); 
    up();



    // 3. æ¡Œé¢æ»‘åŠ¨
    sw.addEventListener('touchstart', e=>sX=e.touches[0].clientX);
    sw.addEventListener('touchend', e=>{ 
        const d=e.changedTouches[0].clientX-sX; 
        if(Math.abs(d)>60) {
            box.classList.toggle('page-1', d>0); 
            box.classList.toggle('page-2', d<0); 
        }
    });

    // 4. åº”ç”¨ç®¡ç†
    let currentApp = null;
    let settingsHistory = []; // ç”¨äºè®°å½•è®¾ç½®é¡µé¢çš„æµè§ˆå†å²

    // åº”ç”¨é…ç½®
    const apps = {
        // æ¡Œé¢ç¬¬ä¸€é¡µ
        'weibo': { name: 'å¾®åš', icon: 'ğŸ“±', desc: 'å¾®åšç¤¾äº¤åº”ç”¨' },
        'date': { name: 'çº¦ä¼š', icon: 'â¤ï¸', desc: 'çº¦ä¼šæé†’åº”ç”¨' },
        'music': { name: 'ç½‘æ˜“äº‘', icon: 'ğŸµ', desc: 'éŸ³ä¹æ’­æ”¾åº”ç”¨' },
        'game': { name: 'æ¸¸æˆ', icon: 'ğŸ®', desc: 'æ¸¸æˆä¸­å¿ƒ' },

        // æ¡Œé¢ç¬¬äºŒé¡µ
        'secret': { name: 'ç§˜å¯†', icon: 'ğŸ”’', desc: 'ç§å¯†ç©ºé—´' },
        'memory': { name: 'çºªå¿µæ—¥', icon: 'ğŸ—“ï¸', desc: 'çºªå¿µæ—¥æé†’' },
        'shop': { name: 'è§£å¿§æ‚è´§é“º', icon: 'ğŸ ', desc: 'è´­ç‰©åº”ç”¨' },
        'taobao': { name: 'æ·˜å®é—ªè´­', icon: 'ğŸ›ï¸', desc: 'è´­ç‰©åº”ç”¨' },
        'gogogo': { name: 'GoGoGo', icon: 'ğŸ“', desc: 'çº¿ä¸‹æ¨¡å¼' },
        'preset': { name: 'é¢„è®¾', icon: 'âš™ï¸', desc: 'ç³»ç»Ÿé¢„è®¾' },
        'douyin': { name: 'æŠ–éŸ³', icon: 'ğŸµ', desc: 'çŸ­è§†é¢‘åº”ç”¨' },
        'calendar': { name: 'å°ç‹—æœˆå†', icon: 'ğŸ“…', desc: 'ç”Ÿç†æœŸè®°å½•' },
        'desire': { name: 'æ¬²æœ›å›å»Š', icon: 'â™¾ï¸', desc: 'ç‰¹æ®Šåº”ç”¨' },

        // åº•éƒ¨çŠ¶æ€æ 
        'wechat': { name: 'å¾®ä¿¡', icon: 'ğŸ’¬', desc: 'å³æ—¶é€šè®¯' },
        'bottle': { name: 'æ¼‚æµç“¶', icon: 'ğŸ¼', desc: 'æ¼‚æµç“¶åº”ç”¨' },
        'worldbook': { name: 'ä¸–ç•Œä¹¦', icon: 'ğŸ“š', desc: 'çŸ¥è¯†åº“åº”ç”¨' },
        'settings': { name: 'è®¾ç½®', icon: 'âš™ï¸', desc: 'ç³»ç»Ÿè®¾ç½®' },

        // å¾®ä¿¡å†…åº”ç”¨
        'moments': { name: 'æœ‹å‹åœˆ', icon: 'ğŸ§­', desc: 'ç¤¾äº¤åŠ¨æ€' },
        'profile': { name: 'æˆ‘çš„', icon: 'ğŸ™‚', desc: 'ä¸ªäººèµ„æ–™' }
    };

    // æ‰“å¼€åº”ç”¨
    window.openApp = function(appId) {
        console.log('æ‰“å¼€åº”ç”¨:', appId, apps[appId]);

        // éšè—æ‰€æœ‰åº”ç”¨
        document.querySelectorAll('.app-container, .wc-app, .settings-app').forEach(app => {
            app.classList.remove('active');
        });

        // æ›´æ–°å½“å‰åº”ç”¨
        currentApp = appId;

        // ç‰¹æ®Šå¤„ç†å¾®ä¿¡å’Œè®¾ç½®åº”ç”¨
        if(appId === 'wechat') {
            document.getElementById('wc-app').classList.add('active');
            wcRenderChats();
        } else if(appId === 'settings') {
            openSettingsApp();
        } else if(appId === 'bottle') {
            document.getElementById('bottle-app').classList.add('active');
        } else if(appId === 'worldbook') {
            document.getElementById('worldbook-app').classList.add('active');
        } else {
            // é€šç”¨åº”ç”¨å¤„ç†
            const app = apps[appId];
            if(app) {
                const genericApp = document.getElementById('generic-app');
                document.getElementById('generic-app-title').innerText = app.name;
                document.getElementById('generic-app-icon').innerText = app.icon;
                document.getElementById('generic-app-name').innerText = app.name;
                document.getElementById('generic-app-desc').innerHTML = `${app.desc}<br>åŠŸèƒ½å¼€å‘ä¸­...`;
                genericApp.classList.add('active');
            }
        }
    };

    // å…³é—­åº”ç”¨
    window.closeApp = function(appId) {
        console.log('å…³é—­åº”ç”¨:', appId);

        if(appId === 'wechat') {
            document.getElementById('wc-app').classList.remove('active');
        } else if(appId === 'bottle') {
            document.getElementById('bottle-app').classList.remove('active');
        } else if(appId === 'worldbook') {
            document.getElementById('worldbook-app').classList.remove('active');
        } else {
            document.getElementById('generic-app').classList.remove('active');
        }

        currentApp = null;
    };

    // å…³é—­å½“å‰é¡µé¢ï¼ˆç”¨äºè®¾ç½®åº”ç”¨ï¼‰ - ä¿®å¤ç™½å±é—®é¢˜
    window.closeCurrentPage = function() {
        console.log('å…³é—­å½“å‰é¡µé¢ï¼Œå†å²è®°å½•:', settingsHistory);

        if(settingsHistory.length > 1) {
            // è¿”å›ä¸Šä¸€çº§è®¾ç½®é¡µé¢
            settingsHistory.pop();
            const lastPage = settingsHistory[settingsHistory.length - 1];
            console.log('è¿”å›ä¸Šä¸€çº§:', lastPage);
            renderSettingsPage(lastPage);
        } else {
            // å…³é—­è®¾ç½®åº”ç”¨
            console.log('å…³é—­è®¾ç½®åº”ç”¨');
            closeSettingsApp();
        }
    };

           function load(){
        console.log('æ­£åœ¨åŠ è½½æ‰€æœ‰è‡ªå®šä¹‰è®¾ç½®...');

        // ===========================
        // 1. æ¢å¤å£çº¸ (ä¼˜å…ˆè¯»å–è®¾ç½®ï¼Œå…¶æ¬¡è¯»å–æ—§ç¼“å­˜)
        // ===========================
        const settings = getAppSettings();
        try {
            const wall = settings.theme.lockWallpaper || localStorage.getItem('u_wall'); 
            if(wall) {
                document.getElementById('global-wall').style.backgroundImage='url('+wall+')';
                // æ¢å¤é”å±é¢„è§ˆæ¡†
                const lPre = document.getElementById('l-pre');
                if(lPre) {
                    lPre.innerHTML = '';
                    lPre.style.backgroundImage = 'url(' + wall + ')';
                    lPre.style.backgroundSize = 'cover';
                    lPre.style.backgroundPosition = 'center';
                }
            }

            // æ¢å¤æ¡Œé¢å£çº¸
            if(settings.theme.desktopWallpaper) {
                const d1 = document.querySelector('.desktop-page:first-child');
                if(d1) d1.style.backgroundImage = 'url(' + settings.theme.desktopWallpaper + ')';
            }
            if(settings.theme.desktopWallpaper2) {
                const d2 = document.querySelector('.desktop-page:nth-child(2)');
                if(d2) d2.style.backgroundImage = 'url(' + settings.theme.desktopWallpaper2 + ')';
            }
        } catch(e) { console.error('å£çº¸åŠ è½½é”™è¯¯', e); }

        // ===========================
        // 2. æ¢å¤æ‰€æœ‰è‡ªå®šä¹‰æ–‡å­—ç»„ä»¶
        // ===========================
        // åˆ—è¡¨ï¼š[DOM ID, Storage Key]
        const textComponents = [
            ['lkp', 'u_lkp'],       // é”å±é¡¶éƒ¨æ–‡å­—
            ['dl1', 'u_dl1'],       // æ¡Œé¢1 æ—¥è®°è¡Œ1
            ['dl2', 'u_dl2'],       // æ¡Œé¢1 æ—¥è®°è¡Œ2
            ['dl3', 'u_dl3'],       // æ¡Œé¢1 æ—¥è®°è¡Œ3
            ['mt1', 'u_mt1'],       // æ¡Œé¢1 è·ç¦»
            ['mt2', 'u_mt2'],       // æ¡Œé¢1 æ—¶é—´
            ['p1-msg1', 'u_msg1'],  // æ¡Œé¢1 æ°”æ³¡å·¦
            ['p1-msg2', 'u_msg2'],  // æ¡Œé¢1 æ°”æ³¡å³
            ['p2bio', 'u_p2bio'],   // æ¡Œé¢2 ç®€ä»‹
            ['p2loc', 'u_p2loc']    // æ¡Œé¢2 åœ°ç‚¹
        ];

        textComponents.forEach(item => {
            const domId = item[0];
            const storeKey = item[1];
            const savedText = localStorage.getItem(storeKey);
            if(savedText) {
                const el = document.getElementById(domId);
                if(el) el.innerText = savedText;
            }
        });

        // ===========================
        // 3. æ¢å¤æ‰€æœ‰è‡ªå®šä¹‰å›¾ç‰‡ç»„ä»¶
        // ===========================
        // åˆ—è¡¨ï¼š[DOM ID, Storage Key]
        const imgComponents = [
            ['avL', 'u_avL'],         // æ¡Œé¢1 å·¦å¤´åƒ
            ['avR', 'u_avR'],         // æ¡Œé¢1 å³å¤´åƒ
            ['i-p-wall', 'u_pwall'],  // æ¡Œé¢1 çŒ«è€³æœµç›¸æ¡†
            ['p2bg', 'u_p2bg'],       // æ¡Œé¢2 é¡¶éƒ¨èƒŒæ™¯
            ['p2av', 'u_p2av'],       // æ¡Œé¢2 å¤´åƒ
            ['p2memo', 'u_p2memo']    // æ¡Œé¢2 å°æ–¹æ¡†
        ];

        imgComponents.forEach(item => {
            const domId = item[0];
            const storeKey = item[1];
            const savedImg = localStorage.getItem(storeKey);
            if(savedImg) {
                const el = document.getElementById(domId);
                if(el) {
                    el.style.backgroundImage = 'url(' + savedImg + ')';
                    el.style.backgroundSize = 'cover';
                    el.style.backgroundPosition = 'center';
                    // å¦‚æœæœ‰å†…å®¹ï¼ˆå¦‚+å·ï¼‰ï¼Œæ¸…ç©ºå®ƒ
                    if(el.innerText.trim() === '+' || el.innerHTML.includes('+')) {
                        el.innerHTML = '';
                    }
                }
            }
        });

        // ===========================
        // 4. æ¢å¤åº”ç”¨å›¾æ ‡ & å¾®ä¿¡æ•°æ®
        // ===========================
        Object.keys(apps).forEach(appId => {
            const icon = document.getElementById('i-' + appId);
            if(icon) {
                const savedIcon = localStorage.getItem('app_icon_' + appId);
                if(savedIcon) {
                    icon.style.backgroundImage = 'url(' + savedIcon + ')';
                    icon.classList.add('has-img');
                    icon.innerHTML = '';
                } else {
                    icon.innerHTML = apps[appId].icon;
                }
            }
        });

        try { 
            wcRenderChats(); 
            wcRenderContacts(); 
        } catch(e){}
    }



    window.gameAnim = function(){ 
        const s=document.getElementById('gs'); 
        s.innerHTML="LOADING...<br>å‰¯æœ¬ç”Ÿæˆä¸­"; 
        setTimeout(()=>{
            s.innerHTML="READY!<br>æ¬¢è¿æ¥åˆ°å›å»Š";
        },1500); 
    }

    /* ============================
       ğŸ’š WeChat Logic (é‡æ„ç‰ˆ)
       ============================ */
    let wcTempImg = "";
    let pfTempImg = "";
    let wcFriends = []; 
    try { 
        wcFriends = JSON.parse(localStorage.getItem('wc_friends') || "[]"); 
    } catch(e){ 
        wcFriends=[]; 
    }

    let wcChats = []; 
    try { 
        wcChats = JSON.parse(localStorage.getItem('wc_chats') || "[]"); 
    } catch(e){ 
        wcChats=[]; 
    }

    let currentChatUser = null;
    let currentEditingFriend = null;
    let isBlocked = false;

    window.wcOpen = function(){ 
        openApp('wechat');
    }

    window.wcClose = function(){ 
        closeApp('wechat'); 
        document.getElementById('wc-menu').style.display='none'; 
    }

    window.wcToggleMenu = function(){ 
        const m=document.getElementById('wc-menu'); 
        m.style.display = m.style.display==='flex'?'none':'flex'; 
    }

    // ğŸŸ¢ Tab åˆ‡æ¢é€»è¾‘
    window.wcSwitchTab = function(tab) {
        document.querySelectorAll('.wc-tab').forEach(t=>t.classList.remove('active'));
        document.getElementById('tab-'+tab).classList.add('active');

        const chatList = document.getElementById('wc-chat-list');
        const contactList = document.getElementById('wc-contact-list');

        const headerTxt = document.getElementById('wc-h-txt');
        const backArrow = document.getElementById('wc-back-arrow');
        const plusBtn = document.getElementById('wc-plus-btn');

        if(tab === 'chat') {
            chatList.style.display = 'block';
            contactList.style.display = 'none';
            headerTxt.innerText = 'æ¶ˆæ¯';
            backArrow.style.display = 'inline'; 
            plusBtn.style.visibility = 'visible'; 
            wcRenderChats();
        } else if(tab === 'contact') {
            chatList.style.display = 'none';
            contactList.style.display = 'block';
            headerTxt.innerText = 'é€šè®¯å½•';
            backArrow.style.display = 'none';
            plusBtn.style.visibility = 'hidden'; 
            wcRenderContacts();
        }
    }

    // æ·»åŠ å¥½å‹
    window.wcShowAdd = function(){ 
        document.getElementById('wc-menu').style.display='none'; 
        document.getElementById('wc-modal-add').style.display='flex'; 
        wcTempImg=""; 
        const el=document.getElementById('wc-new-av'); 
        el.style.backgroundImage='none'; 
        el.classList.remove('has-img'); 
        document.getElementById('wc-new-name').value=""; 
    }

    window.wcHideAdd = function(){ 
        document.getElementById('wc-modal-add').style.display='none'; 
    }

    window.wcHandleAv = function(i){ 
        const f=i.files[0]; 
        if(!f) return; 
        const r=new FileReader(); 
        r.onload=(e)=>{ 
            wcTempImg=e.target.result; 
            const el=document.getElementById('wc-new-av'); 
            el.style.backgroundImage='url('+wcTempImg+')'; 
            el.classList.add('has-img'); 
        }; 
        r.readAsDataURL(f); 
    }

    window.wcConfirmAdd = function(){
        const n=document.getElementById('wc-new-name').value;
        if(!n){ alert("è¯·è¾“å…¥å¤‡æ³¨"); return; }
        if(!wcFriends) wcFriends = [];

        // ç”Ÿæˆå”¯ä¸€ID
        const newId = Date.now().toString(); 

        const newFriend = { 
            id: newId, 
            name:n, 
            alias:n, 
            av:wcTempImg || "", 
            isStarred:false, 
            desc:"", 
            sign:"" 
        };
        wcFriends.push(newFriend);

        const chatObj = { 
            id: newId, 
            name: n, 
            av: wcTempImg || "", 
            last: "", 
            time: "åˆšåˆš", 
            isPinned:false, 
            messages:[] 
        };

        if(!wcChats.some(c=>c.id === newId)) { 
            wcChats.unshift(chatObj); 
        }

        saveAll();
        window.wcHideAdd();

        const isContactTab = document.getElementById('tab-contact').classList.contains('active');
        if(isContactTab) wcRenderContacts(); 
        else wcRenderChats();

        setTimeout(() => alert("å·²æ·»åŠ å¥½å‹"), 100);
    }

    window.wcShowNewChat = function(){
        document.getElementById('wc-menu').style.display='none';
        const list = document.getElementById('wc-friend-select');
        list.innerHTML = "";

        if(!wcFriends || wcFriends.length===0){ 
            list.innerHTML="<div style='text-align:center;color:#ccc;margin-top:20px'>æš‚æ— å¥½å‹</div>"; 
        } else {
            wcFriends.forEach((f)=>{
                const d=document.createElement('div'); 
                d.className='wc-sel-item';
                d.setAttribute('data-name', f.name);
                d.innerHTML='<div class="wc-sel-check"></div><div style="font-size:14px; font-weight:500; color:#333">'+(f.alias||f.name)+'</div>';
                d.onclick = function() { this.classList.toggle('selected'); };
                list.appendChild(d);
            });
        }
        document.getElementById('wc-modal-chat').style.display='flex';
    }

    window.wcConfirmChat = function(){
        const items = document.querySelectorAll('.wc-sel-item.selected');
        if(items.length === 0){ alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ä½å¥½å‹"); return; }
        const count = items.length;
        wcChats.unshift({ 
            name: (count>1?"ç¾¤èŠ ("+count+"äºº)":items[0].getAttribute('data-name')), 
            av:"", 
            last:"ä½ å‘èµ·äº†ç¾¤èŠ", 
            time:"åˆšåˆš", 
            isPinned:false, 
            messages:[] 
        });
        saveAll();
        wcRenderChats();
        document.getElementById('wc-modal-chat').style.display='none';
    }

    // ğŸŸ¢ æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨ - ä¼˜åŒ–å·¦æ»‘é€»è¾‘
    window.wcRenderChats = function(){
        const el = document.getElementById('wc-chat-list');
        // å…ˆæŒ‰ç½®é¡¶æ’åºï¼Œå†æŒ‰æ—¶é—´æ’åº
        wcChats.sort((a,b) => {
            if(a.isPinned && !b.isPinned) return -1;
            if(!a.isPinned && b.isPinned) return 1;
            return 0;
        });

        el.innerHTML="";
        if(!wcChats || wcChats.length===0) { 
            el.innerHTML='<div class="wc-empty">âœ¨ æš‚æ— æ¶ˆæ¯<br>ç‚¹å‡»å³ä¸Šè§’ + å‘èµ·ç¾¤èŠ</div>'; 
            return; 
        }

        wcChats.forEach((c, index)=>{
            const d=document.createElement('div'); 
            d.className = 'wc-list-item' + (c.isPinned ? ' pinned' : '');
            d.setAttribute('data-index', index);

            let displayName = c.name;
            const f = wcFriends.find(x => x.id === c.id || x.name === c.name);
            if(f && f.alias) displayName = f.alias;

            const avStyle = c.av ? 'background-image:url('+c.av+')' : 'background:#eee';
            const lastMsg = c.last ? c.last : '<span style="color:red">[æ–°ä¼šè¯]</span>';
            const pinMark = c.isPinned ? '<span style="color:#07c160;font-size:10px;margin-right:4px;">[ç½®é¡¶]</span>' : '';

            d.innerHTML = `
                <div class="wc-avatar" style="${avStyle}"></div>
                <div class="wc-info">
                    <div class="wc-name">${displayName}</div>
                    <div class="wc-last-msg">${pinMark}${lastMsg}</div>
                </div>
                <div class="wc-time">${c.time}</div>
                <!-- å·¦æ»‘æŒ‰é’®å®¹å™¨ -->
                <div class="wc-swipe-actions">
                    <div class="wc-swipe-btn ${c.isPinned ? 'unpin' : 'pin'}" data-action="${c.isPinned ? 'unpin' : 'pin'}" data-index="${index}">
                        ${c.isPinned ? 'å–æ¶ˆç½®é¡¶' : 'ç½®é¡¶'}
                    </div>
                    <div class="wc-swipe-btn delete" data-action="delete" data-index="${index}">
                        åˆ é™¤
                    </div>
                </div>
            `;

            d.onclick = function() { window.openChat(c, displayName); };

            // ğŸ‘‰ ä¼˜åŒ–å·¦æ»‘é€»è¾‘
            let startX = 0;
            let isSwiping = false;
            let currentX = 0;

            d.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                currentX = startX;
                isSwiping = false;

                // å…³é—­å…¶ä»–æ‰“å¼€çš„æ»‘åŠ¨é¡¹
                document.querySelectorAll('.wc-list-item.swiping').forEach(item => {
                    if(item !== d) {
                        item.classList.remove('swiping');
                    }
                });
            });

            d.addEventListener('touchmove', e => {
                currentX = e.touches[0].clientX;
                const diffX = startX - currentX;

                if(Math.abs(diffX) > 5) {
                    isSwiping = true;
                    e.preventDefault();
                }

                if(diffX > 0) {
                    // å·¦æ»‘ï¼Œæ˜¾ç¤ºæŒ‰é’®
                    const swipeActions = d.querySelector('.wc-swipe-actions');
                    if(swipeActions) {
                        let translateX = Math.min(diffX, 160);
                        swipeActions.style.right = `-${160 - translateX}px`;
                    }
                }
            });

            d.addEventListener('touchend', e => {
                const diffX = startX - currentX;

                if(isSwiping && diffX > 50) {
                    // å·¦æ»‘è¶…è¿‡50pxï¼Œæ˜¾ç¤ºæŒ‰é’®
                    d.classList.add('swiping');
                } else if(isSwiping && diffX < -50) {
                    // å³æ»‘ï¼Œéšè—æŒ‰é’®
                    d.classList.remove('swiping');
                    const swipeActions = d.querySelector('.wc-swipe-actions');
                    if(swipeActions) {
                        swipeActions.style.right = '-160px';
                    }
                } else if(!isSwiping) {
                    // ç‚¹å‡»æ“ä½œ
                    // ä¸åœ¨è¿™é‡Œå¤„ç†ç‚¹å‡»ï¼Œç”±onclickå¤„ç†
                }

                // é‡ç½®æ»‘åŠ¨çŠ¶æ€
                isSwiping = false;
            });

            // æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const pinBtn = d.querySelector('.wc-swipe-btn[data-action="pin"], .wc-swipe-btn[data-action="unpin"]');
            const deleteBtn = d.querySelector('.wc-swipe-btn[data-action="delete"]');

            if(pinBtn) {
                pinBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const idx = this.getAttribute('data-index');
                    if(wcChats[idx]) {
                        wcChats[idx].isPinned = !wcChats[idx].isPinned;
                        saveAll();
                        wcRenderChats();
                    }
                    d.classList.remove('swiping');
                    const swipeActions = d.querySelector('.wc-swipe-actions');
                    if(swipeActions) {
                        swipeActions.style.right = '-160px';
                    }
                });
            }

            if(deleteBtn) {
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    const idx = this.getAttribute('data-index');
                    if(confirm('ç¡®å®šåˆ é™¤æ­¤èŠå¤©å—ï¼Ÿ')) {
                        wcChats.splice(idx, 1);
                        saveAll();
                        wcRenderChats();
                    }
                    d.classList.remove('swiping');
                    const swipeActions = d.querySelector('.wc-swipe-actions');
                    if(swipeActions) {
                        swipeActions.style.right = '-160px';
                    }
                });
            }

            el.appendChild(d);
        });
    }

    // æ¸²æŸ“é€šè®¯å½•åˆ—è¡¨
    window.wcRenderContacts = function(){
        const el = document.getElementById('wc-contact-list');
        el.innerHTML = "";

        if(!wcFriends || wcFriends.length===0) { 
            el.innerHTML='<div class="wc-empty">æš‚æ— è”ç³»äºº</div>'; 
            return; 
        }

        wcFriends.sort((a,b) => {
            if(a.isStarred !== b.isStarred) return b.isStarred - a.isStarred;
            return (a.alias||a.name).localeCompare(b.alias||b.name, 'zh');
        });

        const stars = wcFriends.filter(f => f.isStarred);
        const others = wcFriends.filter(f => !f.isStarred);

        function addContact(f) {
            const d = document.createElement('div'); 
            d.className='contact-item';
            const avStyle = f.av ? 'background-image:url('+f.av+')' : 'background:#eee';
            d.innerHTML = '<div class="c-av-small" style="'+avStyle+'"></div><div class="c-name-text">'+(f.alias||f.name)+'</div>';
            d.onclick = function() { window.openProfile(f); }; 
            el.appendChild(d);
        }

        if(stars.length > 0) {
            const t = document.createElement('div'); 
            t.className='contact-group-title'; 
            t.innerText = "æ˜Ÿæ ‡æœ‹å‹"; 
            el.appendChild(t);
            stars.forEach(addContact);
        }

        if(others.length > 0) {
            const t = document.createElement('div'); 
            t.className='contact-group-title'; 
            t.innerText = "å…¨éƒ¨è”ç³»äºº"; 
            el.appendChild(t);
            others.forEach(addContact);
        }
    }

    // èµ„æ–™ç¼–è¾‘
    window.openProfile = function(friend) {
        currentEditingFriend = friend;
        pfTempImg = friend.av;
        document.getElementById('p-profile').style.display = 'flex';
        const avEl = document.getElementById('pf-av');
        if(friend.av) { 
            avEl.style.backgroundImage='url('+friend.av+')'; 
            avEl.classList.add('has-img'); 
        } else { 
            avEl.style.backgroundImage='none'; 
            avEl.classList.remove('has-img'); 
        }
        document.getElementById('pf-name').value = friend.name;
        document.getElementById('pf-alias').value = friend.alias || "";
        document.getElementById('pf-desc').value = friend.desc || "";
        document.getElementById('pf-sign').value = friend.sign || "";
        const starSwitch = document.getElementById('pf-star');
        if(friend.isStarred) starSwitch.classList.add('on'); 
        else starSwitch.classList.remove('on');
    }

    window.wcHandleProfileAv = function(i){
        const f=i.files[0]; 
        if(!f) return;
        const r=new FileReader();
        r.onload=(e)=>{ 
            pfTempImg=e.target.result; 
            const el=document.getElementById('pf-av'); 
            el.style.backgroundImage='url('+pfTempImg+')'; 
            el.classList.add('has-img'); 
        };
        r.readAsDataURL(f);
    }

    window.saveProfile = function() {
        if(!currentEditingFriend) return;
        currentEditingFriend.av = pfTempImg;
        currentEditingFriend.name = document.getElementById('pf-name').value;
        currentEditingFriend.alias = document.getElementById('pf-alias').value;
        currentEditingFriend.desc = document.getElementById('pf-desc').value;
        currentEditingFriend.sign = document.getElementById('pf-sign').value;
        currentEditingFriend.isStarred = document.getElementById('pf-star').classList.contains('on');
        saveAll();
        document.getElementById('p-profile').style.display='none';
        wcRenderContacts(); 
        wcRenderChats();
        alert("ä¿å­˜æˆåŠŸ");
    }

    // èŠå¤©è®¾ç½®é€»è¾‘
    window.sSearch = function() {
        const k = prompt("è¯·è¾“å…¥æŸ¥æ‰¾å†…å®¹ï¼š");
        if(!k) return;
        if(!currentChatUser.messages) { alert("æ— æ¶ˆæ¯è®°å½•"); return; }
        const hits = currentChatUser.messages.filter(m => m.text.includes(k));
        if(hits.length > 0) alert("æ‰¾åˆ° " + hits.length + " æ¡è®°å½•ï¼š\\n" + hits[0].text + "...");
        else alert("æœªæ‰¾åˆ°ç›¸å…³è®°å½•");
    }

    window.sLinkGroup = function() { alert("æš‚æ— ç¾¤èŠå¯å…³è”"); }
    window.sBindWorld = function() { prompt("è¯·è¾“å…¥ä¸–ç•Œä¹¦ IDï¼š"); alert("ç»‘å®šæˆåŠŸ (æ¨¡æ‹Ÿ)"); }
    window.sBindPreset = function() { alert("å·²é‡ç½®ä¸ºé»˜è®¤é¢„è®¾"); }
    window.sExport = function() { alert("èŠå¤©è®°å½•å·²å¯¼å‡º (Mock)"); }

    window.sHandleBg = function(i) {
        const f=i.files[0]; 
        if(!f) return;
        const r=new FileReader();
        r.onload=(e)=>{ 
            document.querySelector('.c-body').style.backgroundImage = 'url('+e.target.result+')'; 
            alert("å£çº¸è®¾ç½®æˆåŠŸ"); 
        };
        r.readAsDataURL(f);
    }

    window.sClear = function() {
        if(confirm("ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿ")) {
            document.getElementById('c-msg-list').innerHTML = '';
            currentChatUser.messages = [];
            currentChatUser.last = "";
            saveAll();
            wcRenderChats();
        }
    }

    window.sDelete = function() {
        if(confirm("ç¡®å®šåˆ é™¤è¯¥èŠå¤©ï¼Ÿ")) {
            wcChats = wcChats.filter(c => c.name !== currentChatUser.name);
            saveAll();
            window.closeChat();
            wcRenderChats();
        }
    }

    window.sBlock = function() {
        isBlocked = true;
        alert("å·²å°†è¯¥ç”¨æˆ·åŠ å…¥é»‘åå•ã€‚");
        document.getElementById('c-input').placeholder = "å¯¹æ–¹å·²æ‹’æ”¶æ‚¨çš„æ¶ˆæ¯";
        document.getElementById('c-input').disabled = true;
    }

    window.handleInput = function(el) {
        const btnPlus = document.getElementById('btn-plus');
        const btnBone = document.getElementById('btn-bone');
        const btnSend = document.getElementById('btn-send');
        if(!btnPlus || !btnSend) return; 
        if (el.value.trim().length > 0) {
            btnPlus.style.display = 'none'; 
            btnBone.style.display = 'none';
            btnSend.style.display = 'block';
        } else {
            btnPlus.style.display = 'block'; 
            btnBone.style.display = 'flex';
            btnSend.style.display = 'none';
        }
    }

    window.openChat = function(chatObj, displayTitle) {
        currentChatUser = chatObj;
        isBlocked = false; 
        document.getElementById('wc-chat-window').style.display = 'flex';
        document.getElementById('c-title').innerText = displayTitle || chatObj.name;
        const pFoot = document.getElementById('p-foot');
        if(pFoot) { 
            pFoot.innerHTML = '<div style="text-align:center;color:#999;font-size:12px;padding:20px;">æš‚æ— åŠ¨æ€<br>å‘æ¡æ¶ˆæ¯è¯•è¯•?</div>'; 
        }

        const list = document.getElementById('c-msg-list');
        list.innerHTML = ''; 
        if(chatObj.messages && chatObj.messages.length > 0) {
            chatObj.messages.forEach(msg => {
                addBubbleUI(msg.text, msg.isMe, false);
            });
        }

        document.getElementById('c-input').disabled = false;
        document.getElementById('c-input').placeholder = "è¾“å…¥æ¶ˆæ¯...";
    }

    window.closeChat = function() {
        document.getElementById('wc-chat-window').style.display = 'none';
        document.getElementById('p-settings').style.display = 'none';
        currentChatUser = null;
    }

    window.togglePanel = function(id) { 
        const p = document.getElementById('p-'+id); 
        if(p) p.classList.toggle('open'); 
    }

    window.toggleFootprint = function() { 
        const fp = document.getElementById('p-foot'); 
        if(fp) fp.style.display = fp.style.display==='flex'?'none':'flex'; 
    }

    window.openSettings = function() { 
        document.getElementById('p-settings').style.display = 'flex'; 
    }

    window.sendMsg = function() {
        if(isBlocked) { 
            alert("æ¶ˆæ¯å·²å‘å‡ºï¼Œä½†è¢«å¯¹æ–¹æ‹’æ”¶äº†ã€‚"); 
            return; 
        }
        const input = document.getElementById('c-input');
        const txt = input.value;
        if(!txt) return;
        addBubble(txt, true);
        input.value = "";
        window.handleInput(input);
    }

    // ä½¿ç”¨APIè¿›è¡Œå›å¤ - ä¿®å¤APIè°ƒç”¨é—®é¢˜
    window.triggerReply = async function() {
        if(isBlocked) return;

        // æ˜¾ç¤º"æ­£åœ¨è¾“å…¥"çŠ¶æ€
        addBubbleUI("å¯¹æ–¹æ­£åœ¨è¾“å…¥...", false, true);

        try {
            // æ£€æŸ¥æ˜¯å¦æœ‰é…ç½®çš„API
            const appSettings = getAppSettings();
            const apiConfig = appSettings.apis.primary;

            if (!appSettings || !appSettings.apis || !apiConfig || !apiConfig.apiKey || !apiConfig.endpoint) {
                // å¦‚æœæ²¡æœ‰é…ç½®APIï¼Œä½¿ç”¨ç®€å•å›å¤
                setTimeout(() => {
                    const list = document.getElementById('c-msg-list');
                    if(list.lastChild && list.lastChild.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                        list.lastChild.remove();
                    }
                    addBubble("å—¯ï¼Œæˆ‘æ”¶åˆ°äº†ä½ çš„æ¶ˆæ¯", false);
                }, 1000);
                return;
            }

            // ä½¿ç”¨é…ç½®çš„APIç”Ÿæˆå›å¤
            const messages = currentChatUser?.messages || [];
            const recentMessages = messages.slice(-10).map(msg => ({
                role: msg.isMe ? 'user' : 'assistant',
                content: msg.text
            }));

            // æ·»åŠ å½“å‰æ¶ˆæ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            const currentInput = document.getElementById('c-input').value;
            if(currentInput) {
                recentMessages.push({
                    role: 'user',
                    content: currentInput
                });
            }

            // æ·»åŠ ç³»ç»Ÿæç¤º
            const systemPrompt = {
                role: 'system',
                content: `ä½ æ˜¯${currentChatUser?.name || 'å¥½å‹'}ï¼Œè¯·ä»¥è‡ªç„¶ã€å‹å¥½çš„æ–¹å¼å›å¤ã€‚`
            };

            const apiResponse = await callChatAPI([
                systemPrompt,
                ...recentMessages
            ]);

            // ç§»é™¤"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            const list = document.getElementById('c-msg-list');
            if(list.lastChild && list.lastChild.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                list.lastChild.remove();
            }

            // æ·»åŠ AIå›å¤
            if(apiResponse) {
                addBubble(apiResponse, false);
            } else {
                addBubble("æˆ‘æ˜ç™½äº†", false);
            }

        } catch(error) {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);

            // ç§»é™¤"æ­£åœ¨è¾“å…¥"çŠ¶æ€
            const list = document.getElementById('c-msg-list');
            if(list.lastChild && list.lastChild.innerText === "å¯¹æ–¹æ­£åœ¨è¾“å…¥...") {
                list.lastChild.remove();
            }

            // ä½¿ç”¨ç®€å•å›å¤ä½œä¸ºåå¤‡
            addBubble("ç½‘ç»œå¥½åƒæœ‰ç‚¹é—®é¢˜", false);
        }
    };

    // è°ƒç”¨èŠå¤©API - ä¿®å¤APIè°ƒç”¨é—®é¢˜
    async function callChatAPI(messages) {
        const appSettings = getAppSettings();
        const apiConfig = appSettings.apis.primary;

        if(!apiConfig.apiKey || !apiConfig.endpoint) {
            throw new Error('APIé…ç½®ä¸å®Œæ•´');
        }

        // å¯¹äºä¸åŒçš„APIä¾›åº”å•†ï¼Œè°ƒæ•´è¯·æ±‚æ ¼å¼
        let requestBody, url, headers;

        if(apiConfig.provider === 'openai' || apiConfig.provider === 'custom') {
            url = `${apiConfig.endpoint}/chat/completions`;
            headers = {
                'Authorization': `Bearer ${apiConfig.apiKey}`,
                'Content-Type': 'application/json'
            };
            requestBody = {
                model: apiConfig.model,
                messages: messages,
                max_tokens: 500,
                temperature: 0.7
            };
        } else if(apiConfig.provider === 'gemini') {
            url = `${apiConfig.endpoint}/models/${apiConfig.model}:generateContent?key=${apiConfig.apiKey}`;
            headers = {
                'Content-Type': 'application/json'
            };
            // è½¬æ¢æ¶ˆæ¯æ ¼å¼ä¸ºGeminiæ ¼å¼
            const contents = messages.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: [{ text: msg.content }]
            }));
            requestBody = { contents };
        } else {
            // é»˜è®¤ä½¿ç”¨OpenAIæ ¼å¼
            url = `${apiConfig.endpoint}/chat/completions`;
            headers = {
                'Authorization': `Bearer ${apiConfig.apiKey}`,
                'Content-Type': 'application/json'
            };
            requestBody = {
                model: apiConfig.model,
                messages: messages,
                max_tokens: 500,
                temperature: 0.7
            };
        }

        try {
            console.log('è°ƒç”¨API:', { url, requestBody });

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(requestBody)
            });

            console.log('APIå“åº”çŠ¶æ€:', response.status);

            if(!response.ok) {
                const errorText = await response.text();
                console.error('APIé”™è¯¯å“åº”:', errorText);
                throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            console.log('APIå“åº”æ•°æ®:', data);

            // æ ¹æ®ä¸åŒçš„APIä¾›åº”å•†è§£æå“åº”
            if(apiConfig.provider === 'gemini') {
                return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
            } else {
                return data.choices?.[0]?.message?.content || '';
            }
        } catch(error) {
            console.error('APIè°ƒç”¨å¤±è´¥:', error);
            throw error;
        }
    }

    function addBubble(text, isMe) {
        if(!currentChatUser) return;
        if(!currentChatUser.messages) currentChatUser.messages = [];
        currentChatUser.messages.push({ 
            text: text, 
            isMe: isMe, 
            time: new Date().getTime() 
        });
        currentChatUser.last = text;
        currentChatUser.time = "åˆšåˆš";
        saveAll();
        addBubbleUI(text, isMe, false);
        wcRenderChats();
    }

    function addBubbleUI(text, isMe, isTemp) {
        const list = document.getElementById('c-msg-list');
        if(!list) return;
        const row = document.createElement('div');
        row.className = 'bubble-row' + (isMe ? ' me' : '');
        let avUrl = "";
        if(!isMe && currentChatUser) {
            const f = wcFriends.find(x => x.name === currentChatUser.name);
            if(f) avUrl = f.av; 
            else avUrl = currentChatUser.av || "";
        }
        let avStyle = avUrl ? 'background-image:url('+avUrl+')' : 'background:#eee';
        if(!isMe && !avUrl) avStyle = 'background:#ccc'; 
        row.innerHTML = '<div class="c-av" style="'+avStyle+'"></div><div class="c-bubble" style="'+(isTemp?'color:#999;font-style:italic':'')+'">'+text+'</div>';
        list.appendChild(row);
        list.scrollTop = list.scrollHeight;
    }

    function saveAll() {
        localStorage.setItem('wc_friends', JSON.stringify(wcFriends));
        localStorage.setItem('wc_chats', JSON.stringify(wcChats));
    }

    window.saveSettings = function() { }

    load();

    window.updateCssPreview = function() {
        const css = document.getElementById('css-input-area').value;
        // åªä¿®æ”¹"å¯¹æ–¹"çš„æ°”æ³¡
        document.getElementById('demo-bubble-them').style.cssText = css;
        alert("å·²æ›´æ–°æ°”æ³¡æ ·å¼");
    }

        /* ============================
       âš™ï¸ è®¾ç½®åº”ç”¨æ ¸å¿ƒé€»è¾‘ - ä¿®å¤ç‰ˆæœ¬ (å®Œæ•´ä»£ç )
       ============================ */

    // 1. åˆå§‹åŒ–è®¾ç½®å†å²æ ˆ (å…³é”®ï¼šè®°å½•ä½ è¿›è¿‡å“ªäº›é¡µé¢)

    // è·å–åº”ç”¨è®¾ç½®
    function getAppSettings() {
        try {
            const saved = localStorage.getItem('app_settings');
            if(saved) {
                return JSON.parse(saved);
            }
        } catch(e) {
            console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e);
        }
        return defaultAppSettings;
    }

    // ä¿å­˜åº”ç”¨è®¾ç½®
    function saveAppSettings(settings) {
        try {
            localStorage.setItem('app_settings', JSON.stringify(settings));
            return true;
        } catch(e) {
            console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', e);
            return false;
        }
    }

    // æ‰“å¼€è®¾ç½®åº”ç”¨
    window.openSettingsApp = function() {
        console.log('æ‰“å¼€è®¾ç½®åº”ç”¨');
        const app = document.getElementById('settings-app');
        if(app){
            app.classList.add('active');
            app.style.display = 'flex'; 
        }
        // é‡ç½®å†å²ï¼Œåªä¿ç•™ä¸»é¡µ
        settingsHistory = ['main']; 
        renderSettingsMain();
    };
        /* ===========================
       âš¡ï¸ ä¿®å¤ï¼šAPI åˆ‡æ¢é€»è¾‘ (æ™ºèƒ½ä¿æŠ¤åœ°å€ç‰ˆ)
       =========================== */
    window.updateApiProvider = function(type, provider) {
        const settings = getAppSettings();
        settings.apis[type].provider = provider;

        // ğŸŸ¢ å®šä¹‰é»˜è®¤é…ç½®
        if(provider === 'openai') {
            // OpenAI (æ”¯æŒå®˜æ–¹ã€ä¸­è½¬ã€å…¬ç›Šç«™)
            // ğŸŒŸ æ™ºèƒ½åˆ¤æ–­ï¼šåªæœ‰å½“åœ°å€ä¸ºç©ºï¼Œæˆ–è€…åœ°å€æ˜æ˜¾æ˜¯ Google/Claude çš„æ—¶å€™ï¼Œæ‰é‡ç½®ä¸º OpenAI å®˜æ–¹
            // è¿™æ ·èƒ½ä¿æŠ¤ä½ å¡«å¥½çš„ä¸­è½¬ç«™åœ°å€ä¸è¢«æ¸…ç©ºï¼
            if(!settings.apis[type].endpoint || settings.apis[type].endpoint.includes('google') || settings.apis[type].endpoint.includes('anthropic')) {
                settings.apis[type].endpoint = 'https://api.openai.com/v1'; 
            }
            
            // ç»™ä¸ªåŸºç¡€åˆ—è¡¨ï¼Œä½†éšæ—¶å‡†å¤‡è¢«â€œæ‹‰å–â€è¦†ç›–
            settings.apis[type].availableModels = ['gpt-3.5-turbo', 'gpt-4o', 'gpt-4o-mini'];
            settings.apis[type].model = 'gpt-4o-mini';
        } 
        else if(provider === 'gemini') {
            // Google å®˜æ–¹
            settings.apis[type].endpoint = 'https://generativelanguage.googleapis.com/v1';
            settings.apis[type].availableModels = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp'];
            settings.apis[type].model = 'gemini-1.5-flash';
        } 
        else if(provider === 'claude') {
            // Anthropic å®˜æ–¹
            settings.apis[type].endpoint = 'https://api.anthropic.com/v1';
            settings.apis[type].availableModels = ['claude-3-5-sonnet-20240620', 'claude-3-opus-20240229', 'claude-3-haiku-20240307'];
            settings.apis[type].model = 'claude-3-5-sonnet-20240620';
        }

        saveAppSettings(settings);
        // ç«‹å³åˆ·æ–°é¡µé¢
        renderSettingsPage('api');
    }

    // å…³é—­è®¾ç½®åº”ç”¨
    window.closeSettingsApp = function() {
        console.log('å…³é—­è®¾ç½®åº”ç”¨');
        const app = document.getElementById('settings-app');
        if(app){
            app.classList.remove('active');
            // ç¨å¾®å»¶è¿Ÿéšè—ï¼Œè®©åŠ¨ç”»æ’­å®Œ
            setTimeout(() => {
                if(!app.classList.contains('active')) {
                    app.style.display = 'none';
                }
            }, 300);
        }
        // æ¢å¤åº•éƒ¨ Dock æ  (é˜²æ­¢è¢«æ„å¤–éšè—)
        const dock = document.getElementById('dock');
        if (dock) dock.style.display = 'flex';

        settingsHistory = ['main']; 
        closeApp('settings');
    };

    // ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šè¿”å›æŒ‰é’®é€»è¾‘
    // å¦‚æœåœ¨å­é¡µé¢ -> è¿”å›ä¸»é¡µ
    // å¦‚æœåœ¨ä¸»é¡µ -> å…³é—­åº”ç”¨
    window.closeCurrentPage = function() {
        console.log('æ‰§è¡Œè¿”å›ï¼Œå½“å‰å†å²:', settingsHistory);

        if(settingsHistory.length > 1) {
            // è¿˜æœ‰å†å²è®°å½•ï¼Œè¯´æ˜åœ¨å­é¡µé¢
            settingsHistory.pop(); // ç§»é™¤å½“å‰é¡µ
            const previousPage = settingsHistory[settingsHistory.length - 1]; // è·å–ä¸Šä¸€é¡µåå­—

            if(previousPage === 'main') {
                renderSettingsMain(); // å›åˆ°ä¸»èœå•
            } else {
                renderSettingsPage(previousPage); // å›åˆ°ä¸Šçº§èœå•
            }
        } else {
            // æ²¡æœ‰å†å²è®°å½•äº†ï¼Œè¯´æ˜åœ¨ä¸»é¡µï¼Œç›´æ¥å…³é—­
            closeSettingsApp();
        }
    };

        /* ===========================
       ğŸ¨ è®¾ç½®é¡µé¢æ¸²æŸ“é€»è¾‘ (ç»å¯¹å®Œæ•´æ— åˆ å‡ç‰ˆ)
       =========================== */
    window.renderSettingsPage = function(page) {
        console.log('æ¸²æŸ“å­é¡µé¢:', page);
        
        // å†å²è®°å½•å¤„ç†
        if(typeof settingsHistory !== 'undefined' && settingsHistory[settingsHistory.length - 1] !== page) {
            settingsHistory.push(page);
        }

        const body = document.getElementById('sa-body');
        if(body) body.scrollTop = 0;
        const settings = getAppSettings();
        let html = '';

        // =======================
        // 1. ä¸»é¢˜å¤–è§‚ (Theme)
        // =======================
        if(page === 'theme') {
            // è¿‡æ»¤æ‰ä¸éœ€è¦ä¸Šä¼ å›¾ç‰‡çš„å›¾æ ‡ (æœ‹å‹åœˆ & æˆ‘çš„)
            const displayApps = Object.keys(apps).filter(id => id !== 'moments' && id !== 'profile');
            
            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">ä¸»é¢˜å¤–è§‚</h2></div>

                    <div class="sa-section-title">å£çº¸è®¾ç½®</div>
                    <div class="sa-group">
                        <div class="sa-row" onclick="handleThemeFileUpload('lockWallpaper')">
                            <div class="sa-label">é”å±å£çº¸</div>
                            <div class="sa-value">${settings.theme.lockWallpaper?'å·²è®¾ç½®':'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper')">
                            <div class="sa-label">æ¡Œé¢å£çº¸1</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper?'å·²è®¾ç½®':'æœªè®¾ç½®'}</div>
                        </div>
                        <div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper2')">
                            <div class="sa-label">æ¡Œé¢å£çº¸2</div>
                            <div class="sa-value">${settings.theme.desktopWallpaper2?'å·²è®¾ç½®':'æœªè®¾ç½®'}</div>
                        </div>
                    </div>

                    <div class="sa-section-title">å£çº¸é¢„è§ˆ</div>
                    <div class="wallpaper-preview-container">
                        <div class="wallpaper-preview-title">é”å±å£çº¸é¢„è§ˆ</div>
                        <div class="wallpaper-preview-box" style="${settings.theme.lockWallpaper ? 'background-image: url(' + settings.theme.lockWallpaper + ')' : ''}"></div>
                        <div class="wallpaper-preview-title" style="margin-top:10px">æ¡Œé¢å£çº¸1é¢„è§ˆ</div>
                        <div class="wallpaper-preview-box" style="${settings.theme.desktopWallpaper ? 'background-image: url(' + settings.theme.desktopWallpaper + ')' : ''}"></div>
                    </div>

                    <div class="sa-section-title">åº”ç”¨å›¾æ ‡</div>
                    <div class="sa-group">
                        <div class="sa-row" style="flex-direction: column; align-items: stretch; height: auto; padding: 15px;">
                            <div class="sa-label" style="margin-bottom: 8px;">è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡</div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
                                ${displayApps.map(appId => {
                                    const app = apps[appId];
                                    const savedIcon = localStorage.getItem('app_icon_' + appId);
                                    return `
                                        <div class="icon-edit-area" style="padding: 10px;">
                                            <div class="icon-preview ${savedIcon?'has-img':''}" style="${savedIcon?'background-image:url('+savedIcon+')':''}">
                                                ${!savedIcon?app.icon:''}
                                            </div>
                                            <div style="font-size:10px;text-align:center;margin-top:5px;">${app.name}</div>
                                            <button class="icon-edit-btn" onclick="editAppIcon('${appId}')">æ›´æ¢</button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>`;
        } 
        // =======================
        // 2. å­—ä½“ç¾åŒ– (Font)
        // =======================
        else if(page === 'font') {
            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">å­—ä½“ç¾åŒ–</h2></div>
                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">å¯ç”¨è‡ªå®šä¹‰å­—ä½“</div>
                            <div class="sa-switch ${settings.font.enabled?'on':''}" onclick="toggleFontEnabled(this)"></div>
                        </div>
                        <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                            <div class="sa-label">å­—ä½“URL</div>
                            <input type="text" class="sa-input" id="font-url" value="${settings.font.url}" placeholder="è¾“å…¥å­—ä½“æ–‡ä»¶é“¾æ¥" onchange="updateFontUrl(this.value)">
                        </div>
                        <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                            <div class="sa-label">å­—ä½“åç§°</div>
                            <input type="text" class="sa-input" id="font-name" value="${settings.font.name}" placeholder="ä¾‹å¦‚: MyFont" onchange="updateFontName(this.value)">
                        </div>
                    </div>
                    <div class="sa-section-title">é¢„è§ˆ</div>
                    <div class="sa-group">
                        <div class="sa-row" style="padding:20px;justify-content:center;">
                            <div style="font-size:20px;font-family:'${settings.font.name}',sans-serif">å­—ä½“é¢„è§ˆæ•ˆæœ ABC 123</div>
                        </div>
                    </div>
                </div>`;
        } 
        // =======================
        // 3. API é…ç½® (API) - å®Œæ•´åŠŸèƒ½ç‰ˆ
        // =======================
        else if(page === 'api') {
            const priProvider = settings.apis.primary.provider || 'openai';
            const secProvider = settings.apis.secondary.provider || 'gemini';
            
            // è¯»å–å·²ä¿å­˜çš„æ¨¡å‹åˆ—è¡¨ï¼Œå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºæç¤º
            const priList = (settings.apis.primary.availableModels && settings.apis.primary.availableModels.length) ? settings.apis.primary.availableModels : ['(è¯·ç‚¹å‡»ç»¿è‰²æ‹‰å–æŒ‰é’®)'];
            const secList = (settings.apis.secondary.availableModels && settings.apis.secondary.availableModels.length) ? settings.apis.secondary.availableModels : ['(è¯·ç‚¹å‡»ç»¿è‰²æ‹‰å–æŒ‰é’®)'];

            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">APIé…ç½®</h2></div>
                    <div style="background:#e6f7ff;border:1px solid #91d5ff;padding:10px;border-radius:4px;font-size:12px;color:#0050b3;margin-bottom:15px;">
                        ğŸ’¡ <b>æç¤ºï¼š</b>å¡«å¥½åœ°å€å’ŒKeyåï¼Œè¯·ç‚¹å‡»ç»¿è‰²çš„<b>â€œæ‹‰å–æ¨¡å‹åˆ—è¡¨â€</b>æŒ‰é’®ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨è·å–è¯¥ç«™ç‚¹æ”¯æŒçš„æ‰€æœ‰æ¨¡å‹ã€‚
                    </div>

                    <div class="sa-section-title">ä¸»APIé…ç½®</div>
                    <div class="api-config-block">
                        <div class="api-config-title">èŠå¤©å¯¹è¯ (ä¸»äººæ ¼)</div>
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">ä¾›åº”å•†ç±»å‹</div>
                            <select class="model-selector" onchange="updateApiProvider('primary', this.value)">
                                <option value="openai" ${priProvider==='openai'?'selected':''}>OpenAI / ä¸­è½¬ç«™ (é€šç”¨)</option>
                                <option value="gemini" ${priProvider==='gemini'?'selected':''}>Google Gemini å®˜æ–¹</option>
                                <option value="claude" ${priProvider==='claude'?'selected':''}>Anthropic Claude å®˜æ–¹</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;"><input type="text" class="sa-input" value="${settings.apis.primary.endpoint}" placeholder="æ¥å£åœ°å€" onchange="updateApiEndpoint('primary', this.value)"></div>
                        <div style="margin-bottom: 15px;"><input type="password" class="sa-input" value="${settings.apis.primary.apiKey}" placeholder="API Key" onchange="updateApiKey('primary', this.value)"></div>
                        
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">å½“å‰æ¨¡å‹</div>
                            <select class="model-selector" onchange="updateApiModel('primary', this.value)">
                                ${priList.map(m => `<option value="${m}" ${settings.apis.primary.model===m?'selected':''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <button class="sa-btn" onclick="testApiConnection('primary')" style="background:#07c160;color:#fff">ğŸ”„ æ‹‰å–/åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
                    </div>

                    <div class="sa-section-title">å‰¯APIé…ç½®</div>
                    <div class="api-config-block">
                        <div class="api-config-title">è®°å¿†ä¸æ€»ç»“ (åå°ä»»åŠ¡)</div>
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">ä¾›åº”å•†ç±»å‹</div>
                            <select class="model-selector" onchange="updateApiProvider('secondary', this.value)">
                                <option value="openai" ${secProvider==='openai'?'selected':''}>OpenAI / ä¸­è½¬ç«™ (é€šç”¨)</option>
                                <option value="gemini" ${secProvider==='gemini'?'selected':''}>Google Gemini å®˜æ–¹</option>
                                <option value="claude" ${secProvider==='claude'?'selected':''}>Anthropic Claude å®˜æ–¹</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;"><input type="text" class="sa-input" value="${settings.apis.secondary.endpoint}" placeholder="æ¥å£åœ°å€" onchange="updateApiEndpoint('secondary', this.value)"></div>
                        <div style="margin-bottom: 15px;"><input type="password" class="sa-input" value="${settings.apis.secondary.apiKey}" placeholder="API Key" onchange="updateApiKey('secondary', this.value)"></div>
                        
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">å½“å‰æ¨¡å‹</div>
                            <select class="model-selector" onchange="updateApiModel('secondary', this.value)">
                                ${secList.map(m => `<option value="${m}" ${settings.apis.secondary.model===m?'selected':''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <button class="sa-btn" onclick="testApiConnection('secondary')" style="background:#07c160;color:#fff">ğŸ”„ æ‹‰å–/åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
                    </div>
                </div>`;
        } 
        // =======================
        // 4. è¯­éŸ³æ¥å…¥ (Voice)
        // =======================
        else if(page === 'voice') {
            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">è¯­éŸ³æ¥å…¥</h2></div>
                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">å¯ç”¨è¯­éŸ³åŠŸèƒ½</div>
                            <div class="sa-switch ${settings.voice.enabled?'on':''}" onclick="toggleVoiceEnabled(this)"></div>
                        </div>
                        <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                            <div class="sa-label">Minimax API Key</div>
                            <input type="password" class="sa-input" id="voice-apiKey" value="${settings.voice.apiKey}" onchange="updateVoiceApiKey(this.value)">
                        </div>
                        <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                            <div class="sa-label">Group ID</div>
                            <input type="text" class="sa-input" id="voice-groupId" value="${settings.voice.groupId}" onchange="updateVoiceGroupId(this.value)">
                        </div>
                        <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                            <div class="sa-label">éŸ³è‰²ID</div>
                            <input type="text" class="sa-input" id="voice-voiceId" value="${settings.voice.voiceId}" onchange="updateVoiceVoiceId(this.value)">
                        </div>
                    </div>
                </div>`;
        } 
        // =======================
        // 5. å­˜å‚¨ä¸å¤‡ä»½ (Backup)
        // =======================
        else if(page === 'backup') {
            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">å­˜å‚¨ä¸å¤‡ä»½</h2></div>
                    <div class="sa-group">
                        <div class="sa-row">
                            <div class="sa-label">è‡ªåŠ¨å¤‡ä»½</div>
                            <div class="sa-switch ${settings.backup.autoBackup?'on':''}" onclick="toggleBackupAuto(this)"></div>
                        </div>
                        <div class="sa-row">
                            <div class="sa-label">å¤‡ä»½ä½ç½®</div>
                            <select class="model-selector" style="width:auto;" onchange="updateBackupLocation(this.value)">
                                <option value="local" ${settings.backup.location==='local'?'selected':''}>æœ¬åœ°æ–‡ä»¶</option>
                                <option value="github" ${settings.backup.location==='github'?'selected':''}>GitHub</option>
                            </select>
                        </div>
                    </div>
                    ${settings.backup.location === 'github' ? `
                        <div class="sa-section-title">GitHubé…ç½®</div>
                        <div class="sa-group">
                            <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                                <div class="sa-label">Token</div>
                                <input type="password" class="sa-input" id="github-token" value="${settings.backup.githubToken}" onchange="updateGithubToken(this.value)">
                            </div>
                            <div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;">
                                <div class="sa-label">ä»“åº“å</div>
                                <input type="text" class="sa-input" id="github-repo" value="${settings.backup.githubRepo}" onchange="updateGithubRepo(this.value)">
                            </div>
                        </div>` : ''}
                    <div class="sa-section-title">æ“ä½œ</div>
                    <div class="sa-group">
                        <div class="sa-row" style="padding:15px;"><button class="sa-btn" onclick="startBackup()" style="width:100%">ç«‹å³å¤‡ä»½</button></div>
                        <div class="sa-row" style="padding:15px;"><button class="sa-btn" onclick="restoreBackup()" style="width:100%;background:#f0f0f0;color:#333">æ¢å¤å¤‡ä»½</button></div>
                    </div>
                    ${settings.backup.lastBackup ? `
                        <div class="sa-section-title">ä¸Šæ¬¡å¤‡ä»½</div>
                        <div class="sa-group"><div class="sa-row"><div class="sa-label">æ—¶é—´</div><div class="sa-value">${new Date(settings.backup.lastBackup).toLocaleString()}</div></div></div>` : ''}
                </div>`;
        } 
        // =======================
        // 6. å…³äº (About)
        // =======================
        else if(page === 'about') {
            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">å…³äº</h2></div>
                    <div class="sa-section-title">ç³»ç»Ÿä¿¡æ¯</div>
                    <div class="sa-group">
                        <div class="sa-row"><div class="sa-label">ç‰ˆæœ¬</div><div class="sa-value">Molly OS v15.8</div></div>
                        <div class="sa-row"><div class="sa-label">å¼€å‘è€…</div><div class="sa-value">Molly Studio</div></div>
                    </div>
                    <div class="sa-section-title">é«˜çº§</div>
                    <div class="sa-group">
                        <div class="sa-row" style="padding:15px;"><button class="sa-btn" onclick="exportAllData()" style="width:100%;background:#f0f0f0;color:#333">å¯¼å‡ºæ‰€æœ‰æ•°æ®</button></div>
                        <div class="sa-row" style="padding:15px;"><button class="sa-btn" onclick="resetSettings()" style="width:100%;background:#ff4d4f;color:#fff">é‡ç½®æ‰€æœ‰è®¾ç½®</button></div>
                    </div>
                </div>`;
        }

        body.innerHTML = html;
        const pageTitles = {'theme':'ä¸»é¢˜å¤–è§‚','font':'å­—ä½“ç¾åŒ–','api':'APIé…ç½®','voice':'è¯­éŸ³æ¥å…¥','backup':'å­˜å‚¨å¤‡ä»½','about':'å…³äº'};
        if(document.getElementById('settings-title')) document.getElementById('settings-title').innerText = pageTitles[page] || 'ç³»ç»Ÿè®¾ç½®';
    }

    // ä¸»é¢˜ç›¸å…³å‡½æ•°
    function handleThemeFileUpload(type) {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';

        input.onchange = function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const settings = getAppSettings();

                if(type === 'lockWallpaper') {
                    settings.theme.lockWallpaper = dataUrl;
                    document.getElementById('global-wall').style.backgroundImage = `url(${dataUrl})`;
                } else if(type === 'desktopWallpaper') {
                    settings.theme.desktopWallpaper = dataUrl;
                    const desktop1 = document.querySelector('.desktop-page:first-child');
                    if(desktop1) {
                        desktop1.style.backgroundImage = `url(${dataUrl})`;
                    }
                } else if(type === 'desktopWallpaper2') {
                    settings.theme.desktopWallpaper2 = dataUrl;
                    const desktop2 = document.querySelector('.desktop-page:nth-child(2)');
                    if(desktop2) {
                        desktop2.style.backgroundImage = `url(${dataUrl})`;
                    }
                }

                saveAppSettings(settings);
                renderSettingsPage('theme');
                showUploadSuccess();
            };
            reader.readAsDataURL(file);
        };

        input.click();
    }

    // ç¼–è¾‘åº”ç”¨å›¾æ ‡
    window.editAppIcon = function(appId) {
        document.getElementById('f-icon-' + appId).click();
    };

    // å­—ä½“ç›¸å…³å‡½æ•°
    function toggleFontEnabled(element) {
        element.classList.toggle('on');
        const enabled = element.classList.contains('on');
        const settings = getAppSettings();
        settings.font.enabled = enabled;
        saveAppSettings(settings);

        const fontUrlInput = document.getElementById('font-url');
        if(fontUrlInput) {
            fontUrlInput.disabled = !enabled;
        }
    }

    function updateFontUrl(url) {
        const settings = getAppSettings();
        settings.font.url = url;
        saveAppSettings(settings);
    }

    function updateFontName(name) {
        const settings = getAppSettings();
        settings.font.name = name;
        saveAppSettings(settings);
    }

    // APIç›¸å…³å‡½æ•°
    function updateApiProvider(type, provider) {
        const settings = getAppSettings();
        settings.apis[type].provider = provider;
        if(provider === 'openai') {
            settings.apis[type].endpoint = 'https://api.openai.com/v1';
        } else if(provider === 'gemini') {
            settings.apis[type].endpoint = 'https://generativelanguage.googleapis.com/v1';
        }
        saveAppSettings(settings);
        renderSettingsPage('api');
    }

    function updateApiEndpoint(type, endpoint) {
        const settings = getAppSettings();
        settings.apis[type].endpoint = endpoint;
        saveAppSettings(settings);
    }

    function updateApiKey(type, apiKey) {
        const settings = getAppSettings();
        settings.apis[type].apiKey = apiKey;
        saveAppSettings(settings);
    }

    function updateApiModel(type, model) {
        const settings = getAppSettings();
        settings.apis[type].model = model;
        saveAppSettings(settings);
    }

    async function testApiConnection(type) {
        const settings = getAppSettings();
        const apiConfig = settings.apis[type];

        if(!apiConfig.apiKey || !apiConfig.endpoint) {
            alert('è¯·å…ˆå¡«å†™APIå¯†é’¥å’Œæ¥å£åœ°å€');
            return;
        }

        const button = event?.target;
        const textSpan = button?.querySelector('span');
        const originalText = textSpan?.textContent || 'æµ‹è¯•è¿æ¥';

        if(button && textSpan) {
            textSpan.innerHTML = '<span class="loading-spinner"></span> æµ‹è¯•ä¸­...';
            button.disabled = true;
        }

        try {
            let testResult = false;
            let errorMessage = '';

            if(apiConfig.provider === 'openai' || apiConfig.provider === 'custom') {
                const response = await fetch(`${apiConfig.endpoint}/models`, {
                    headers: {
                        'Authorization': `Bearer ${apiConfig.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                if(response.ok) {
                    const data = await response.json();
                    testResult = true;
                } else {
                    errorMessage = `HTTP ${response.status}`;
                }
            } else if(apiConfig.provider === 'gemini') {
                const response = await fetch(`${apiConfig.endpoint}/models?key=${apiConfig.apiKey}`);
                if(response.ok) {
                    testResult = true;
                } else {
                    errorMessage = `HTTP ${response.status}`;
                }
            }

            if(testResult) {
                alert('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸï¼');
            } else {
                throw new Error(errorMessage);
            }
        } catch(error) {
            console.error(`${type} APIæµ‹è¯•å¤±è´¥:`, error);
            alert(`âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
        } finally {
            if(button && textSpan) {
                textSpan.textContent = originalText;
                button.disabled = false;
            }
        }
    }

        /* =========================
           ğŸ’¬ èŠå¤©å‘é€ç›¸å…³å‡½æ•°
           ========================= */

        async function sendMsg() {
            const input = document.getElementById('c-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';
            appendUserMsg(text);

            const settings = getAppSettings();
            const api = settings.apis?.chat;

            if (!api || !api.apiKey || !api.endpoint) {
                appendAIMsg('âš ï¸ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API');
                return;
            }

            appendAIMsg('â€¦â€¦');

            try {
                const res = await fetch(`${api.endpoint}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${api.apiKey}`
                    },
                    body: JSON.stringify({
                        model: api.model || 'gpt-3.5-turbo',
                        messages: [{ role: 'user', content: text }]
                    })
                });

                const data = await res.json();
                removeLastAIMsg();

                if (data.error) {
                    appendAIMsg('âŒ ' + data.error.message);
                } else {
                    appendAIMsg(data.choices[0].message.content);
                }

            } catch (e) {
                removeLastAIMsg();
                appendAIMsg('ğŸŒ ç½‘ç»œå¼‚å¸¸');
                console.error(e);
            }
        }
        function appendUserMsg(text) {
            const list = document.getElementById('c-msg-list');
            if (!list) return;

            const row = document.createElement('div');
            row.className = 'bubble-row me';
            row.innerHTML = `
                <div class="c-bubble">${text}</div>
            `;
            list.appendChild(row);
            list.scrollTop = list.scrollHeight;
        }

        function appendAIMsg(text) {
            const list = document.getElementById('c-msg-list');
            if (!list) return;

            const row = document.createElement('div');
            row.className = 'bubble-row ai';
            row.innerHTML = `
                <div class="c-bubble">${text}</div>
            `;
            list.appendChild(row);
            list.scrollTop = list.scrollHeight;
        }

        function removeLastAIMsg() {
            const list = document.getElementById('c-msg-list');
            if (list && list.lastChild) {
                list.removeChild(list.lastChild);
            }
        }
    // è¯­éŸ³ç›¸å…³å‡½æ•°
    function toggleVoiceEnabled(element) {
        element.classList.toggle('on');
        const enabled = element.classList.contains('on');
        const settings = getAppSettings();
        settings.voice.enabled = enabled;
        saveAppSettings(settings);

        // å¯ç”¨/ç¦ç”¨è¾“å…¥æ¡†
        const inputs = ['voice-apiKey', 'voice-groupId', 'voice-voiceId'];
        inputs.forEach(id => {
            const input = document.getElementById(id);
            if(input) {
                input.disabled = !enabled;
            }
        });
    }

    function updateVoiceApiKey(apiKey) {
        const settings = getAppSettings();
        settings.voice.apiKey = apiKey;
        saveAppSettings(settings);
    }

    function updateVoiceGroupId(groupId) {
        const settings = getAppSettings();
        settings.voice.groupId = groupId;
        saveAppSettings(settings);
    }

    function updateVoiceVoiceId(voiceId) {
        const settings = getAppSettings();
        settings.voice.voiceId = voiceId;
        saveAppSettings(settings);
    }

    // å¤‡ä»½ç›¸å…³å‡½æ•°
    function toggleBackupAuto(element) {
        element.classList.toggle('on');
        const enabled = element.classList.contains('on');
        const settings = getAppSettings();
        settings.backup.autoBackup = enabled;
        saveAppSettings(settings);
    }

    function updateBackupLocation(location) {
        const settings = getAppSettings();
        settings.backup.location = location;
        saveAppSettings(settings);
        renderSettingsPage('backup');
    }

    function updateGithubToken(token) {
        const settings = getAppSettings();
        settings.backup.githubToken = token;
        saveAppSettings(settings);
    }

    function updateGithubRepo(repo) {
        const settings = getAppSettings();
        settings.backup.githubRepo = repo;
        saveAppSettings(settings);
    }

    function startBackup() {
        try {
            const confirmed = confirm('ç¡®å®šè¦å¼€å§‹å¤‡ä»½å—ï¼Ÿ');
            if(!confirmed) return;

            // åˆ›å»ºå¤‡ä»½æ•°æ®
            const backupData = {
                timestamp: new Date().toISOString(),
                version: 'Molly OS v15.4',
                data: {
                    settings: getAppSettings(),
                    friends: wcFriends,
                    chats: wcChats,
                    customizations: {}
                }
            };

            // æ”¶é›†è‡ªå®šä¹‰é¡¹
            for(let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if(key.startsWith('u_') || key.startsWith('app_icon_')) {
                    backupData.data.customizations[key] = localStorage.getItem(key);
                }
            }

            // å¤‡ä»½åˆ°æœ¬åœ°
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `molly-os-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);

            // æ›´æ–°å¤‡ä»½æ—¶é—´
            const settings = getAppSettings();
            settings.backup.lastBackup = new Date().toISOString();
            saveAppSettings(settings);

            alert('âœ… å¤‡ä»½æˆåŠŸï¼');
            renderSettingsPage('backup');

        } catch(error) {
            console.error('å¤‡ä»½å¤±è´¥:', error);
            alert(`âŒ å¤‡ä»½å¤±è´¥: ${error.message}`);
        }
    }

    function restoreBackup() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';

        input.onchange = function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    const confirmed = confirm(`ç¡®å®šè¦ä»å¤‡ä»½æ¢å¤å—ï¼Ÿ\nå¤‡ä»½æ—¶é—´: ${backupData.timestamp}\nè¿™å°†è¦†ç›–å½“å‰æ‰€æœ‰æ•°æ®ã€‚`);
                    if(!confirmed) return;

                    // æ¢å¤æ•°æ®
                    if(backupData.data.settings) {
                        saveAppSettings(backupData.data.settings);
                    }

                    if(backupData.data.friends) {
                        wcFriends = backupData.data.friends;
                        localStorage.setItem('wc_friends', JSON.stringify(wcFriends));
                    }

                    if(backupData.data.chats) {
                        wcChats = backupData.data.chats;
                        localStorage.setItem('wc_chats', JSON.stringify(wcChats));
                    }

                    if(backupData.data.customizations) {
                        Object.keys(backupData.data.customizations).forEach(key => {
                            localStorage.setItem(key, backupData.data.customizations[key]);
                        });
                    }

                    alert('âœ… æ¢å¤æˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢ã€‚');

                } catch(error) {
                    alert('æ¢å¤å¤±è´¥ï¼šå¤‡ä»½æ–‡ä»¶æ ¼å¼é”™è¯¯');
                }
            };
            reader.readAsText(file);
        };

        input.click();
    }

    // å…¶ä»–å‡½æ•°
    function checkForUpdates() {
        alert('å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼');
    }

    function exportAllData() {
        const allData = {
            settings: getAppSettings(),
            friends: wcFriends,
            chats: wcChats,
            customizations: {}
        };

        // æ”¶é›†è‡ªå®šä¹‰é¡¹
        for(let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('u_') || key.startsWith('app_icon_')) {
                allData.customizations[key] = localStorage.getItem(key);
            }
        }

        const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = `molly-os-export-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        URL.revokeObjectURL(url);
        alert('âœ… å¯¼å‡ºæˆåŠŸï¼');
    }

    function resetSettings() {
        const confirmed = confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿ\nè¿™å°†åˆ é™¤æ‰€æœ‰é…ç½®ï¼Œä½†ä¸ä¼šåˆ é™¤å¥½å‹å’ŒèŠå¤©è®°å½•ã€‚');
        if(!confirmed) return;

        // é‡ç½®è®¾ç½®
        saveAppSettings(defaultAppSettings);

        // åˆ é™¤è‡ªå®šä¹‰é¡¹
        const keysToRemove = [];
        for(let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if(key.startsWith('u_') || key.startsWith('app_icon_')) {
                keysToRemove.push(key);
            }
        }

        keysToRemove.forEach(key => {
            localStorage.removeItem(key);
        });

        alert('âœ… é‡ç½®æˆåŠŸï¼è¯·åˆ·æ–°é¡µé¢ã€‚');
    }
    /* =================================================================
       ğŸ”¥ ç¼ºå¤±åŠŸèƒ½è¡¥å…¨åŒ…ï¼šè®¾ç½®ä¸»èœå• + å­é¡µé¢æ¸²æŸ“ + APIé€»è¾‘
       (è¯·ç²˜è´´åœ¨ resetSettings å‡½æ•°åé¢)
       ================================================================= */

    // 1. æ¸²æŸ“è®¾ç½®ä¸»èœå• (è¿™æ˜¯ä½ ä¸¢å¤±çš„å…¥å£ï¼)
    window.renderSettingsMain = function() {
        if(typeof settingsHistory !== 'undefined') settingsHistory = ['main'];
        const body = document.getElementById('sa-body');
        if(document.getElementById('settings-title')) document.getElementById('settings-title').innerText = 'ç³»ç»Ÿè®¾ç½®';
        
        body.innerHTML = `
            <div style="padding: 15px;">
                <div style="margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333; font-size: 20px;">ç³»ç»Ÿè®¾ç½®</h2>
                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Molly OS v15.8</p>
                </div>
                <div class="sa-group">
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('theme')"><div class="sa-label">ğŸ¨ ä¸»é¢˜å¤–è§‚</div></div>
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('font')"><div class="sa-label">ğŸ”¤ å­—ä½“ç¾åŒ–</div></div>
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('api')"><div class="sa-label">âš¡ API é…ç½®</div></div>
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('voice')"><div class="sa-label">ğŸ¤ è¯­éŸ³æ¥å…¥</div></div>
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('backup')"><div class="sa-label">ğŸ’¾ å­˜å‚¨ä¸å¤‡ä»½</div></div>
                    <div class="sa-row sa-arrow" onclick="renderSettingsPage('about')"><div class="sa-label">â„¹ï¸ å…³äº</div></div>
                </div>
            </div>`;
    }

    // 2. æ¸²æŸ“å­é¡µé¢ (åŒ…å«ä½ è¦æ±‚çš„å®Œæ•´ API é€»è¾‘)
    window.renderSettingsPage = function(page) {
        console.log('æ¸²æŸ“å­é¡µé¢:', page);
        if(typeof settingsHistory !== 'undefined' && settingsHistory[settingsHistory.length - 1] !== page) {
            settingsHistory.push(page);
        }
        const body = document.getElementById('sa-body');
        body.scrollTop = 0;
        const settings = getAppSettings();
        let html = '';

        if(page === 'theme') {
            const displayApps = Object.keys(apps).filter(id => id !== 'moments' && id !== 'profile');
            html = `<div style="padding:15px;"><h2>ä¸»é¢˜å¤–è§‚</h2><div class="sa-group"><div class="sa-row" onclick="handleThemeFileUpload('lockWallpaper')"><div class="sa-label">é”å±å£çº¸</div><div class="sa-value">${settings.theme.lockWallpaper?'å·²è®¾ç½®':'æœªè®¾ç½®'}</div></div><div class="sa-row" onclick="handleThemeFileUpload('desktopWallpaper')"><div class="sa-label">æ¡Œé¢å£çº¸1</div><div class="sa-value">${settings.theme.desktopWallpaper?'å·²è®¾ç½®':'æœªè®¾ç½®'}</div></div></div><div class="sa-section-title">å›¾æ ‡</div><div class="sa-group"><div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">${displayApps.map(id=>`<div class="icon-edit-area" style="padding:5px;"><div class="icon-preview ${localStorage.getItem('app_icon_'+id)?'has-img':''}" style="${localStorage.getItem('app_icon_'+id)?'background-image:url('+localStorage.getItem('app_icon_'+id)+')':''}">${!localStorage.getItem('app_icon_'+id)?apps[id].icon:''}</div><div style="font-size:10px;text-align:center;margin-top:5px">${apps[id].name}</div><button class="icon-edit-btn" onclick="editAppIcon('${id}')" style="margin-top:5px;padding:4px 10px;font-size:10px">æ›´æ¢</button></div>`).join('')}</div></div></div></div>`;
        }
        else if(page === 'font') {
            html = `<div style="padding:15px;"><h2>å­—ä½“ç¾åŒ–</h2><div class="sa-group"><div class="sa-row"><div class="sa-label">å¯ç”¨è‡ªå®šä¹‰å­—ä½“</div><div class="sa-switch ${settings.font.enabled?'on':''}" onclick="toggleFontEnabled(this)"></div></div><div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;"><div class="sa-label">å­—ä½“URL</div><input type="text" class="sa-input" id="font-url" value="${settings.font.url}" onchange="updateFontUrl(this.value)"></div></div></div>`;
        }
        else if(page === 'api') {
            // ğŸŸ¢ API é¡µé¢ï¼šæ”¯æŒæ‹‰å–æ‰€æœ‰æ¨¡å‹
            const priProvider = settings.apis.primary.provider || 'openai';
            const secProvider = settings.apis.secondary.provider || 'gemini';
            const priList = (settings.apis.primary.availableModels && settings.apis.primary.availableModels.length) ? settings.apis.primary.availableModels : ['(è¯·ç‚¹å‡»ç»¿è‰²æŒ‰é’®æ‹‰å–)'];
            const secList = (settings.apis.secondary.availableModels && settings.apis.secondary.availableModels.length) ? settings.apis.secondary.availableModels : ['(è¯·ç‚¹å‡»ç»¿è‰²æŒ‰é’®æ‹‰å–)'];

            html = `
                <div style="padding: 15px;">
                    <div style="margin-bottom: 20px;"><h2 style="margin:0;color:#333;font-size:20px;">APIé…ç½®</h2></div>
                    <div style="background:#e6f7ff;border:1px solid #91d5ff;padding:10px;border-radius:4px;font-size:12px;color:#0050b3;margin-bottom:15px;">
                        ğŸ’¡ <b>æç¤ºï¼š</b>å¡«å¥½ä¸­è½¬ç«™åœ°å€å’ŒKeyåï¼Œè¯·åŠ¡å¿…ç‚¹å‡»<b>â€œæ‹‰å–æ¨¡å‹åˆ—è¡¨â€</b>ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½è¯¥ç«™ç‚¹æ”¯æŒçš„æ‰€æœ‰æ¨¡å‹ï¼ˆClaude/Gemini/GPTç­‰ï¼‰ã€‚
                    </div>

                    <div class="sa-section-title">ä¸»APIé…ç½®</div>
                    <div class="api-config-block">
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">ä¾›åº”å•†</div>
                            <select class="model-selector" onchange="updateApiProvider('primary', this.value)">
                                <option value="openai" ${priProvider==='openai'?'selected':''}>OpenAI / ä¸­è½¬ / å…¬ç›Š</option>
                                <option value="gemini" ${priProvider==='gemini'?'selected':''}>Google Gemini</option>
                                <option value="claude" ${priProvider==='claude'?'selected':''}>Anthropic Claude</option>
                            </select>
                        </div>
                        <div style="margin-bottom:15px;"><input type="text" class="sa-input" value="${settings.apis.primary.endpoint}" placeholder="æ¥å£åœ°å€" onchange="updateApiEndpoint('primary', this.value)"></div>
                        <div style="margin-bottom:15px;"><input type="password" class="sa-input" value="${settings.apis.primary.apiKey}" placeholder="API Key" onchange="updateApiKey('primary', this.value)"></div>
                        <div style="margin-bottom:15px;"><div style="font-size:13px;color:#666;">å½“å‰æ¨¡å‹</div>
                            <select class="model-selector" onchange="updateApiModel('primary', this.value)">
                                ${priList.map(m => `<option value="${m}" ${settings.apis.primary.model===m?'selected':''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <button class="sa-btn" onclick="testApiConnection('primary')" style="background:#07c160;color:#fff">ğŸ”„ æ‹‰å–/åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
                    </div>

                    <div class="sa-section-title">å‰¯APIé…ç½®</div>
                    <div class="api-config-block">
                        <div style="margin-bottom: 15px;"><div style="font-size:13px;color:#666;">ä¾›åº”å•†</div>
                            <select class="model-selector" onchange="updateApiProvider('secondary', this.value)">
                                <option value="openai" ${secProvider==='openai'?'selected':''}>OpenAI / ä¸­è½¬ / å…¬ç›Š</option>
                                <option value="gemini" ${secProvider==='gemini'?'selected':''}>Google Gemini</option>
                                <option value="claude" ${secProvider==='claude'?'selected':''}>Anthropic Claude</option>
                            </select>
                        </div>
                        <div style="margin-bottom:15px;"><input type="text" class="sa-input" value="${settings.apis.secondary.endpoint}" placeholder="æ¥å£åœ°å€" onchange="updateApiEndpoint('secondary', this.value)"></div>
                        <div style="margin-bottom:15px;"><input type="password" class="sa-input" value="${settings.apis.secondary.apiKey}" placeholder="API Key" onchange="updateApiKey('secondary', this.value)"></div>
                        <div style="margin-bottom:15px;"><div style="font-size:13px;color:#666;">å½“å‰æ¨¡å‹</div>
                            <select class="model-selector" onchange="updateApiModel('secondary', this.value)">
                                ${secList.map(m => `<option value="${m}" ${settings.apis.secondary.model===m?'selected':''}>${m}</option>`).join('')}
                            </select>
                        </div>
                        <button class="sa-btn" onclick="testApiConnection('secondary')" style="background:#07c160;color:#fff">ğŸ”„ æ‹‰å–/åˆ·æ–°æ¨¡å‹åˆ—è¡¨</button>
                    </div>
                </div>`;
        }
        else if(page === 'voice') {
            html = `<div style="padding:15px;"><h2>è¯­éŸ³æ¥å…¥</h2><div class="sa-group"><div class="sa-row"><div class="sa-label">å¯ç”¨è¯­éŸ³</div><div class="sa-switch ${settings.voice.enabled?'on':''}" onclick="toggleVoiceEnabled(this)"></div></div><div class="sa-row" style="flex-direction:column;align-items:stretch;height:auto;padding:15px;"><div class="sa-label">API Key</div><input type="password" class="sa-input" id="voice-apiKey" value="${settings.voice.apiKey}" onchange="updateVoiceApiKey(this.value)"></div></div></div>`;
        }
        else if(page === 'backup') {
            html = `<div style="padding:15px;"><h2>å¤‡ä»½</h2><div class="sa-group"><div class="sa-row"><div class="sa-label">å¤‡ä»½ä½ç½®</div><select class="model-selector" style="width:auto" onchange="updateBackupLocation(this.value)"><option value="local" ${settings.backup.location==='local'?'selected':''}>æœ¬åœ°</option><option value="github" ${settings.backup.location==='github'?'selected':''}>GitHub</option></select></div><div class="sa-row" style="padding:15px;"><button class="sa-btn" onclick="startBackup()">ç«‹å³å¤‡ä»½</button></div><div class="sa-row" style="padding:15px;"><button class="sa-btn" style="background:#f0f0f0;color:#333" onclick="restoreBackup()">æ¢å¤å¤‡ä»½</button></div></div></div>`;
        }
        else if(page === 'about') {
            html = `<div style="padding:15px;"><h2>å…³äº</h2><div class="sa-group"><div class="sa-row"><div class="sa-label">ç‰ˆæœ¬</div><div class="sa-value">v15.8</div></div><div class="sa-row" style="padding:15px;"><button class="sa-btn" style="background:#ff4d4f" onclick="resetSettings()">é‡ç½®æ‰€æœ‰è®¾ç½®</button></div></div></div>`;
        }

        body.innerHTML = html;
        if(document.getElementById('settings-title')) document.getElementById('settings-title').innerText = page === 'theme' ? 'ä¸»é¢˜å¤–è§‚' : (page === 'api' ? 'APIé…ç½®' : 'ç³»ç»Ÿè®¾ç½®');
    }

    // 3. API åˆ‡æ¢é€»è¾‘ (OpenAI / Gemini / Claude)
    window.updateApiProvider = function(type, provider) {
        const settings = getAppSettings();
        settings.apis[type].provider = provider;
        if(provider === 'openai') {
            if(!settings.apis[type].endpoint || settings.apis[type].endpoint.includes('google') || settings.apis[type].endpoint.includes('anthropic')) {
                settings.apis[type].endpoint = 'https://api.openai.com/v1'; 
            }
            if(!settings.apis[type].availableModels || settings.apis[type].availableModels.length === 0) settings.apis[type].availableModels = ['gpt-3.5-turbo'];
        } else if(provider === 'gemini') {
            settings.apis[type].endpoint = 'https://generativelanguage.googleapis.com/v1';
            settings.apis[type].availableModels = ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-2.0-flash-exp'];
            settings.apis[type].model = 'gemini-1.5-flash';
        } else if(provider === 'claude') {
            settings.apis[type].endpoint = 'https://api.anthropic.com/v1';
            settings.apis[type].availableModels = ['claude-3-5-sonnet-20240620', 'claude-3-opus-20240229'];
            settings.apis[type].model = 'claude-3-5-sonnet-20240620';
        }
        saveAppSettings(settings);
        renderSettingsPage('api');
    }

    // 4. çœŸå®çš„æ‹‰å–æ¨¡å‹é€»è¾‘
    window.testApiConnection = async function(type) {
        const settings = getAppSettings();
        const api = settings.apis[type];
        const btn = event.target;
        const oldTxt = btn.innerText;
        if(!api.apiKey || !api.endpoint) { alert('è¯·å…ˆå¡«å†™åœ°å€å’ŒKey'); return; }
        btn.innerText = 'æ­£åœ¨è¿æ¥...'; btn.disabled = true;
        try {
            let baseUrl = api.endpoint;
            if(baseUrl.endsWith('/chat/completions')) baseUrl = baseUrl.replace('/chat/completions', '');
            if(baseUrl.endsWith('/')) baseUrl = baseUrl.slice(0, -1);
            if(api.provider === 'gemini' && baseUrl.includes('googleapis')) {
                 const url = `${baseUrl}/models?key=${api.apiKey}`;
                 const res = await fetch(url);
                 if(!res.ok) throw new Error('è¿æ¥å¤±è´¥');
                 alert('âœ… Gemini è¿æ¥æˆåŠŸï¼(å®˜æ–¹APIæš‚ä¸æ”¯æŒè‡ªåŠ¨æ‹‰å–åˆ—è¡¨)'); return;
            }
            const url = `${baseUrl}/models`;
            const res = await fetch(url, { method: 'GET', headers: { 'Authorization': `Bearer ${api.apiKey}` } });
            if(!res.ok) throw new Error('è¿æ¥å¤±è´¥: ' + res.status);
            const data = await res.json();
            let models = [];
            if(data.data && Array.isArray(data.data)) models = data.data.map(m => m.id);
            else if(Array.isArray(data)) models = data.map(m => m.id || m);
            if(models.length === 0) throw new Error('æœªæ‰¾åˆ°æ¨¡å‹æ•°æ®');
            settings.apis[type].availableModels = models.sort();
            if(!models.includes(settings.apis[type].model)) settings.apis[type].model = models[0];
            saveAppSettings(settings);
            alert(`âœ… æˆåŠŸæ‹‰å– ${models.length} ä¸ªæ¨¡å‹ï¼`);
            renderSettingsPage('api');
        } catch(e) { alert('âŒ æ‹‰å–å¤±è´¥: ' + e.message); } 
        finally { btn.innerText = oldTxt; btn.disabled = false; }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // ç¡®ä¿è®¾ç½®å­˜åœ¨
        if(!localStorage.getItem('app_settings')) {
            saveAppSettings(defaultAppSettings);
        }

        // åŠ è½½æ‰€æœ‰æ•°æ®
        load();

        console.log('Molly OS v15.4 - APIé›†æˆç‰ˆå·²åŠ è½½');

        // ä¿®å¤è§¦æ‘¸äº‹ä»¶é˜»æ­¢é»˜è®¤è¡Œä¸ºé—®é¢˜
        document.addEventListener('touchstart', function(e) {
            if(e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });

        document.addEventListener('touchmove', function(e) {
            if(e.scale !== 1) {
                e.preventDefault();
            }
        }, { passive: false });
    });

    </script>
<script>
(function() {
    console.log("ğŸš€ å¯åŠ¨ä¸Šä¼ ç»„ä»¶å¼ºåŠ›ä¿®å¤...");

    // 1. æ¸…ç†æ—§çš„æ®‹ç•™æ§ä»¶
    const oldContainer = document.getElementById('dynamic-upload-container');
    if(oldContainer) oldContainer.remove();
    
    // åŒæ—¶ä¹Ÿæ¸…ç†å¯èƒ½å­˜åœ¨çš„ç¡¬ç¼–ç  input
    document.querySelectorAll('input[type="file"][id^="f-"]').forEach(el => el.remove());

    // 2. åˆ›å»ºæ–°å®¹å™¨
    const container = document.createElement('div');
    container.id = 'dynamic-upload-container';
    container.style.display = 'none';
    document.body.appendChild(container);

    // 3. å®šä¹‰éœ€è¦ç”Ÿæˆçš„æ§ä»¶åˆ—è¡¨
    const inputs = [
        // å£çº¸
        'f-wall', 'f-lph', 'f-desktop1', 'f-desktop2',
        // å°ç»„ä»¶
        'f-avL', 'f-avR', 'f-pwall', 'f-p2bg', 'f-p2av', 'f-p2memo',
        // å¾®ä¿¡
        'f-wc-av', 'f-pf-av', 'f-chat-bg',
        // å›¾æ ‡
        'f-icon-weibo', 'f-icon-date', 'f-icon-music', 'f-icon-game',
        'f-icon-secret', 'f-icon-memory', 'f-icon-shop', 'f-icon-taobao',
        'f-icon-gogogo', 'f-icon-preset', 'f-icon-douyin', 'f-icon-calendar', 'f-icon-desire',
        'f-icon-wechat', 'f-icon-bottle', 'f-icon-worldbook', 'f-icon-settings'
    ];

    // 4. å¾ªç¯ç”Ÿæˆæ§ä»¶å¹¶ç»‘å®šäº‹ä»¶ (è¿™æ˜¯æœ€ç¨³çš„åŠæ³•)
    inputs.forEach(id => {
        const input = document.createElement('input');
        input.type = 'file';
        input.id = id;
        
        // ç»‘å®š Change äº‹ä»¶
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(evt) {
                const dataUrl = evt.target.result;
                
                // æ ¹æ® ID åˆ¤æ–­è°ƒç”¨å“ªä¸ªå¤„ç†å‡½æ•°
                if (id.startsWith('f-icon-')) {
                    // å¤„ç†å›¾æ ‡
                    const appId = id.replace('f-icon-', '');
                    handleIconUpload(appId, dataUrl);
                } else if (id === 'f-wc-av') {
                    // å¤„ç†å¾®ä¿¡å¤´åƒ (ç‰¹æ®Šé€»è¾‘)
                    if(window.wcHandleAv) window.wcHandleAv({files:[file]}); // æ¨¡æ‹Ÿ input å¯¹è±¡
                } else if (id === 'f-pf-av') {
                    // å¤„ç†èµ„æ–™é¡µå¤´åƒ
                    if(window.wcHandleProfileAv) window.wcHandleProfileAv({files:[file]});
                } else if (id === 'f-chat-bg') {
                    // å¤„ç†èŠå¤©èƒŒæ™¯
                    if(window.sHandleBg) window.sHandleBg({files:[file]});
                } else {
                    // å¤„ç†æ™®é€šç»„ä»¶/å£çº¸
                    const type = id.replace('f-', '');
                    handleGeneralUpload(type, dataUrl);
                }
            };
            reader.readAsDataURL(file);
        };
        
        container.appendChild(input);
    });

    // 5. å®šä¹‰/é‡å†™å¤„ç†å‡½æ•°
    function handleGeneralUpload(key, dataUrl) {
        // å­˜
        localStorage.setItem('u_' + key, dataUrl);
        // æ˜¾
        if(window.updateWallpaperPreview) {
            window.updateWallpaperPreview(key, dataUrl);
        }
        // å…œåº•åˆ·æ–°ï¼šå¦‚æœ updateWallpaperPreview æ²¡ååº”ï¼Œæ‰‹åŠ¨åˆ·ä¸€ä¸‹å¸¸è§å…ƒç´ 
        if(key === 'pwall') {
            const el = document.getElementById('i-p-wall');
            if(el) { el.style.backgroundImage = `url(${dataUrl})`; el.innerHTML=''; }
        }
        // æç¤º
        alert("âœ… ä¸Šä¼ æˆåŠŸï¼");
    }

    function handleIconUpload(appId, dataUrl) {
        localStorage.setItem('app_icon_' + appId, dataUrl);
        const icon = document.getElementById('i-' + appId);
        if(icon) {
            icon.style.backgroundImage = `url(${dataUrl})`;
            icon.classList.add('has-img');
            icon.innerHTML = '';
        }
        alert("âœ… å›¾æ ‡æ›´æ¢æˆåŠŸï¼");
    }

    // 6. é‡å†™ pick å‡½æ•°ï¼Œç¡®ä¿å®ƒèƒ½æ‰¾åˆ°æˆ‘ä»¬æ–°ç”Ÿæˆçš„ input
    window.pick = function(id) {
        const el = document.getElementById(id);
        if(el) {
            el.value = ''; // æ¸…ç©ºå€¼ï¼Œç¡®ä¿é‡å¤é€‰å›¾è§¦å‘
            el.click();
        } else {
            console.error("æœªæ‰¾åˆ°æ§ä»¶:", id);
            alert("âŒ é”™è¯¯ï¼šæ§ä»¶ç”Ÿæˆå¤±è´¥ " + id);
        }
    };

    console.log("âœ… ä¸Šä¼ ç»„ä»¶ä¿®å¤å®Œæ¯•ï¼Œå·²å°±ç»ªã€‚");
})();
</script>

     </body>
    </html>
